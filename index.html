<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee26 Cargo App</title>
    
   <style>
        /* --- Basic Setup & Fonts --- */
        :root {
            --blue: #007aff;
            --grey-light: #f0f0f5;
            --grey-mid: #e5e5ea;
            --grey-dark: #8a8a8e;
            --text-primary: #1c1c1e;
            --text-secondary: #636366;
            --bg-white: #ffffff;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --sidebar-width: 240px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--grey-light);
            color: var(--text-primary);
            margin: 0;
            display: flex; /* Enable flexbox for layout */
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-white);
            border-right: 1px solid var(--grey-mid);
            height: 100vh;
            position: fixed; /* Fixed position */
            top: 0;
            left: 0;
            padding: 1.5rem 0;
            box-sizing: border-box;
            z-index: 100;
        }

        .sidebar-header {
            display: flex; /* ADDED: Flex for logo alignment */
            align-items: center; /* ADDED: Center logo vertically */
            padding: 0 1.5rem 1.5rem 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--blue);
            border-bottom: 1px solid var(--grey-light);
        }
        
        /* NEW: Logo styles */
        .sidebar-logo {
            width: 30px; /* Adjust size as needed */
            height: auto;
            margin-right: 0.75rem; /* Space between logo and text */
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0 0;
        }

        .sidebar-nav li a {
            display: block;
            padding: 0.9rem 1.5rem;
            margin: 0.25rem 1rem;
            text-decoration: none;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar-nav li a:hover {
            background-color: var(--grey-light);
        }
        .sidebar-nav li a.active {
            background-color: var(--blue);
            color: var(--bg-white);
            font-weight: 600;
        }
        
        /* --- Main Content Area Styles --- */
        .main-content-area {
            margin-left: var(--sidebar-width); /* Offset by sidebar width */
            width: calc(100% - var(--sidebar-width));
            height: 100vh;
            overflow-y: auto; /* Allow this area to scroll */
            position: relative;
            padding-bottom: 80px; /* Space for footer */
            box-sizing: border-box;
        }
        
        .tab-content {
            display: none; /* Hide all tabs by default */
        }
        .tab-content.active {
            display: block; /* Show only the active tab */
        }
        
        /* --- Customer Database Styles --- */
        #tab-customer-database .container { 
            max-width: none; /* Make container full width */
            padding: 0 1.5rem; /* Add horizontal padding */
        }

        .table-container {
            width: 100%;
            /* overflow-x: auto; */ /* REMOVED: User requested no horizontal scroll */
        }
        
        /* UPDATED: Customer DB Table Styles */
        .table-google-sheets {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem; /* UPDATED: Smaller font size per request */
            border: 1px solid var(--grey-mid);
            /* table-layout: fixed; */ /* Let browser auto-layout first */
        }
        .table-google-sheets th,
        .table-google-sheets td {
            border: 1px solid var(--grey-mid);
            padding: 0.3rem 0.4rem; /* UPDATED: Tighter padding */
            text-align: left;
            vertical-align: middle;
            /* white-space: nowrap; */ /* REMOVED: Allow text wrapping */
            word-wrap: break-word; /* ADDED: Force long words to break */
        }
        .table-google-sheets th {
            background-color: #f9f9f9;
            font-weight: 700; /* UPDATED: Bolder heading per request */
            color: var(--text-secondary);
            position: sticky; /* Keep headers visible on scroll */
            top: 0;
            z-index: 1;
        }
        /* Row number column style */
        .table-google-sheets th:first-child,
        .table-google-sheets td:first-child {
            width: 30px; /* Fixed width for row number */
            text-align: center;
            color: var(--text-secondary);
        }
        .table-google-sheets tbody tr:nth-child(odd) {
            background-color: #fcfcfc;
        }
        .table-google-sheets tbody tr:hover {
            background-color: var(--grey-light);
        }
        .table-google-sheets td:last-child { /* Actions column */
            white-space: nowrap; /* Keep buttons together */
            text-align: center;
        }
        
        /* NEW: Styles for inputs/selects inside the table */
        .table-google-sheets input[type="text"],
        .table-google-sheets input[type="number"],
        .table-google-sheets select {
            width: 100%;
            box-sizing: border-box; /* Include padding/border in width */
            font-size: 0.7rem; /* Match table font */
            padding: 0.2rem;
            border: 1px solid var(--grey-mid);
            border-radius: 4px;
            font-family: var(--font-family);
        }
        .table-google-sheets input[type="number"] {
            -moz-appearance: textfield; /* Hide number spinners */
        }
        .table-google-sheets input::-webkit-outer-spin-button,
        .table-google-sheets input::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Hide number spinners */
            margin: 0;
        }
        .table-google-sheets input:focus,
        .table-google-sheets select:focus {
            border-color: var(--blue);
            outline: none;
            box-shadow: 0 0 0 1px var(--blue);
        }
        
        /* NEW: Color styles for status dropdowns */
        .table-google-sheets select.payment-status-paid {
            color: #28a745; /* Green */
            border-color: #28a745;
            font-weight: 600;
        }
        .table-google-sheets select.payment-status-not-paid {
            color: #c70000; /* Red */
            border-color: #c70000;
            font-weight: 600;
        }
        .table-google-sheets select.delivery-status-pending {
            color: #d46b08; /* Yellow/Orange */
            border-color: #ffe58f;
        }
        .table-google-sheets select.delivery-status-shipped {
            color: var(--blue); /* Blue */
            border-color: var(--blue);
        }
        .table-google-sheets select.delivery-status-delivered {
            color: #28a745; /* Green */
            border-color: #28a745;
        }
        /* END NEW DB TABLE STYLES */

        .btn-table {
            font-size: 0.7rem; /* Smaller button font */ 
            padding: 0.2rem 0.4rem; /* Smaller button padding */ 
            margin-right: 0.2rem;
            border-radius: 4px; /* Smaller radius */
        }
        /* END UPDATED Styles */
        
        .btn-edit {
            background-color: #fffbe6;
            color: #d46b08;
            border: 1px solid #ffe58f;
        }
        .btn-edit:hover { background-color: #fff1c2; }
        .btn-delete-db {
            background-color: #fff1f0;
            color: #c70000;
            border: 1px solid #ffccc7;
        }
        .btn-delete-db:hover { background-color: #ffe8e6; }

        .customer-submit-group {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--grey-light);
        }
        
        /* --- Header & Footer --- */
        header {
            background-color: var(--bg-white);
            padding: 1rem 1.5rem; 
            border-bottom: 1px solid var(--grey-mid);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin: 0; 
        }

        footer {
            width: 100%;
            background-color: #f8f8f8;
            border-top: 1px solid var(--grey-mid);
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            box-sizing: border-box;
            margin-top: 2rem;
        }

        /* --- Main Layout & Cards --- */
        .container {
            max-width: 900px;
            margin: 2rem auto 0 auto; 
            padding: 0 1.5rem; 
            display: grid;
            gap: 1.5rem;
        }

        .card {
            background-color: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-top: 0;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--grey-light);
            display: flex;
            align-items: center;
        }

        .card h2 .icon {
            margin-right: 0.75rem;
            font-size: 1.5rem;
        }

        .card h3 {
            font-size: 1.1rem;
            color: var(--blue);
            margin-top: 0;
        }

        .output-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--grey-light);
        }
        .output-section:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* --- Forms & Grids --- */
        .form-grid, .form-grid-half {
            display: grid;
            gap: 1rem;
        }
        
        /* Form grid for main customer details */
        .form-grid {
            grid-template-columns: 1fr 1fr;
        }
        .form-grid-half {
            grid-template-columns: 1fr 1fr;
            max-width: 500px;
        }
        .form-grid .full-width,
        .item-form-grid .full-width { /* UPDATED */
            grid-column: 1 / -1;
        }

        /* Form grid for adding items (UPDATED) */
        .item-form-grid {
            grid-template-columns: 1fr 1fr; /* UPDATED: 2-column layout */
            gap: 1rem; /* UPDATED: Consistent gap */
            align-items: flex-end;
            margin-top: 1rem;
            border-top: 1px solid var(--grey-light);
            padding-top: 1.5rem;
        }
        .item-form-grid .button-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .item-form-grid .btn-add {
            width: auto;
            flex-grow: 1; /* Make Add/Update button fill space */
        }
        .item-form-grid #cancelEditBtn {
            width: auto;
        }


        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .input-group input[type="text"],
        .input-group input[type="tel"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group input[type="file"],
        .input-group textarea,
        .input-group select { 
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            box-sizing: border-box; 
            background-color: #fdfdfd;
            font-family: var(--font-family); 
        }
        .input-group input[type="file"] {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        
        .input-group input[disabled] { 
            background-color: var(--grey-light);
            color: var(--text-secondary);
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus { 
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 2px rgba(0,122,255,0.2);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            font-size: 1rem;
        }
        .info-grid strong {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .info-grid div {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--grey-light);
        }
        .info-grid div:last-child,
        .info-grid strong:last-child {
             border-bottom: none;
        }
        
        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        /* --- Buttons --- */
        .btn {
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--blue);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn:hover {
            background-color: #0056b3;
        }

        .btn-add {
            width: 100%;
        }

        .btn-secondary {
            background-color: var(--grey-mid);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: var(--grey-dark);
            color: var(--bg-white);
        }
        
        .btn-print {
            background-color: var(--grey-mid);
            color: var(--text-primary);
        }
        .btn-print:hover {
            background-color: var(--grey-dark);
            color: var(--bg-white);
        }

        /* NEW: Toggle Button Styles */
        .btn-toggle {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--grey-light);
            color: var(--text-secondary);
            text-align: center;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            width: 100%; /* Make it full width of its grid cell */
            box-sizing: border-box; /* Include padding in width */
        }
        .btn-toggle.used {
            background-color: var(--blue);
            color: var(--bg-white);
            border-color: var(--blue);
        }
        /* End Toggle Button Styles */

        .btn-edit-item {
            background: none;
            border: none;
            color: var(--blue);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 0.25rem;
        }
        .btn-edit-item:hover {
            color: #0056b3;
        }

        .btn-delete {
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        .btn-delete:hover {
            color: #c70000;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .history-buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: -0.5rem; /* Pull cards up slightly */
        }
        
        .btn-history {
            font-family: var(--font-family);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--bg-white);
            color: var(--blue);
            transition: background-color 0.2s ease;
        }
        .btn-history:hover:not(:disabled) {
            background-color: var(--grey-light);
        }
        .btn-history:disabled {
            color: var(--grey-dark);
            cursor: not-allowed;
            background-color: #f9f9f9;
            border-color: var(--grey-light);
        }

        /* --- Item Table --- */
        #itemTable {
            width: 100%;
            border-collapse: collapse; 
            margin-bottom: 1rem;
            border: 1px solid var(--grey-mid); 
        }
        #itemTable th, #itemTable td {
            text-align: left;
            padding: 0.75rem;
            border: 1px solid var(--grey-mid); 
            font-size: 0.9rem;
            vertical-align: middle;
        }
        #itemTable th {
            color: var(--text-secondary);
            font-weight: 600;
            background-color: #f9f9f9;
        }
        
        /* Item Table Column widths (UPDATED for 7 columns) */
        #itemTable th:nth-child(1), #itemTable td:nth-child(1) { width: 30%; } /* Description */
        #itemTable th:nth-child(2), #itemTable td:nth-child(2) { width: 20%; } /* Category */
        #itemTable th:nth-child(3), #itemTable td:nth-child(3) { width: 8%; }  /* Qty */
        #itemTable th:nth-child(4), #itemTable td:nth-child(4) { width: 12%; } /* Unit Val */
        #itemTable th:nth-child(5), #itemTable td:nth-child(5) { width: 12%; } /* Total Val */
        #itemTable th:nth-child(6), #itemTable td:nth-child(6) { width: 18%; } /* Remarks */
        #itemTable th:nth-child(7), #itemTable td:nth-child(7) { width: 10%; text-align: center; } /* Actions */


        /* --- Summary Section --- */
        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.75rem 1rem;
            align-items: center;
            max-width: 500px;
        }
        .summary-grid strong {
            color: var(--text-secondary);
            text-align: right;
        }
        .summary-total {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .summary-input {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            width: 100px;
        }

        /* --- Mobile-First Responsive --- */
        @media (max-width: 1024px) { 
             :root {
                --sidebar-width: 100%;
            }
            body {
                flex-direction: column; /* Stack sidebar and content */
                font-size: 14px; /* Smaller base font for mobile */
            }
            .sidebar {
                height: auto;
                position: relative; /* Change from fixed to relative */
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--grey-mid);
                z-index: 1; /* Ensure it doesn't overlap content weirdly */
            }
            .sidebar-nav {
                display: flex;
                justify-content: space-around; /* Spread out links */
                margin-top: 0;
            }
            .sidebar-nav li a {
                margin: 0.1rem; /* Tighter margin */
                padding: 0.4rem 0.5rem; /* Smaller padding */
                text-align: center;
                font-size: 0.8rem; /* Smaller nav font */
            }
            .sidebar-header {
                text-align: center;
                border-bottom: none;
                padding-bottom: 0.5rem; /* Reduced padding */
                font-size: 1.1rem; /* Smaller header font */
            }

            .main-content-area {
                margin-left: 0; /* Remove margin */
                width: 100%;
                height: auto;
                overflow-y: visible;
            }

            header { padding: 0.75rem 1rem; } /* Reduced header padding */
            header h1 { font-size: 1.1rem; } /* Smaller main title */
            .container { padding: 0 0.75rem; } /* Tighter container padding */
            #tab-customer-database .container { padding: 0 0.75rem; } 

            .card {
                padding: 1rem; /* Reduced card padding */
            }
            .card h2 { font-size: 1rem; }
            .card h3 { font-size: 0.9rem; }

            .form-grid, .form-grid-half {
                grid-template-columns: 1fr;
            }
            .item-form-grid {
                grid-template-columns: 1fr; /* Stack add-item form */
            }
            .item-form-grid .button-container {
                flex-direction: column;
            }
            .btn-add, #cancelEditBtn {
                width: 100% !important;
                flex-grow: 0 !important;
            }
            
            /* Smaller forms */
            .input-group label {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }
            .input-group input[type="text"],
            .input-group input[type="tel"],
            .input-group input[type="number"],
            .input-group input[type="date"],
            .input-group input[type="file"],
            .input-group textarea,
            .input-group select,
            .btn-toggle { /* UPDATED */
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .summary-input {
                padding: 0.4rem;
                font-size: 0.9rem;
            }

            /* Tighter, smaller tables */
            #itemTable {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            #itemTable th, #itemTable td {
                min-width: 80px; /* Adjust min width */
                font-size: 0.8rem; /* Smaller table font */
                padding: 0.5rem; /* Smaller padding */
            }
            #itemTable th:first-child, #itemTable td:first-child {
                min-width: 150px; /* Give description more space */
            }
            
            /* UPDATED: Mobile Customer DB Table Styles */
            /* Force horizontal scroll on mobile since table has too many columns to fit */
            .table-container {
                overflow-x: auto;
            }
            .table-google-sheets {
                font-size: 0.7rem; /* Even smaller font */
            }
            .table-google-sheets th,
            .table-google-sheets td {
                padding: 0.3rem 0.4rem; /* Even tighter padding */
                min-width: 60px; /* Smaller min width */
                white-space: nowrap; /* Force nowrap on mobile to work with scroll */
            }
            .btn-table {
                font-size: 0.65rem; /* Smaller button font */
                padding: 0.1rem 0.3rem; /* Smaller button padding */
            }
            /* END UPDATED Mobile Styles */

            .info-grid {
                grid-template-columns: 80px 1fr; /* Smaller label column */
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="https://raw.githubusercontent.com/crickerr26/bee26cargomanager/main/BEE26.jpg" alt="Bee26 Cargo Logo" class="sidebar-logo">
            Bee26 Cargo
        </div>
        <ul class="sidebar-nav">
            <li><a href="#" class="sidebar-link active" data-tab="tab-customer-details">Customer Details</a></li>
            <li><a href="#" class="sidebar-link" data-tab="tab-customer-database">Customer Database</a></li>
            <li><a href="#" class="sidebar-link" data-tab="tab-shipment-tracker">Shipment Tracker</a></li>
            <li><a href="#" class="sidebar-link" data-tab="tab-payment-tracker">Payment Tracker</a></li>
        </ul>
    </nav>

    <div class="main-content-area">

        <header>
            <h1>Personal Cargo Manager</h1>
            </header>

        <div class="tab-container">

            <div id="tab-customer-details" class="tab-content active">
                
                <main class="container">
                    <div class="history-buttons">
                        <button id="undoBtn" class="btn-history" disabled>Undo</button>
                        <button id="redoBtn" class="btn-history" disabled>Redo</button>
                    </div>

                    <section class="card">
                        <h2><span class="icon">👤</span> Customer Details</h2>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="senderName">Sender Name</label>
                                <input type="text" id="senderName" placeholder="John Doe">
                            </div>
                            <div class="input-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Jane Smith">
                            </div>
                            <div class="input-group">
                                <label for="senderPhone">Sender Phone (Canada)</label>
                                <input type="tel" id="senderPhone" placeholder="+1 416 123 4567">
                            </div>
                            <div class="input-group">
                                <label for="receiverPhone">Receiver Phone (Sri Lanka)</label>
                                <input type="tel" id="receiverPhone" placeholder="+94 77 123 4567">
                            </div>
                            <div class="input-group full-width">
                                <label for="receiverAddress">Receiver Address (Sri Lanka)</label>
                                <textarea id="receiverAddress" rows="3" placeholder="No. 123, Main Street, Colombo 03"></textarea>
                            </div>
                            <div class="input-group full-width">
                                <label for="fileUpload">Attach ID (NIC, Passport) - Optional</label>
                                <input type="file" id="fileUpload" accept="image/*,.pdf">
                            </div>
                            <div class="input-group full-width">
                                <label for="customerRemarks">Customer Remarks</label>
                                <textarea id="customerRemarks" rows="2" placeholder="Notes about this customer..."></textarea>
                            </div>
                        </div>
                        
                        </section>
            
                    <section class="card">
                        <h2><span class="icon">🛍️</span> Itemized List</h2>
                        <table id="itemTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Qty</th>
                                    <th>Unit Val. (CAD)</th>
                                    <th>Total Val.</th>
                                    <th>Remarks</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="itemTbody">
                                </tbody>
                        </table>
                        
                        <form id="addItemForm" class="item-form-grid">
                            <div class="input-group full-width">
                                <label>Description</label>
                                <input type="text" id="itemDesc" placeholder="e.g., Men's T-Shirts" required>
                            </div>
                            
                            <div class="input-group">
                                <label>Brand</label>
                                <input type="text" id="itemBrand" list="brandList" placeholder="e.g., Nike, Sony (optional)">
                                <datalist id="brandList">
                                    </datalist>
                            </div>

                            <div class="input-group">
                                <label>Category</label>
                                <select id="itemCategory" required>
                                    <option value="">Select category...</option>
                                    <option value="Packaged Food">Packaged Food</option>
                                    <option value="Perishable Food">Perishable Food</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Footwear & Clothing">Footwear & Clothing</option>
                                    <option value="Sports Equipment">Sports Equipment</option>
                                    <option value="Household & Personal Items">Household & Personal Items</option>
                                    <option value="Health & Beauty Products">Health & Beauty Products</option>
                                    <option value="Kids Items & Toys">Kids Items & Toys</option>
                                    <option value="Books & Stationery">Books & Stationery</option>
                                    <option value="Documents">Documents</option>
                                    <option value="Used Items">Used Items</option>
                                    <option value="New Items">New Items</option>
                                    <option value="Gifts / Souvenirs">Gifts / Souvenirs</option>
                                    <option value="Liquids">Liquids</option>
                                    <option value="Batteries / Power Banks">Batteries / Power Banks</option>
                                    <option value="Fragile Items">Fragile Items</option>
                                    <option value="Medicines / Vitamins">Medicines / Vitamins</option>
                                    <option value="Restricted / Special Handling">Restricted / Special Handling</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label>Condition</label>
                                <button type="button" id="itemConditionBtn" class="btn-toggle">New</button>
                            </div>

                            <div class="input-group">
                                <label>Quantity</label>
                                <input type="number" id="itemQty" placeholder="10" min="1" step="1" required>
                            </div>
                            <div class="input-group">
                                <label>Unit Value (CAD)</label>
                                <input type="number" id="itemValue" placeholder="15.00" min="0" step="0.01" required>
                            </div>
                            <div class="input-group">
                                <label>Remarks</label>
                                <input type="text" id="itemRemarks" placeholder="Color, size, etc.">
                            </div>

                            <div class="button-container full-width">
                                <button type="submit" class="btn btn-add" id="addItemSubmitBtn">Add Item +</button>
                                <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
                            </div>
                        </form>
                    </section>
            
                    <section class="card">
                        <h2><span class="icon">📊</span> Shipment Summary & Outputs</h2>
                        
                        <div class="output-section">
                            <h3>AWB Prep Info</h3>
                            <div class="summary-grid">
                                <div><strong>From:</strong></div>
                                <div>Bee26 Cargo Services, Toronto</div>
                                
                                <div><strong>To:</strong></div>
                                <div id="summaryReceiver">--</div>
            
                                <div><strong>Total Packages:</strong></div>
                                <input type="number" id="totalPackages" class="summary-input" placeholder="e.g., 2">
                                
                                <div><strong>Total Weight (kg):</strong></div>
                                <input type="text" id="summaryWeightInput" class="summary-input" placeholder="0.00"> 
                                
                                <div><strong>Declared Value (CAD):</strong></div>
                                <input type="text" id="summaryValueInput" class="summary-input" placeholder="0.00">
                            </div>
                        </div>
            
                        <div class="output-section">
                            <h3>Packing List</h3>
                            <p><strong>Declaration:</strong> Personal Use – Not for Resale</p>
                            <div class="button-group">
                                <button id="printPackingListBtn" class="btn btn-print">Print</button>
                                <button id="exportPackingListPDF" class="btn">Download PDF</button>
                                <button id="exportPackingListExcel" class="btn btn-secondary">Download Excel</button>
                            </div>
                        </div>
            
                        <div class="output-section">
                            <h3>Commercial Invoice</h3>
                            <div class="form-grid-half">
                                <div class="input-group">
                                    <label for="invoiceNumber">Invoice Number</label>
                                    <input type="text" id="invoiceNumber" placeholder="BEE26-1001">
                                </div>
                                <div class="input-group">
                                    <label for="invoiceDate">Date</label>
                                    <input type="date" id="invoiceDate">
                                </div>
                                <div class="input-group">
                                    <label for="hsCode">HS Code (Optional)</label>
                                    <input type="text" id="hsCode" placeholder="e.g., 6109.10">
                                </div>
                            </div>
                            <div class="button-group">
                                <button id="printInvoiceBtn" class="btn btn-print">Print</button>
                                <button id="exportInvoicePDF" class="btn">Download PDF</button>
                                <button id="exportInvoiceExcel" class="btn btn-secondary">Download Excel</button>
                            </div>
                        </div>
            
                    </section>

                    <div class="customer-submit-group">
                        <button id="submitCustomerBtn" class="btn">Submit Customer to Database</button>
                    </div>

                </main>
                </div>

            <div id="tab-customer-database" class="tab-content">
                <main class="container"> 
                    <section class="card">
                        <h2><span class="icon">📂</span> Customer Database</h2>
                        <div class="input-group search-bar">
                            <label for="customerSearch">Search by Sender or Receiver Name</label>
                            <input type="text" id="customerSearch" placeholder="Search...">
                        </div>
                    </section>

                    <section class="card">
                        <div class="table-container">
                            <table id="customerTable" class="table-google-sheets">
                                <thead>
                                    <tr>
                                        <th>#</th> 
                                        <th>Sender Name</th>
                                        <th>Sender Phone</th> <th>Receiver Name</th>
                                        <th>Receiver Phone</th>
                                        <th>Receiver Address</th>
                                        <th>Payment Status</th> <th>Amount</th> <th>Delivery Status</th> <th>Tracking #</th> <th>Remarks</th> <th>Date Added</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customerTableTbody">
                                    <tr><td colspan="13">Loading customers from Firebase...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </main>
            </div>
            
            <div id="tab-shipment-tracker" class="tab-content">
                <main class="container">
                    <section class="card">
                        <h2><span class="icon">✈️</span> Shipment Tracker</h2>
                        <div class="input-group search-bar">
                            <label for="shipmentSearch">Search by Customer Name or Invoice #</label>
                            <input type="text" id="shipmentSearch" placeholder="Search...">
                        </div>
                    </section>
                    
                    <section class="card">
                        <h3>Customer Info</h3>
                        <div class="info-grid">
                            <strong>Sender:</strong> <div id="stSenderName">--</div>
                            <strong>Receiver:</strong> <div id="stReceiverName">--</div>
                            <strong>Phone:</strong> <div id="stReceiverPhone">--</div>
                            <strong>Address:</strong> <div id="stReceiverAddress">--</div>
                        </div>
                    </section>

                    <section class="card">
                        <h3>Flight Details</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="flightAirline">Airline</label>
                                <input type="text" id="flightAirline" placeholder="e.g., Air Canada">
                            </div>
                            <div class="input-group">
                                <label for="flightNumber">Flight Number / Tracking #</label> <input type="text" id="flightNumber" placeholder="e.g., AC123 / 1Z999..."> </div>
                            <div class="input-group">
                                <label for="flightEtd">ETD (Est. Time of Departure)</label>
                                <input type="datetime-local" id="flightEtd">
                            </div>
                            <div class="input-group">
                                <label for="flightEta">ETA (Est. Time of Arrival)</label>
                                <input type="datetime-local" id="flightEta">
                            </div>
                             <div class="input-group">
                                <label for="deliveryStatus">Delivery Status</label>
                                <select id="deliveryStatus">
                                    <option value="">Select Status</option>
                                    <option value="Pending">Pending Pickup</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="In Transit">In Transit</option>
                                    <option value="Out for Delivery">Out for Delivery</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Exception">Exception</option>
                                </select>
                            </div>
                            <div class="input-group full-width">
                                <label for="flightNotes">Tracking Notes</label>
                                <textarea id="flightNotes" rows="3" placeholder="e.g., Arrived in CMB, pending customs..."></textarea>
                            </div>
                        </div>
                    </section>

                </main>
            </div>
            <div id="tab-payment-tracker" class="tab-content">
                <main class="container">
                    <section class="card">
                        <h2><span class="icon">💳</span> Payment Tracker</h2>
                         <div class="input-group search-bar">
                            <label for="paymentSearch">Search by Customer Name or Invoice #</label>
                            <input type="text" id="paymentSearch" placeholder="Search...">
                        </div>
                    </section>

                    <section class="card">
                        <h3>Payment Details</h3>
                        <div class="form-grid">
                             <div class="input-group">
                                <label for="paymentInvoice">Invoice Number</label>
                                <input type="text" id="paymentInvoice" placeholder="BEE26-1001" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentDate">Date</label>
                                <input type="date" id="paymentDate" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentCustomer">Customer Name</label>
                                <input type="text" id="paymentCustomer" placeholder="John Doe" disabled>
                            </div>
                            <div class="input-group">
                                <label for="paymentTotal">Total Amount (CAD)</label>
                                <input type="number" id="paymentTotal" placeholder="0.00" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentPaid">Amount Paid (CAD)</label>
                                <input type="number" id="paymentPaid" placeholder="0.00" min="0" step="0.01">
                            </div>
                             <div class="input-group">
                                <label for="paymentBalance">Balance (CAD)</label>
                                <input type="number" id="paymentBalance" placeholder="0.00" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentMethod">Payment Method</label>
                                <select id="paymentMethod">
                                    <option value="">Select Method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="E-Transfer">E-Transfer</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Bank Deposit">Bank Deposit</option>
                                </select>
                            </div>
                             <div class="input-group">
                                <label for="paymentStatus">Payment Status</label>
                                <select id="paymentStatus">
                                    <option value="Not Paid">Not Paid</option>
                                    <option value="Partially Paid">Partially Paid</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Refunded">Refunded</option>
                                </select>
                             </div>
                            <div class="input-group full-width">
                                <label for="paymentNotes">Payment Notes</label>
                                <textarea id="paymentNotes" rows="3" placeholder="e.g., Paid $100 cash on Oct 27..."></textarea>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
            </div>
        <footer>
            <p>Bee26 Cargo Services • Toronto • +1 416-474-4994</p>
        </footer>

    </div> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js"; // Optional: Keep if you use Analytics
      import { getDatabase, ref, set, get, child, push, remove, update, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js"; // <-- Add Database import

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDwTq2Nv5LFDHwXJheJpFl9Elzki_kLIYc", // Replace with your actual API key
        authDomain: "bee26cargo.firebaseapp.com",
        databaseURL: "https://bee26cargo-default-rtdb.firebaseio.com",
        projectId: "bee26cargo",
        storageBucket: "bee26cargo.firebasestorage.app",
        messagingSenderId: "993500227965",
        appId: "1:993500227965:web:ab01dad6925bda54890414",
        measurementId: "G-M1L7S06496" // Optional
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // const analytics = getAnalytics(app); // Optional
      const database = getDatabase(app); // <-- Get Database reference

      // Make database functions globally accessible (needed by the next module)
      window.firebaseDB = database;
      window.firebaseDBRef = ref; 
      window.firebaseDBSet = set; 
      window.firebaseDBGet = get; 
      window.firebaseDBChild = child; 
      window.firebaseDBPush = push; 
      window.firebaseDBRemove = remove; 
      window.firebaseDBUpdate = update; 
      window.firebaseDBOnValue = onValue; 

    </script>

    <script type="module"> 
        
        // Ensure DOM is ready before accessing elements or Firebase functions
        // The DOMContentLoaded listener is crucial here
        document.addEventListener('DOMContentLoaded', () => {

            // Access Firebase Database Functions made global in the previous script
            // Ensure these are accessed *inside* DOMContentLoaded
            const db = window.firebaseDB;
            const dbRef = window.firebaseDBRef;
            const dbSet = window.firebaseDBSet;
            const dbGet = window.firebaseDBGet;
            const dbChild = window.firebaseDBChild;
            const dbPush = window.firebaseDBPush;
            const dbRemove = window.firebaseDBRemove;
            const dbUpdate = window.firebaseDBUpdate;
            const dbOnValue = window.firebaseDBOnValue;
            
            // Defensive check if Firebase failed to initialize
            if (!db) {
                console.error("Firebase Database reference (db) is not available!");
                alert("Error: Cannot connect to the database. Please check Firebase setup.");
                return; // Stop script execution if DB isn't ready
            }


            // --- 1. Get all the important HTML elements ---
            
            // -- Tab 1 (Customer Details) --
            const senderNameEl = document.getElementById('senderName');
            const receiverNameEl = document.getElementById('receiverName');
            const senderPhoneEl = document.getElementById('senderPhone'); // NEW
            const receiverPhoneEl = document.getElementById('receiverPhone');
            const receiverAddressEl = document.getElementById('receiverAddress');
            const customerRemarksEl = document.getElementById('customerRemarks'); // NEW
            const totalPackagesEl = document.getElementById('totalPackages');
            const invoiceNumberEl = document.getElementById('invoiceNumber');
            const invoiceDateEl = document.getElementById('invoiceDate');
            const hsCodeEl = document.getElementById('hsCode');
            const submitCustomerBtn = document.getElementById('submitCustomerBtn'); 

            const addItemForm = document.getElementById('addItemForm');
            const itemTbody = document.getElementById('itemTbody');
            const addItemSubmitBtn = document.getElementById('addItemSubmitBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            
            // UPDATED: Get new item form elements
            const itemDescEl = document.getElementById('itemDesc');
            const itemBrandEl = document.getElementById('itemBrand');
            const itemCategoryEl = document.getElementById('itemCategory');
            const itemConditionBtn = document.getElementById('itemConditionBtn');
            const itemRemarksEl = document.getElementById('itemRemarks');
            
            const summaryReceiver = document.getElementById('summaryReceiver');
            const summaryWeightInput = document.getElementById('summaryWeightInput');
            const summaryValueInput = document.getElementById('summaryValueInput');

            const exportPackingListPDF = document.getElementById('exportPackingListPDF');
            const exportPackingListExcel = document.getElementById('exportPackingListExcel');
            const exportInvoicePDF = document.getElementById('exportInvoicePDF');
            const exportInvoiceExcel = document.getElementById('exportInvoiceExcel');
            
            const printPackingListBtn = document.getElementById('printPackingListBtn');
            const printInvoiceBtn = document.getElementById('printInvoiceBtn');


            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            // -- Tab 2 (Customer Database) --
            const customerSearchEl = document.getElementById('customerSearch');
            const customerTableTbody = document.getElementById('customerTableTbody');

            // -- Tab 3 (Shipment Tracker) --
            const stSenderName = document.getElementById('stSenderName');
            const stReceiverName = document.getElementById('stReceiverName');
            const stReceiverPhone = document.getElementById('stReceiverPhone');
            const stReceiverAddress = document.getElementById('stReceiverAddress');
            const flightAirlineEl = document.getElementById('flightAirline');
            const flightNumberEl = document.getElementById('flightNumber');
            const flightEtdEl = document.getElementById('flightEtd');
            const flightEtaEl = document.getElementById('flightEta');
            const deliveryStatusEl = document.getElementById('deliveryStatus'); // NEW
            const flightNotesEl = document.getElementById('flightNotes');

            // -- Tab 4 (Payment Tracker) --
            const paymentInvoiceEl = document.getElementById('paymentInvoice');
            const paymentDateEl = document.getElementById('paymentDate');
            const paymentCustomerEl = document.getElementById('paymentCustomer');
            const paymentTotalEl = document.getElementById('paymentTotal');
            const paymentPaidEl = document.getElementById('paymentPaid');
            const paymentBalanceEl = document.getElementById('paymentBalance');
            const paymentMethodEl = document.getElementById('paymentMethod');
            const paymentStatusEl = document.getElementById('paymentStatus'); // NEW
            const paymentNotesEl = document.getElementById('paymentNotes');

            // -- Tab Navigation --
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const tabContents = document.querySelectorAll('.tab-content');

            // --- 2. State Variables ---
            let items = [];
            let historyStack = [];
            let redoStack = [];
            
            let customerDatabase = []; // This will be filled by Firebase
            let knownBrands = new Set(); // NEW: For brand auto-suggest
            
            let currentEditCustomerId = null;
            let currentEditItemIndex = null;
            let isAutoSaving = false; // Flag to prevent auto-save loops
            let isDataLoaded = false; // Flag to prevent auto-save on initial load


            // --- 3. Core Functions ---

            /**
             * Redraws the item table based on the 'items' array
             */
            function renderTable() {
                itemTbody.innerHTML = ''; // Clear the table first
                let totalWeight = 0;
                let totalValue = 0;
                let totalQty = 0;

                // Ensure items is an array before iterating
                if (!Array.isArray(items)) {
                    items = []; 
                    console.warn("'items' was not an array, reset to empty array.");
                }

                items.forEach((item, index) => {
                    // Provide default values if item properties are missing/invalid
                    const qty = parseFloat(item.qty) || 0;
                    const weight = parseFloat(item.weight) || 0; // Still need this for summary calculation
                    const value = parseFloat(item.value) || 0;
                    const desc = item.desc || '';
                    const category = item.category || 'N/A';
                    const remarks = item.remarks || '';
                    // const brand = item.brand || ''; // Brand is not shown in table, but saved in item obj

                    const itemTotalWeight = qty * weight; // Still need this for summary calculation
                    const itemTotalValue = qty * value;
                    
                    totalWeight += itemTotalWeight;
                    totalValue += itemTotalValue;
                    totalQty += qty;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${desc}</td>
                        <td>${category}</td>
                        <td>${qty}</td>
                        <td>${value.toFixed(2)}</td>
                        <td>${itemTotalValue.toFixed(2)}</td>
                        <td>${remarks}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn-edit-item" data-index="${index}">✏️</button>
                            <button class="btn-delete" data-index="${index}">🗑️</button>
                        </td>
                    `;
                    itemTbody.appendChild(row);
                });

                updateSummary(totalQty, totalWeight, totalValue);
            }
            
            
            // --- Customer Database Functions ---
            
            /**
             * NEW: Helper function to apply color classes to table dropdowns
             */
            function updateSelectColor(selectElement) {
                if (!selectElement) return;
                const value = selectElement.value;
                // Clear existing status classes
                selectElement.classList.remove(
                    'payment-status-paid', 'payment-status-not-paid',
                    'delivery-status-pending', 'delivery-status-shipped', 'delivery-status-delivered'
                );

                if (selectElement.name === 'paymentStatus') {
                    if (value === 'Paid') {
                        selectElement.classList.add('payment-status-paid');
                    } else if (value === 'Not Paid') {
                        selectElement.classList.add('payment-status-not-paid');
                    }
                } else if (selectElement.name === 'deliveryStatus') {
                    if (value === 'Pending') {
                        selectElement.classList.add('delivery-status-pending');
                    } else if (value === 'Shipped') {
                        selectElement.classList.add('delivery-status-shipped');
                    } else if (value === 'Delivered') {
                        selectElement.classList.add('delivery-status-delivered');
                    }
                }
            }


            /**
             * Renders the customer database table, with optional filter
             * UPDATED: Now renders editable inputs and dropdowns
             */
            function renderCustomerDatabaseTable(filter = '') {
                customerTableTbody.innerHTML = '';
                const searchTerm = filter.toLowerCase();
                
                // Ensure customerDatabase is an array
                if (!Array.isArray(customerDatabase)) {
                    customerDatabase = [];
                    console.warn("'customerDatabase' was not an array, reset to empty array.");
                }
                
                const filteredDB = customerDatabase.filter(customer => {
                    if (!customer) return false; // Skip null/undefined entries
                    const senderMatch = customer.senderName && customer.senderName.toLowerCase().includes(searchTerm);
                    const receiverMatch = customer.receiverName && customer.receiverName.toLowerCase().includes(searchTerm);
                    return senderMatch || receiverMatch;
                });

                if (filteredDB.length === 0) {
                     // UPDATED colspan
                     customerTableTbody.innerHTML = `<tr><td colspan="13">No customers found${filter ? ' matching your search' : ''}.</td></tr>`;
                     return;
                }

                filteredDB.forEach((customer, index) => { 
                    const row = document.createElement('tr');
                    // Format the dateAdded field
                    let timestamp = 'N/A';
                    if (customer.dateAdded) {
                        try {
                            timestamp = new Date(customer.dateAdded).toLocaleDateString();
                        } catch (e) { /* ignore invalid date */ }
                    }
                    
                    // Set defaults for fields
                    const paymentStatus = customer.paymentStatus || 'Not Paid';
                    const amount = customer.amount || '';
                    const deliveryStatus = customer.deliveryStatus || 'Pending';
                    const trackingNumber = customer.trackingNumber || '';
                    const customerRemarks = customer.customerRemarks || '';
                    
                    // UPDATED: Build row with editable inputs and selects
                    row.innerHTML = `
                        <td>${index + 1}</td> 
                        <td>${customer.senderName || ''}</td>
                        <td>${customer.senderPhone || ''}</td>
                        <td>${customer.receiverName || ''}</td>
                        <td>${customer.receiverPhone || ''}</td>
                        <td>${customer.receiverAddress || ''}</td>
                        <td>
                            <select name="paymentStatus" class="db-field-update" data-id="${customer.id}">
                                <option value="Not Paid" ${paymentStatus === 'Not Paid' ? 'selected' : ''}>Not Paid</option>
                                <option value="Paid" ${paymentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" name="amount" class="db-field-update" data-id="${customer.id}" value="${amount}" placeholder="0.00" step="0.01">
                        </td>
                        <td>
                             <select name="deliveryStatus" class="db-field-update" data-id="${customer.id}">
                                <option value="Pending" ${deliveryStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Shipped" ${deliveryStatus === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="Delivered" ${deliveryStatus === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" name="trackingNumber" class="db-field-update" data-id="${customer.id}" value="${trackingNumber}" placeholder="Tracking...">
                        </td>
                        <td>
                            <input type="text" name="customerRemarks" class="db-field-update" data-id="${customer.id}" value="${customerRemarks}" placeholder="Remarks...">
                        </td>
                        <td>${timestamp}</td>
                        <td>
                            <button class="btn-table btn-edit" data-id="${customer.id}">✏️ Edit</button>
                            <button class="btn-table btn-delete-db" data-id="${customer.id}">🗑️ Delete</button>
                        </td>
                    `;
                    customerTableTbody.appendChild(row);
                });
                
                // NEW: After populating, go back and apply colors to all selects
                customerTableTbody.querySelectorAll('select.db-field-update').forEach(select => {
                    updateSelectColor(select);
                });
            }
            
            /**
             * Clears the main customer input form (UPDATED to clear everything)
             */
            function clearCustomerForm() {
                console.log("Clearing entire form...");
                // Clear Customer Details
                senderNameEl.value = '';
                receiverNameEl.value = '';
                senderPhoneEl.value = ''; // NEW
                receiverPhoneEl.value = '';
                receiverAddressEl.value = '';
                customerRemarksEl.value = ''; // NEW
                const fileInput = document.getElementById('fileUpload');
                fileInput.value = ''; 
                if (fileInput.value) { 
                    try {
                        fileInput.type = 'text';
                        fileInput.type = 'file';
                    } catch(e) {}
                }
                
                // Clear Item List and Form
                items = []; // Clear items array
                renderTable(); // Update table display
                clearEditState(); // Reset item form

                // Clear Summary & Outputs
                invoiceNumberEl.value = '';
                invoiceDateEl.valueAsDate = new Date(); // Reset date to today
                hsCodeEl.value = '';
                totalPackagesEl.value = '';
                summaryWeightInput.value = '';
                summaryValueInput.value = '';
                
                // Clear Shipment Tracker
                flightAirlineEl.value = '';
                flightNumberEl.value = '';
                flightEtdEl.value = '';
                flightEtaEl.value = '';
                deliveryStatusEl.value = ''; // NEW
                flightNotesEl.value = '';
                
                // Clear Payment Tracker
                paymentPaidEl.value = '';
                paymentMethodEl.value = '';
                paymentStatusEl.value = 'Not Paid'; // NEW - Reset to default
                paymentNotesEl.value = '';
                calculatePaymentBalance(); // Recalculate (should be 0)

                // Reset Customer DB Edit State
                currentEditCustomerId = null;
                submitCustomerBtn.textContent = 'Submit Customer to Database';
                submitCustomerBtn.classList.remove('btn-secondary');
                 
                // Save the empty state to Firebase
                // Set isDataLoaded temporarily false to allow saving empty state
                const wasDataLoaded = isDataLoaded;
                isDataLoaded = true; // Force allow save
                saveData(); 
                isDataLoaded = wasDataLoaded; // Restore original state
                console.log("Form cleared and empty state saved.");
            }
            // --- End Customer DB Functions ---


            /**
             * Updates the "Shipment Summary" section AND all other tracker tabs
             */
            function updateSummary(totalQty, totalWeight, totalValue) {
                const senderName = senderNameEl.value;
                const receiverName = receiverNameEl.value;
                const receiverPhone = receiverPhoneEl.value;
                const receiverAddress = receiverAddressEl.value;
                const receiverAddressShort = (receiverAddress || '').split('\n')[0];
                const invoiceNumber = invoiceNumberEl.value;
                const invoiceDate = invoiceDateEl.value;

                // Update AWB section
                if (receiverName && receiverAddressShort) {
                    summaryReceiver.textContent = `${receiverName}, ${receiverAddressShort}`;
                } else if (receiverName) {
                    summaryReceiver.textContent = receiverName;
                } else {
                    summaryReceiver.textContent = '--';
                }
                
                const currentWeightInputVal = parseFloat(summaryWeightInput.value);
                const currentValueInputVal = parseFloat(summaryValueInput.value);

                // Only update summary inputs if they are empty or match the calculated total
                // This prevents overwriting manual overrides
                if (!summaryWeightInput.value || isNaN(currentWeightInputVal) || currentWeightInputVal === totalWeight) {
                    summaryWeightInput.value = totalWeight.toFixed(2); 
                }
                if (!summaryValueInput.value || isNaN(currentValueInputVal) || currentValueInputVal === totalValue) {
                     summaryValueInput.value = totalValue.toFixed(2);
                }


                // Update Shipment Tracker Tab
                stSenderName.textContent = senderName || '--';
                stReceiverName.textContent = receiverName || '--';
                stReceiverPhone.textContent = receiverPhone || '--';
                stReceiverAddress.textContent = receiverAddress || '--';

                // Update Payment Tracker Tab
                paymentInvoiceEl.value = invoiceNumber || '';
                paymentDateEl.value = invoiceDate || '';
                paymentCustomerEl.value = senderName || '';
                const displayValueForPayment = !isNaN(parseFloat(summaryValueInput.value)) ? parseFloat(summaryValueInput.value).toFixed(2) : totalValue.toFixed(2);
                paymentTotalEl.value = displayValueForPayment; 
                calculatePaymentBalance(); 
            }
            
            /**
             * NEW: Updates the brand datalist
             */
            function updateBrandDatalist() {
                const datalist = document.getElementById('brandList');
                if (!datalist) return;
                datalist.innerHTML = '';
                knownBrands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    datalist.appendChild(option);
                });
            }

            /**
             * Saves the CURRENT SHIPMENT data from ALL TABS to Firebase RTDB
             */
            function saveData() {
                // Only save if data has been loaded and not in the middle of another save
                // OR if explicitly clearing the form (isDataLoaded forced true in clearCustomerForm)
                if (isAutoSaving || !isDataLoaded) return; 

                isAutoSaving = true; // Set flag
                try {
                     const validItems = Array.isArray(items) ? items.filter(item => item !== null && item !== undefined) : [];
                    // UPDATED: Include new fields in data object
                    const data = {
                        senderName: senderNameEl.value,
                        receiverName: receiverNameEl.value,
                        senderPhone: senderPhoneEl.value, // NEW
                        receiverPhone: receiverPhoneEl.value,
                        receiverAddress: receiverAddressEl.value,
                        customerRemarks: customerRemarksEl.value, // NEW
                        totalPackages: totalPackagesEl.value,
                        invoiceNumber: invoiceNumberEl.value,
                        invoiceDate: invoiceDateEl.value,
                        hsCode: hsCodeEl.value,
                        items: validItems,
                        summaryWeightOverride: summaryWeightInput.value, 
                        summaryValueOverride: summaryValueInput.value,   
                        flightDetails: {
                            airline: flightAirlineEl.value,
                            number: flightNumberEl.value,
                            etd: flightEtdEl.value,
                            eta: flightEtaEl.value,
                            deliveryStatus: deliveryStatusEl.value, // NEW
                            notes: flightNotesEl.value,
                        },
                        paymentDetails: {
                            paid: paymentPaidEl.value,
                            method: paymentMethodEl.value,
                            status: paymentStatusEl.value, // NEW
                            notes: paymentNotesEl.value,
                        }
                    };
                    
                    // Save to a specific node in Firebase, e.g., 'currentShipment'
                    dbSet(dbRef(db, 'currentShipment'), data)
                        .then(() => {
                            // console.log("Form auto-saved to Firebase");
                        })
                        .catch((error) => {
                            console.error("Error auto-saving to Firebase:", error);
                        })
                        .finally(() => {
                            isAutoSaving = false; // Release flag
                        });

                } catch (error) {
                    console.error("Error preparing data for Firebase save:", error);
                    isAutoSaving = false; // Release flag on error
                }
            }

            /**
             * Loads all data from Firebase on page start
             */
            function loadData() {
                 console.log("Attempting to load data from Firebase...");
                 items = []; 
                 customerDatabase = [];

                 try {
                    // --- 1. Load and listen for Customer Database changes ---
                    const customersRef = dbRef(db, 'customers');
                    dbOnValue(customersRef, (snapshot) => {
                        console.log("Firebase Customer DB snapshot received");
                        if (snapshot.exists()) {
                            const dbData = snapshot.val();
                            // Convert Firebase object (with keys) to an array
                            customerDatabase = Object.keys(dbData).map(key => ({
                                id: key, // The Firebase key is the ID
                                ...dbData[key]
                            }));
                        } else {
                            console.log("No customers found in Firebase.");
                            customerDatabase = [];
                        }
                        renderCustomerDatabaseTable(customerSearchEl.value);
                    }, (error) => {
                        console.error("Error loading customer database:", error);
                        alert("Error: Could not load customer database from Firebase.");
                        // UPDATED colspan
                        customerTableTbody.innerHTML = `<tr><td colspan="13" style="color: red;">Error loading database.</td></tr>`;
                    });

                    // --- 2. Load and listen for Current Shipment Form data ---
                    const shipmentRef = dbRef(db, 'currentShipment');
                    dbOnValue(shipmentRef, (snapshot) => {
                        console.log("Firebase currentShipment snapshot received");
                        isAutoSaving = true; // Prevent save-loop on load
                        
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            // UPDATED: Load new fields
                            senderNameEl.value = data.senderName || '';
                            receiverNameEl.value = data.receiverName || '';
                            senderPhoneEl.value = data.senderPhone || ''; // NEW
                            receiverPhoneEl.value = data.receiverPhone || '';
                            receiverAddressEl.value = data.receiverAddress || '';
                            customerRemarksEl.value = data.customerRemarks || ''; // NEW
                            totalPackagesEl.value = data.totalPackages || '';
                            invoiceNumberEl.value = data.invoiceNumber || '';
                            invoiceDateEl.value = data.invoiceDate || '';
                            hsCodeEl.value = data.hsCode || '';
                            items = Array.isArray(data.items) ? data.items.filter(item => item) : []; 
                            
                            // NEW: Populate knownBrands from loaded items
                            knownBrands.clear();
                            items.forEach(item => {
                                if (item && item.brand) {
                                    knownBrands.add(item.brand);
                                }
                            });
                            updateBrandDatalist(); // Update the datalist
                            
                            summaryWeightInput.value = data.summaryWeightOverride !== undefined ? data.summaryWeightOverride : ''; 
                            summaryValueInput.value = data.summaryValueOverride !== undefined ? data.summaryValueOverride : '';     
                            
                            if (data.flightDetails) {
                                flightAirlineEl.value = data.flightDetails.airline || '';
                                flightNumberEl.value = data.flightDetails.number || '';
                                flightEtdEl.value = data.flightDetails.etd || '';
                                flightEtaEl.value = data.flightDetails.eta || '';
                                deliveryStatusEl.value = data.flightDetails.deliveryStatus || ''; // NEW
                                flightNotesEl.value = data.flightDetails.notes || '';
                            }
                            if (data.paymentDetails) {
                                paymentPaidEl.value = data.paymentDetails.paid || '';
                                paymentMethodEl.value = data.paymentDetails.method || '';
                                paymentStatusEl.value = data.paymentDetails.status || 'Not Paid'; // NEW
                                paymentNotesEl.value = data.paymentDetails.notes || '';
                            }

                            // Check if the loaded data represents a cleared state (e.g., empty sender name after a clear operation)
                            // If so, ensure everything is visually cleared again.
                            // UPDATED: Check for empty sender/receiver OR empty items array
                            if (!data.senderName && !data.receiverName && (!data.items || data.items.length === 0)) {
                                console.log("Listener received cleared state, ensuring form is reset.");
                                // Ensure items array is empty 
                                items = []; 
                            }
                        } else {
                            console.log("No previous shipment data found in Firebase.");
                            // If node truly doesn't exist, clear everything locally
                             items = []; // Ensure items array is empty if no data node
                            // clearCustomerForm(); // Let's avoid calling this here to prevent potential loops, just clear items
                        }
                        
                        if (!invoiceDateEl.value) { // Set default date if none loaded
                            invoiceDateEl.valueAsDate = new Date();
                        }
                        
                        renderTable(); // Render items table (will be empty if items is [])
                        // historyStack = []; // Let's not clear history on every load for now
                        // redoStack = [];
                        // updateHistoryButtons();
                        
                        setTimeout(() => {
                           isAutoSaving = false; // Release lock
                           isDataLoaded = true; // Allow auto-saving to begin
                           console.log("Listener finished processing snapshot. Auto-save enabled.");
                        }, 150); // Reduced delay slightly 
                        
                    }, (error) => {
                        console.error("Error loading current shipment data:", error);
                        alert("Error: Could not load current shipment data from Firebase.");
                        isAutoSaving = false;
                        isDataLoaded = true; // Allow saving even if load failed
                    });

                 } catch (generalError) { 
                     console.error("General error during loadData setup:", generalError);
                     alert("An unexpected error occurred while loading data. Check console.");
                     isDataLoaded = true; // Allow saving even if load failed
                 }
            }

            // --- Payment Balance Calculator ---
            function calculatePaymentBalance() {
                const total = parseFloat(paymentTotalEl.value) || 0;
                const paid = parseFloat(paymentPaidEl.value) || 0;
                const balance = total - paid;
                paymentBalanceEl.value = balance.toFixed(2);
                
                // NEW: Update Payment Status dropdown based on balance
                if (paid <= 0) {
                    paymentStatusEl.value = 'Not Paid';
                } else if (balance <= 0) {
                    paymentStatusEl.value = 'Paid';
                } else {
                    paymentStatusEl.value = 'Partially Paid';
                }
            }

            // --- History Functions ---
            function saveState() {
                historyStack.push(JSON.parse(JSON.stringify(items)));
                redoStack = [];
                updateHistoryButtons();
            }
            function updateHistoryButtons() {
                undoBtn.disabled = historyStack.length === 0;
                redoBtn.disabled = redoStack.length === 0;
            }
            function undo() {
                if (historyStack.length > 0) {
                    redoStack.push(JSON.parse(JSON.stringify(items)));
                    items = historyStack.pop();
                    renderTable();
                    saveData();
                    updateHistoryButtons();
                }
            }
            function redo() {
                if (redoStack.length > 0) {
                    historyStack.push(JSON.parse(JSON.stringify(items)));
                    items = redoStack.pop();
                    renderTable();
                    saveData();
                    updateHistoryButtons();
                }
            }
            // --- End History ---


            // --- 4. Event Listeners (Making buttons work) ---

            // --- Tab Switching ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(t => t.classList.remove('active'));
                    link.classList.add('active');
                    const tabId = link.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });


            // --- Tab 1 Listeners ---

            // --- Helper function to reset item edit state ---
            function clearEditState() {
                currentEditItemIndex = null;
                addItemForm.reset(); // This will clear all fields
                itemConditionBtn.classList.remove('used'); // NEW: Reset button state
                itemConditionBtn.textContent = 'New';
                addItemSubmitBtn.textContent = 'Add Item +';
                addItemSubmitBtn.classList.remove('btn-secondary');
                cancelEditBtn.style.display = 'none';
            }

            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                saveState(); // Save history

                // UPDATED: Added category
                const item = {
                    desc: itemDescEl.value,
                    brand: itemBrandEl.value.trim(), // NEW
                    category: itemCategoryEl.value,
                    qty: parseFloat(document.getElementById('itemQty').value) || 1, // Default qty to 1
                    weight: 0, // Set weight to 0 by default for summary calculations
                    value: parseFloat(document.getElementById('itemValue').value) || 0, // Default value to 0
                    remarks: itemRemarksEl.value
                };
                
                if (item.category === "") {
                    alert("Please select a category for the item.");
                    return;
                }
                
                // NEW: Add brand to known brands
                if (item.brand) {
                    knownBrands.add(item.brand);
                    updateBrandDatalist();
                }

                 if (!Array.isArray(items)) items = []; 

                if (currentEditItemIndex !== null && currentEditItemIndex >= 0 && currentEditItemIndex < items.length) {
                    // --- UPDATE EXISTING ITEM ---
                    items[currentEditItemIndex] = item;
                } else {
                    // --- ADD NEW ITEM ---
                    items.push(item);
                }

                renderTable(); 
                saveData(); // Save to Firebase
                clearEditState(); // Reset form and buttons
            });
            
            // NEW: Condition Button Toggle Listener
            itemConditionBtn.addEventListener('click', () => {
                let remarks = itemRemarksEl.value;
                
                // Remove existing condition tags
                remarks = remarks.replace(/\(Used\)/g, '').replace(/\(New\)/g, '').trim();

                if (itemConditionBtn.classList.contains('used')) {
                    // Switch to New
                    itemConditionBtn.classList.remove('used');
                    itemConditionBtn.textContent = 'New';
                    if (remarks) {
                        itemRemarksEl.value = remarks + ' (New)';
                    } else {
                        itemRemarksEl.value = '(New)';
                    }
                } else {
                    // Switch to Used
                    itemConditionBtn.classList.add('used');
                    itemConditionBtn.textContent = 'Used';
                    if (remarks) {
                        itemRemarksEl.value = remarks + ' (Used)';
                    } else {
                        itemRemarksEl.value = '(Used)';
                    }
                }
                saveData(); // Auto-save when condition changes
            });
            
            // NEW: Auto-Category Suggest Listener
            itemDescEl.addEventListener('input', (e) => {
                const desc = e.target.value.toLowerCase();
                // Don't overwrite if user already selected a category
                if (itemCategoryEl.value !== "") {
                    return;
                }
                
                // Simple keyword matching
                if (desc.includes('shoe') || desc.includes('shirt') || desc.includes('pants') || desc.includes('clothing') || desc.includes('jacket')) {
                    itemCategoryEl.value = 'Footwear & Clothing';
                } else if (desc.includes('camera') || desc.includes('phone') || desc.includes('laptop') || desc.includes('charger') || desc.includes('cable') || desc.includes('gimbal')) {
                    itemCategoryEl.value = 'Electronics';
                } else if (desc.includes('chocolate') || desc.includes('pasta') || desc.includes('coffee') || desc.includes('snack') || desc.includes('food')) {
                    itemCategoryEl.value = 'Packaged Food';
                } else if (desc.includes('ball') || desc.includes('fitness') || desc.includes('sports')) {
                    itemCategoryEl.value = 'Sports Equipment';
                } else if (desc.includes('bottle') || desc.includes('household') || desc.includes('personal')) {
                    itemCategoryEl.value = 'Household & Personal Items';
                } else if (desc.includes('toy') || desc.includes('kids')) {
                    itemCategoryEl.value = 'Kids Items & Toys';
                } else if (desc.includes('shampoo') || desc.includes('beauty') || desc.includes('health') || desc.includes('cream')) {
                    itemCategoryEl.value = 'Health & Beauty Products';
                } else if (desc.includes('book') || desc.includes('pen') || desc.includes('stationery')) {
                    itemCategoryEl.value = 'Books & Stationery';
                } else if (desc.includes('document') || desc.includes('paper') || desc.includes('letter')) {
                    itemCategoryEl.value = 'Documents';
                } else if (desc.includes('gift') || desc.includes('souvenir')) {
                    itemCategoryEl.value = 'Gifts / Souvenirs';
                } else if (desc.includes('liquid') || desc.includes('drink') || desc.includes('water') || desc.includes('juice')) {
                    itemCategoryEl.value = 'Liquids';
                } else if (desc.includes('battery') || desc.includes('power bank')) {
                    itemCategoryEl.value = 'Batteries / Power Banks';
                } else if (desc.includes('fragile') || desc.includes('glass')) {
                    itemCategoryEl.value = 'Fragile Items';
                } else if (desc.includes('medicine') || desc.includes('vitamin') || desc.includes('pill')) {
                    itemCategoryEl.value = 'Medicines / Vitamins';
                } else if (desc.includes('used')) {
                    itemCategoryEl.value = 'Used Items';
                } else if (desc.includes('new')) {
                    itemCategoryEl.value = 'New Items';
                }
            });

            itemTbody.addEventListener('click', (e) => {
                 if (!Array.isArray(items)) items = []; 

                if (e.target.classList.contains('btn-delete')) {
                    // --- DELETE ITEM ---
                    if (confirm('Are you sure you want to delete this item?')) {
                        saveState(); // Save history
                        const index = parseInt(e.target.dataset.index);
                         if (!isNaN(index) && index >= 0 && index < items.length) {
                             items.splice(index, 1);
                             renderTable();
                             saveData(); // Save to Firebase
                             clearEditState(); // Reset form if deleting the item being edited
                         } else {
                             console.error("Invalid index for deleting item:", index);
                         }
                    }
                } else if (e.target.classList.contains('btn-edit-item')) {
                    // --- EDIT ITEM ---
                    const index = parseInt(e.target.dataset.index);
                     if (!isNaN(index) && index >= 0 && index < items.length) { 
                        const item = items[index];
                        
                        // UPDATED: Populate all new fields
                        itemDescEl.value = item.desc || '';
                        itemBrandEl.value = item.brand || ''; // NEW
                        itemCategoryEl.value = item.category || '';
                        document.getElementById('itemQty').value = item.qty || 1;
                        document.getElementById('itemValue').value = item.value || 0;
                        itemRemarksEl.value = item.remarks || '';
                        
                        // NEW: Set condition button state
                        if (item.remarks && item.remarks.includes('(Used)')) {
                            itemConditionBtn.classList.add('used');
                            itemConditionBtn.textContent = 'Used';
                        } else {
                            itemConditionBtn.classList.remove('used');
                            itemConditionBtn.textContent = 'New';
                        }
                        
                        currentEditItemIndex = index;
                        
                        addItemSubmitBtn.textContent = 'Update Item';
                        addItemSubmitBtn.classList.add('btn-secondary');
                        cancelEditBtn.style.display = 'inline-block';
                        
                        addItemForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     } else {
                         console.error("Invalid index for editing item:", index);
                     }
                }
            });

            // Auto-save for Tab 1 *shipment* fields
            // UPDATED: Added new fields to auto-save
            const fieldsToAutoSave = [
                senderNameEl, receiverNameEl, senderPhoneEl, receiverPhoneEl, 
                receiverAddressEl, customerRemarksEl,
                totalPackagesEl, invoiceNumberEl, invoiceDateEl, hsCodeEl,
                summaryWeightInput, summaryValueInput, 
                itemRemarksEl // Item remarks still auto-save
            ];
            fieldsToAutoSave.forEach(field => {
                field.addEventListener('input', () => {
                     if (field.id === 'summaryValueInput') {
                         calculatePaymentBalance(); // Recalculate balance if declared value changes
                     }
                     // Always save data
                     saveData();
                });
            });

            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            cancelEditBtn.addEventListener('click', clearEditState); 

            // Tab 1 Customer DB Submit Listener 
            // UPDATED: To add default fields for NEW customers
            submitCustomerBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const senderName = senderNameEl.value.trim();
                const receiverName = receiverNameEl.value.trim();
                
                if (!senderName && !receiverName) {
                    alert('Please enter at least a Sender or Receiver name to save to the database.');
                    return;
                }
                
                // This is the base data from the form
                const baseCustomerData = {
                    senderName: senderName,
                    receiverName: receiverName,
                    senderPhone: senderPhoneEl.value,
                    receiverPhone: receiverPhoneEl.value,
                    receiverAddress: receiverAddressEl.value,
                    customerRemarks: customerRemarksEl.value,
                    dateAdded: new Date().toISOString() // Add/update date
                };

                submitCustomerBtn.disabled = true; // Prevent double-click

                try {
                    if (currentEditCustomerId) {
                        // --- EDIT MODE ---
                        // Only update fields from the form
                        const customerRef = dbRef(db, 'customers/' + currentEditCustomerId);
                        await dbUpdate(customerRef, baseCustomerData);
                        alert('Customer updated successfully!');
                    } else {
                        // --- NEW CUSTOMER MODE ---
                        // Add new fields with defaults
                        const fullCustomerData = {
                            ...baseCustomerData,
                            paymentStatus: 'Not Paid',
                            amount: '',
                            deliveryStatus: 'Pending',
                            trackingNumber: ''
                        };
                        const customersListRef = dbRef(db, 'customers');
                        await dbPush(customersListRef, fullCustomerData);
                        alert('Customer added successfully!');
                    }
                    
                    // UPDATED: Call the full form clearing function
                    clearCustomerForm(); 
                    
                    // Try switching tab
                    const dbTabLink = document.querySelector('[data-tab="tab-customer-database"]');
                    if (dbTabLink) dbTabLink.click(); 
                    else console.error("Could not find database tab link to switch.");

                } catch (error) {
                     console.error("Error saving customer to Firebase:", error);
                     alert("Error: Could not save customer. Check console for details.");
                } finally {
                    submitCustomerBtn.disabled = false; // Re-enable button
                }
            });

            // Tab 2 (Customer Database) Listeners 
            customerSearchEl.addEventListener('input', (e) => {
                renderCustomerDatabaseTable(e.target.value);
            });
            
            // UPDATED: 'click' listener to handle Edit/Delete
            customerTableTbody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return; 

                const id = button.dataset.id;
                if (!id) return; // Exit if no id

                if (!Array.isArray(customerDatabase)) customerDatabase = [];

                if (button.classList.contains('btn-delete-db')) {
                    if (confirm('Are you sure you want to permanently delete this customer from the database?')) {
                        dbRemove(dbRef(db, 'customers/' + id))
                            .then(() => {
                                console.log("Customer deleted");
                                // The onValue listener will automatically re-render the table
                            })
                            .catch((error) => {
                                console.error("Error deleting customer:", error);
                                alert("Error: Could not delete customer.");
                            });
                    }
                }
                
                if (button.classList.contains('btn-edit')) {
                    // "Edit" now just populates the Tab 1 form
                    const customer = customerDatabase.find(c => c && c.id === id); 
                    if (customer) {
                        // UPDATED: Populate new fields when editing
                        senderNameEl.value = customer.senderName || '';
                        receiverNameEl.value = customer.receiverName || '';
                        senderPhoneEl.value = customer.senderPhone || ''; // NEW
                        receiverPhoneEl.value = customer.receiverPhone || '';
                        receiverAddressEl.value = customer.receiverAddress || '';
                        customerRemarksEl.value = customer.customerRemarks || ''; // NEW
                        
                        // NOTE: Payment/Tracking data is edited inline in the table
                        // not on this form.
                        
                        currentEditCustomerId = id;
                        submitCustomerBtn.textContent = 'Save Changes to Database';
                        submitCustomerBtn.classList.add('btn-secondary'); 
                        
                         const detailsTabLink = document.querySelector('[data-tab="tab-customer-details"]');
                         if(detailsTabLink) detailsTabLink.click();
                    } else {
                         console.error("Edit button: Customer not found with ID", id);
                    }
                }
            });
            
            // NEW: 'change' listener for inline table edits
            customerTableTbody.addEventListener('change', (e) => {
                const target = e.target;
                // Check if it's one of our new editable fields
                if (target.classList.contains('db-field-update')) {
                    const customerId = target.dataset.id;
                    const fieldName = target.name;
                    const value = target.value;
                    
                    if (!customerId || !fieldName) {
                        console.error("Missing data-id or name on editable field.");
                        return;
                    }

                    // Update the color if it's a select
                    if (target.tagName === 'SELECT') {
                        updateSelectColor(target);
                    }
                    
                    // Prepare the update for Firebase
                    const updateData = {};
                    updateData[fieldName] = value;
                    
                    // Special case: If remarks are edited here, also update the main form
                    // if it's the same customer (though this is less common)
                    if (fieldName === 'customerRemarks' && customerId === currentEditCustomerId) {
                         customerRemarksEl.value = value;
                         saveData(); // Save the main form as well
                    }

                    const customerRef = dbRef(db, 'customers/' + customerId);
                    dbUpdate(customerRef, updateData)
                        .then(() => {
                            console.log(`Customer ${customerId} field ${fieldName} updated to ${value}`);
                        })
                        .catch((error) => {
                            console.error("Error updating customer field:", error);
                            alert("Error: Could not save change to database.");
                        });
                }
            });


            // --- Tab 3 (Shipment Tracker) Listeners (Auto-save) ---
            // UPDATED: Added deliveryStatusEl to auto-save
            const flightFieldsToAutoSave = [
                flightAirlineEl, flightNumberEl, flightEtdEl, flightEtaEl, deliveryStatusEl, flightNotesEl
            ];
            flightFieldsToAutoSave.forEach(field => {
                field.addEventListener('input', saveData);
            });

            // --- Tab 4 (Payment Tracker) Listeners (Auto-save & Calculate) ---
            // UPDATED: Added paymentStatusEl to auto-save
            const paymentFieldsToAutoSave = [
                paymentPaidEl, paymentMethodEl, paymentStatusEl, paymentNotesEl
            ];
            paymentFieldsToAutoSave.forEach(field => {
                field.addEventListener('input', () => {
                    // Update balance ONLY when Amount Paid changes
                    if(field.id === 'paymentPaid') {
                        calculatePaymentBalance(); 
                    }
                    saveData();
                });
            });


            // --- 5. PDF & Excel Export Functions ---

            // NEW: Function to fetch logo as Base64
            let fetchedLogoBase64 = null; // Store fetched logo
            async function fetchLogoAsBase64() {
                // If already fetched, return it
                if (fetchedLogoBase64) return fetchedLogoBase64; 
                
                // Use the GitHub raw URL for your logo
                const logoUrl = 'https://raw.githubusercontent.com/crickerr26/bee26cargomanager/main/BEE26.jpg'; 
                try {
                    const response = await fetch(logoUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const blob = await response.blob();
                    
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                             // Store and resolve the Base64 string
                            fetchedLogoBase64 = reader.result; 
                            resolve(fetchedLogoBase64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error('Error fetching or converting logo:', error);
                    // Return null or a placeholder if fetch fails
                    return null; 
                }
            }


            // Simple footer function - adds footer text
            function addPdfFooter(doc) {
                 if (!doc || typeof doc.setFontSize !== 'function') return;
                 try {
                     doc.setFontSize(9);
                     doc.setFont("helvetica", "normal");
                     const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
                     // Add page numbers
                     const pageCount = doc.internal.getNumberOfPages();
                     for (let i = 1; i <= pageCount; i++) {
                         doc.setPage(i);
                         doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, pageHeight - 5, { align: 'center' });
                         doc.text("Bee26 Cargo Services • Toronto • +1 416-474-4994", 105, pageHeight - 12, { align: "center" });
                     }
                 } catch (error) {
                      console.error("Error adding PDF footer:", error);
                 }
            }


            // --- UPDATED PDF GENERATION (Async to fetch logo) ---
            async function generatePDF(docType, action = 'save') { 
                try { 
                    // --- Basic Setup ---
                    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                        alert("Error: jsPDF library not loaded."); 
                        return; 
                    }
                    const jsPDF = window.jspdf.jsPDF;
                    const doc = new jsPDF('p', 'pt', 'a4'); // Use points for finer control, standard A4
                    if (typeof doc.autoTable !== 'function') { 
                        alert("Error: jsPDF AutoTable plugin not loaded.");
                        return; 
                    }
                    
                    // NEW: Fetch logo before generating PDF content
                    const logoBase64Data = await fetchLogoAsBase64(); 

                    // --- Variables ---
                    const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
                    const pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();
                    const leftMargin = 40; // Approx 14mm in points
                    const rightMargin = 40;
                    const topMargin = 40; 
                    const bottomMargin = 40; 
                    const contentWidth = pageWidth - leftMargin - rightMargin;
                    const halfWidth = contentWidth / 2;
                    const senderX = leftMargin;
                    const receiverX = leftMargin + halfWidth + 15; // Increased gap between columns
                    const receiverWidth = halfWidth - 15; // Width for receiver block
                    const senderWidth = halfWidth - 5;   // Width for sender block
                    let currentY = topMargin; 
                    const lineSpacing = 10; // Use points for line spacing (adjust as needed)
                    const sectionSpacing = 15; // Space between header sections and table

                     // --- Section 1: Logo and Title ---
                    const titleY = currentY + 7; // Start title slightly lower
                    const titleX = pageWidth / 2; // Center of page
                    
                    // UPDATED: Use fetched logo data
                    if (logoBase64Data) { 
                        try {
                            const imgWidth = 20; // Smaller logo in points
                            const imgHeight = 20; 
                            doc.setFontSize(16); // Set title font size before measuring
                            const titleWidth = doc.getTextWidth(docType); 
                            const logoX = titleX - (titleWidth / 2) - imgWidth - 5; // Position left of title
                            doc.addImage(logoBase64Data, 'JPEG', logoX, titleY - (imgHeight/2) + 2, imgWidth, imgHeight); 
                        } catch (imgError) { console.error("Error adding PDF logo:", imgError); }
                    } else { console.warn("Logo Base64 data not available for PDF."); }

                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text(docType, titleX, titleY, { align: "center" }); 
                    currentY = titleY + 15; // Move Y further below title area


                    // --- Section 2: Sender Address & Invoice Details ---
                    let senderBlockY = currentY; 
                    doc.setFontSize(9); // Standard text size
                    doc.setFont("helvetica", "bold");
                    doc.text("BEE26 CARGO SERVICES", leftMargin, senderBlockY);
                    senderBlockY += lineSpacing;
                    doc.setFont("helvetica", "normal");

                    const addressLines = [ 
                        "MOHAMED IMSAMAM MOHAED RIZAN",
                        "1001260111 - BIN",
                        "614-2 MILEPOST PLACE, EAST YORK,",
                        "ONTARIO, M4H 1C7",
                        "+1 416 474 4994",
                        "bee26cargoservices@gmail.com"
                     ];
                    addressLines.forEach(line => {
                        const splitLines = doc.splitTextToSize(line, senderWidth); 
                        doc.text(splitLines, leftMargin, senderBlockY);
                        senderBlockY += (splitLines.length * lineSpacing); 
                    });
                    
                    if (invoiceNumberEl.value) {
                         senderBlockY += lineSpacing * 0.5; // Tighter space
                         doc.setFont("helvetica", "bold");
                         doc.text(`Invoice #: ${invoiceNumberEl.value}`, leftMargin, senderBlockY);
                         senderBlockY += lineSpacing; 
                    }
                    if (docType === 'Commercial Invoice') { 
                         senderBlockY += 0; 
                         doc.setFont("helvetica", "bold");
                         doc.text("Date: ", leftMargin, senderBlockY);
                         doc.setFont("helvetica", "normal");
                         doc.text(invoiceDateEl.value || '', leftMargin + 30, senderBlockY); // Adjust position
                         senderBlockY += lineSpacing; 
                    }


                    // --- Section 3: Receiver Address & Optional HS Code ---
                    let receiverBlockY = currentY; // Start receiver block parallel to sender block start
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("TO (Receiver):", receiverX, receiverBlockY);
                    receiverBlockY += lineSpacing * 1.5; 

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9); 
                    doc.text(receiverNameEl.value || '', receiverX, receiverBlockY); 
                    receiverBlockY += lineSpacing;
                    doc.text(receiverPhoneEl.value || '', receiverX, receiverBlockY); 
                    receiverBlockY += lineSpacing;
                    const receiverAddressLines = doc.splitTextToSize(receiverAddressEl.value || '', receiverWidth); // Use receiverWidth
                    doc.text(receiverAddressLines, receiverX, receiverBlockY);
                    receiverBlockY += (receiverAddressLines.length * lineSpacing); 
                    
                    if (docType === 'Commercial Invoice' && hsCodeEl.value) {
                         receiverBlockY += lineSpacing * 0.5; 
                         doc.setFont("helvetica", "bold");
                         doc.text("HS Code (Overall): ", receiverX, receiverBlockY); 
                         doc.setFont("helvetica", "normal");
                         doc.text(hsCodeEl.value, receiverX + 80, receiverBlockY); // Adjust position
                         receiverBlockY += lineSpacing * 1.5; 
                    }

                    // --- Section 4: Table ---
                    let tableStartY = Math.max(senderBlockY, receiverBlockY) + sectionSpacing; // Use sectionSpacing

                    // UPDATED: Added Brand to table header
                    const tableHead = [ 
                         ['#', 'Description', 'Brand', 'Category', 'Qty', 'Unit Value (CAD)', 'Total Value (CAD)', 'Remarks'] 
                     ];
                    const safeItems = Array.isArray(items) ? items : [];
                    // UPDATED: Added Brand to table body
                    const tableBody = safeItems.map((item, index) => { 
                          const qty = parseFloat(item.qty) || 0;
                          const value = parseFloat(item.value) || 0;
                          return [
                             index + 1, 
                             item.desc || '',
                             item.brand || '', // NEW
                             item.category || '',
                             qty,
                             value.toFixed(2),
                             (qty * value).toFixed(2),
                             item.remarks || '' 
                          ];
                     });

                    doc.autoTable({ 
                        head: tableHead,
                        body: tableBody,
                        startY: tableStartY,
                        theme: 'grid',
                        headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold', fontSize: 8 }, 
                        styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' }, // Allow line breaks
                        // UPDATED: Column styles for new brand column
                        columnStyles: { 
                            0: { cellWidth: 20, halign: 'center' },  // #
                            1: { cellWidth: 'auto'},              // Description 
                            2: { cellWidth: 50 },                 // Brand (NEW)
                            3: { cellWidth: 50 },                 // Category
                            4: { cellWidth: 30, halign: 'right' },  // Qty
                            5: { cellWidth: 50, halign: 'right' },  // Unit Value
                            6: { cellWidth: 50, halign: 'right' },  // Total Value
                            7: { cellWidth: 60 }                  // Remarks
                        },
                        margin: { left: leftMargin, right: rightMargin } 
                    });

                    // --- Section 5: Summary ---
                    const finalY = doc.autoTable.previous.finalY; // More reliable way to get end Y
                    
                    const calculatedTotalWeight = /*...*/ safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.weight) || 0)), 0);
                    const calculatedTotalValue = /*...*/ safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)), 0);
                    const totalQty = /*...*/ safeItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);
                    const displayWeight = /*...*/ !isNaN(parseFloat(summaryWeightInput.value)) ? parseFloat(summaryWeightInput.value).toFixed(2) : calculatedTotalWeight.toFixed(2);
                    const displayValue = /*...*/ !isNaN(parseFloat(summaryValueInput.value)) ? parseFloat(summaryValueInput.value).toFixed(2) : calculatedTotalValue.toFixed(2);

                    doc.setFontSize(10); 
                    doc.setFont("helvetica", "bold");
                    let summaryY = finalY + sectionSpacing; 
                    const summaryRightX = pageWidth - rightMargin; 
                    
                     // Check if summary needs to go on new page
                     if (summaryY > pageHeight - bottomMargin - (lineSpacing * 6)) { // Estimate summary height
                         doc.addPage();
                         summaryY = topMargin; // Start summary on new page
                     }

                    doc.text(`Total Quantity:`, leftMargin, summaryY);
                    doc.text(`${totalQty} pcs`, summaryRightX, summaryY, { align: 'right'});
                    summaryY += lineSpacing * 1.5; 
                    
                    doc.text(`Total Packages:`, leftMargin, summaryY);
                    doc.text(`${totalPackagesEl.value || 'N/A'}`, summaryRightX, summaryY, { align: 'right'});
                     summaryY += lineSpacing * 1.5; 
                    
                    doc.text(`Total Net Weight:`, leftMargin, summaryY);
                    doc.text(`${displayWeight} kg`, summaryRightX, summaryY, { align: 'right'}); 
                    summaryY += lineSpacing * 1.5; 
                    
                    doc.text(`Total Declared Value:`, leftMargin, summaryY);
                    doc.text(`$${displayValue} CAD`, summaryRightX, summaryY, { align: 'right'});
                   
                    
                    // --- Section 6: Declaration ---
                    doc.setFontSize(9); 
                    doc.setFont("helvetica", "bold");
                    let declarationY = summaryY + sectionSpacing * 1.5; // More space before declaration
                    if (declarationY > pageHeight - bottomMargin) { // Check against bottom margin only
                        doc.addPage();
                        declarationY = topMargin; 
                    }
                    doc.text("Declaration: Personal Use – Not for Resale", leftMargin, declarationY);

                    // --- Add Page Numbers and Footer ---
                    addPdfFooter(doc); // Call footer function *after* all content is added

                    // --- Output ---
                    const fileName = `${docType.replace(/ /g, '_')}_${invoiceNumberEl.value || 'Shipment'}.pdf`; 
                    if (action === 'open') {
                        doc.output('dataurlnewwindow'); 
                    } else {
                        doc.save(fileName); 
                    }

                } catch (error) { 
                    console.error("Error generating PDF:", error);
                    alert("Sorry, there was an error generating the PDF. Please ensure all item details are entered correctly and check the console (F12) for more details.");
                }
            }


            function generateExcel() { /* ... Excel generation code ... */ 
                 try { 
                    if (typeof XLSX === 'undefined') {
                         console.error("XLSX (SheetJS) library not loaded correctly.");
                         alert("Error: XLSX library not found. Cannot generate Excel file.");
                         return;
                    }

                    const infoData = [
                        ["Shipment Details", ""],
                        ["Sender Name", senderNameEl.value],
                        ["Receiver Name", receiverNameEl.value],
                        ["Receiver Phone", receiverPhoneEl.value],
                        ["Receiver Address", receiverAddressEl.value],
                        ["", ""],
                        ["Invoice #", invoiceNumberEl.value],
                        ["Date", invoiceDateEl.value],
                        ["Total Packages", totalPackagesEl.value],
                        ["HS Code", hsCodeEl.value]
                    ];
                    const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
                    
                    // UPDATED: Added Brand to header
                    const itemsHeader = [
                        'Description', 'Brand', 'Category', 'Quantity', 'Unit Weight (kg)', 'Total Weight (kg)', 'Unit Value (CAD)', 'Total Value (CAD)', 'Remarks'
                    ];
                    // Ensure items is an array before mapping
                     const safeItems = Array.isArray(items) ? items : [];
                     // UPDATED: Added Brand to body
                     const itemsBody = safeItems.map(item => {
                         const qty = parseFloat(item.qty) || 0;
                         const weight = parseFloat(item.weight) || 0; // Keep weight for Excel
                         const value = parseFloat(item.value) || 0;
                         return [
                            item.desc || '',
                            item.brand || '', // NEW
                            item.category || '',
                            qty,
                            weight,
                            qty * weight,
                            value,
                            qty * value,
                            item.remarks || ''
                         ];
                     });
                    
                    const totalQty = safeItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);
                    const calculatedTotalWeight = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.weight) || 0)), 0); // Keep calculated weight for Excel
                    const calculatedTotalValue = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)), 0);

                    // Use input values if present and valid number, otherwise use calculated values for Excel footer
                    const displayWeight = !isNaN(parseFloat(summaryWeightInput.value)) ? parseFloat(summaryWeightInput.value).toFixed(2) : calculatedTotalWeight.toFixed(2);
                    const displayValue = !isNaN(parseFloat(summaryValueInput.value)) ? parseFloat(summaryValueInput.value).toFixed(2) : calculatedTotalValue.toFixed(2);
                    
                    // UPDATED: Added empty cells for brand/category column in footer
                    const itemsFooter = [
                        'TOTAL', '', '', totalQty, '', displayWeight, '', displayValue, ''
                    ];
                    
                    const wsItems = XLSX.utils.aoa_to_sheet([itemsHeader, ...itemsBody, [], itemsFooter]);

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsInfo, "Shipment Info");
                    XLSX.utils.book_append_sheet(wb, wsItems, "Packing List");

                    const fileName = `Bee26_Shipment_${invoiceNumberEl.value || ''}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                 } catch (error) { 
                    console.error("Error generating Excel:", error);
                    alert("Sorry, there was an error generating the Excel file. Check the console (F12) for details.");
                 }
             }

            // --- 6. Connect buttons to export/print functions ---
            // Ensure buttons exist before adding listeners
            if (exportPackingListPDF) exportPackingListPDF.addEventListener('click', () => generatePDF('Packing List', 'save')); 
            if (exportInvoicePDF) exportInvoicePDF.addEventListener('click', () => generatePDF('Commercial Invoice', 'save')); 
            
            if (exportPackingListExcel) exportPackingListExcel.addEventListener('click', generateExcel);
            if (exportInvoiceExcel) exportInvoiceExcel.addEventListener('click', generateExcel);
            
            if (printPackingListBtn) printPackingListBtn.addEventListener('click', () => generatePDF('Packing List', 'open')); 
            if (printInvoiceBtn) printInvoiceBtn.addEventListener('click', () => generatePDF('Commercial Invoice', 'open')); 


            // --- 7. Load data when the app starts ---
            loadData();
        });
    </script>

</body>
</html>