<!DOCTYPE html>
<html lang="en">


    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Bee26 Cargo App</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getDatabase, ref, set, get, push, remove, update, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
      
      // --- YOUR FIREBASE CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyAMZHYef6CXhkfJNdewMQ8M2gifGgS07k",
        authDomain: "bee26cargoservices-2651f.firebaseapp.com",
        projectId: "bee26cargoservices-2651f",
        storageBucket: "bee26cargoservices-2651f.appspot.com", 
        messagingSenderId: "508829616627",
        appId: "1:508829616627:web:062d3f033cad60a9089686",
        measurementId: "G-YSB8DJ5PE6",
        databaseURL: "https://bee26cargoservices-2651f-default-rtdb.firebaseio.com" 
      };

      // --- Initialize Firebase ---
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // --- Expose Firebase functions ---
      window.db = database;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbGet = get;
      window.dbPush = push;
      window.dbRemove = remove; 
      window.dbUpdate = update;
      window.dbOnValue = onValue;
      
    </script>


    <style>
        /* --- 1. Root Variables --- */
        :root {
            --blue: #007aff;
            --blue-light: #e6f2ff;
            --green: #28a745;
            --green-light: #e9f7eb;
            --red: #c70000;
            --red-light: #fff1f0;
            --orange: #d46b08;
            --orange-light: #fffbe6;
            --purple: #5856d6;
            --teal: #20c997;

            --grey-light: #f0f0f5;
            --grey-mid: #e5e5ea;
            --grey-dark: #8a8a8e;
            --text-primary: #1c1c1e;
            --text-secondary: #636366;
            --bg-white: #ffffff;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            --sidebar-dark: #1a202c;
            --sidebar-text: #e2e8f0;
            --sidebar-text-hover: #ffffff;
            --sidebar-width-collapsed: 80px;
            --sidebar-width-expanded: 250px;
        }

        /* --- 2. Basic Setup --- */
        body {
            font-family: var(--font-family);
            background-color: var(--grey-light);
            color: var(--text-primary);
            margin: 0;
            overflow-x: hidden;
        }

        /* --- 3. Sidebar --- */
        .sidebar {
            width: var(--sidebar-width-expanded); 
            height: 100vh;
            background-color: var(--sidebar-dark);
            border-right: 1px solid var(--sidebar-dark);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            transition: width 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-logo { display: flex; align-items: center; justify-content: center; height: 70px; font-size: 1.5rem; font-weight: 700; color: var(--bg-white); flex-shrink: 0; }
        .sidebar-logo .logo-text { opacity: 1; visibility: visible; transition: opacity 0.2s ease 0.1s; margin-left: 10px; } 
        .sidebar-nav { list-style: none; padding: 0 1rem; margin: 1rem 0 0 0; flex-grow: 1; }
        .sidebar-nav li a { display: flex; align-items: center; padding: 0.9rem 0.75rem; text-decoration: none; font-weight: 500; color: var(--sidebar-text); border-radius: 8px; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; cursor: pointer; }
        .sidebar-nav li a:hover { background-color: #2d3748; color: var(--sidebar-text-hover); }
        .sidebar-nav li a.active { background-color: var(--blue); color: var(--bg-white); font-weight: 600; }
        .nav-icon { font-size: 1.5rem; width: 30px; text-align: center; flex-shrink: 0; transition: transform 0.2s ease; }
        .nav-text { margin-left: 1.25rem; opacity: 1; visibility: visible; transition: opacity 0.2s ease 0.1s; } 
        .sidebar-bottom { padding: 0 1rem 1rem 1rem; }

        /* --- 4. Main Content Area --- */
        .main-content { margin-left: var(--sidebar-width-expanded); width: calc(100% - var(--sidebar-width-expanded)); padding: 2rem; box-sizing: border-box; transition: margin-left 0.3s ease-in-out; opacity: 1; } 
        .page-content { display: none; }
        .page-content.active { display: block; }
        header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
        header h1 { font-size: 2.5rem; margin: 0; color: var(--text-primary); }
        header p { font-size: 1.1rem; color: var(--text-secondary); margin: 0; }
        .header-left { display: flex; flex-direction: column; }
        .card { background-color: var(--bg-white); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .card h2 { font-size: 1.5rem; margin-top: 0; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--grey-light); }
        .btn { font-family: var(--font-family); font-size: 1rem; font-weight: 600; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        .btn-primary { background-color: var(--blue); color: white; }
        .btn-primary:hover { background-color: #0056b3; transform: translateY(-2px); }
        .btn-secondary { background-color: var(--grey-mid); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--grey-dark); color: var(--bg-white); }
        .btn-danger { background-color: var(--red-light); color: var(--red); }
        .btn-danger:hover { background-color: var(--red); color: var(--bg-white); }
        .btn-small { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        .btn:disabled { background-color: var(--grey-mid); cursor: not-allowed; transform: none; }

        /* --- 5. Dashboard Page (Stats Grid) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
        .stat-card { background-color: var(--bg-white); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; align-items: flex-start; gap: 1rem; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
        .stat-icon { font-size: 2rem; padding: 0.75rem; border-radius: 8px; }
        .icon-pending { background-color: var(--orange-light); color: var(--orange); }
        .icon-transit { background-color: var(--blue-light); color: var(--blue); }
        .icon-delivered { background-color: var(--green-light); color: var(--green); }
        .icon-payment { background-color: var(--red-light); color: var(--red); }
        .stat-info h3 { margin: 0 0 0.25rem 0; font-size: 1rem; color: var(--text-secondary); font-weight: 500; }
        .stat-info .stat-value { margin: 0; font-size: 2.25rem; font-weight: 600; color: var(--text-primary); }
        
        /* --- 6. Styled Table (Used on multiple pages) --- */
        .table-container { width: 100%; overflow-x: auto; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .styled-table th, .styled-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--grey-mid); vertical-align: middle; }
        .styled-table th { color: var(--text-secondary); font-weight: 600; background-color: #fcfcfc; }
        .styled-table tbody tr:last-child td { border-bottom: none; }
        .styled-table tbody tr:hover { background-color: var(--grey-light); }
        .table-actions { display: flex; gap: 0.5rem; }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.8rem; font-weight: 600; border-radius: 12px; }
        .status-Pending { background-color: var(--orange-light); color: var(--orange); }
        .status-Shipped { background-color: var(--blue-light); color: var(--blue); }
        .status-Delivered { background-color: var(--green-light); color: var(--green); }
        .status-Not-Paid { background-color: var(--red-light); color: var(--red); }
        .status-Paid { background-color: var(--green-light); color: var(--green); }
        .status-Partially-Paid { background-color: var(--orange-light); color: var(--orange); }

        /* --- NEW CSS for status selects --- */
        .status-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            background-color: transparent;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            min-width: 110px; 
        }
        .status-select:focus { outline: none; box-shadow: 0 0 0 2px var(--blue-light); }
        
        .status-select.status-Pending { background-color: var(--orange-light); color: var(--orange); }
        .status-select.status-Shipped { background-color: var(--blue-light); color: var(--blue); }
        .status-select.status-Delivered { background-color: var(--green-light); color: var(--green); }
        
        .status-select.status-Not-Paid { background-color: var(--red-light); color: var(--red); }
        .status-select.status-Paid { background-color: var(--green-light); color: var(--green); }
        .status-select.status-Partially-Paid { background-color: var(--orange-light); color: var(--orange); }
        
        /* BATCH INPUT STYLE */
        .batch-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--grey-mid);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--blue);
            font-weight: 600;
            background-color: var(--bg-white);
        }


        /* --- 7. New Shipment Wizard --- */
        .stepper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 1rem; background-color: var(--bg-white); border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .step { display: flex; align-items: center; flex-direction: column; flex-grow: 1; position: relative; }
        .step:not(:last-child)::after { content: ''; position: absolute; top: 15px; left: 50%; width: 100%; height: 3px; background-color: var(--grey-mid); z-index: 1; }
        .step-icon { width: 30px; height: 30px; border-radius: 50%; background-color: var(--grey-mid); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-weight: 600; z-index: 2; transition: background-color 0.3s ease, color 0.3s ease; }
        .step-label { margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; transition: color 0.3s ease, font-weight 0.3s ease; }
        .step.active .step-icon { background-color: var(--blue); color: var(--bg-white); }
        .step.active .step-label { color: var(--blue); font-weight: 600; }
        .step.completed .step-icon { background-color: var(--green); color: var(--bg-white); }
        .step.completed .step-label { color: var(--text-primary); }
        .step.completed:not(:last-child)::after { background-color: var(--green); }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .wizard-nav { display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--grey-mid); }

        /* --- 8. Forms --- */
        .form-grid-two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-grid-three-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-group label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        .input-group input[type="text"], .input-group input[type="tel"], .input-group input[type="email"], .input-group input[type="number"], .input-group input[type="date"], .input-group select, .input-group textarea { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--grey-mid); border-radius: 8px; box-sizing: border-box; background-color: #fdfdfd; font-family: var(--font-family); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 2px var(--blue-light); }
        .input-group textarea { resize: vertical; min-height: 80px; }
        
        /* BATCH SUMMARY STYLE */
        .batch-summary-value {
             font-size: 1.5rem; 
             font-weight: 700; 
             color: var(--text-primary);
             padding: 0.4rem;
             background: var(--grey-light);
             border-radius: 8px;
        }

        /* --- 9. Summary/Review Page --- */
        .summary-grid { display: grid; grid-template-columns: 180px 1fr; gap: 0.75rem 1rem; font-size: 1rem; }
        .summary-grid strong { font-weight: 600; color: var(--text-secondary); text-align: right; }
        .summary-grid span { word-break: break-word; }
        .doc-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .review-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--grey-mid); }
        .review-section:last-child { border-bottom: none; }
        .review-section h3 { font-size: 1.2rem; color: var(--blue); margin-top: 0; }

        /* --- 10. Modal (UPDATED FOR MOBILE SCROLL) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            box-sizing: border-box;
            align-items: flex-start;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: auto; 
            position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--grey-mid); }
        .modal-header h2 { margin: 0; }
        .modal-header .close-btn { font-size: 2rem; font-weight: 300; cursor: pointer; background: none; border: none; line-height: 1; padding: 0; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--grey-mid); }
        
        /* --- 11. Payments & Batch Cards (Redesigned) --- */
        .filters-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        
        /* New Batch Card Container */
        .batch-card-container { display: flex; flex-direction: column; gap: 30px; }

        .batch-card {
            background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden; border: 1px solid #e2e8f0;
        }

        /* 1. Purple Header */
        .batch-card-header {
            background-color: #5856d6; color: white; padding: 12px 20px;
            font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 10px;
        }

        /* 2. Shipment Rows */
        .batch-shipment-row {
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr 1.5fr;
            align-items: center; padding: 15px 20px; border-bottom: 1px solid #f0f0f5; font-size: 0.9rem;
        }
        .batch-shipment-row:hover { background-color: #fcfcfc; }

        .bs-invoice { display: flex; flex-direction: column; }
        .bs-invoice strong { color: var(--blue); font-size: 0.95rem; }
        .bs-invoice span { color: #666; font-size: 0.8rem; margin-top: 2px; }
        .bs-weight { color: #888; font-weight: 500; }
        .bs-money { font-weight: 700; font-size: 1rem; color: #333; }

        /* 3. Financial Footer */
        .batch-financial-footer { padding: 20px; background-color: #f8f9fa; border-top: 1px solid #e2e8f0; }

        .financial-dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        .fin-card {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 160px;
        }

        .fin-head { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f5; }
        .head-blue { color: var(--blue); }
        .head-green { color: #006644; }
        .head-red { color: var(--red); }
        .head-purple { color: var(--purple); }

        .fin-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.85rem; color: #555; }
        
        .fin-input {
            width: 80px; text-align: right; padding: 4px; border: 1px solid #ccc;
            border-radius: 4px; font-weight: 700;
        }
        
        .fin-result { margin-top: auto; padding-top: 10px; border-top: 1px solid #eee; text-align: right; font-size: 1.1rem; font-weight: 800; }

        .batch-actions-bar { display: flex; justify-content: flex-end; margin-top: 15px; gap: 10px; }
        
        /* Note: Reusing these classes for compatibility */
        .btn-add-extra { background-color: var(--purple); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .notes-area { width: 100%; margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 0.9rem; }
        
        /* Status Badges Reuse */
        .status-badge-btn { display: inline-flex; align-items: center; justify-content: center; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; width: 80px; text-align: center; text-transform: uppercase; user-select: none; transition: transform 0.1s ease; }
        .status-badge-btn:active { transform: scale(0.95); }
        .badge-pending { background-color: var(--grey-mid); color: var(--text-secondary); }
        .badge-paid-cad { background-color: var(--green-light); color: var(--green); border: 1px solid var(--green-light); }
        .badge-paid-expense { background-color: var(--red-light); color: var(--red); border: 1px solid var(--red-light); }
        .badge-paid-income { background-color: var(--green-light); color: #006644; border: 1px solid var(--green-light); }

        @media (max-width: 900px) { .financial-dashboard-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 600px) { 
            .financial-dashboard-grid { grid-template-columns: 1fr; } 
            .batch-shipment-row { grid-template-columns: 1fr 1fr; gap: 10px; }
        }


        /* --- 12. Responsive (Mobile) --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 65px; bottom: 0; top: auto; left: 0; flex-direction: row; border-top: 1px solid #2d3748; }
            .sidebar-logo, .sidebar-bottom { display: none; }
            .sidebar-nav { display: flex; flex-direction: row; justify-content: space-around; width: 100%; height: 100%; margin: 0; padding: 0 0.5rem; }
            .sidebar-nav li { flex-grow: 1; }
            .sidebar-nav li a { flex-direction: column; justify-content: center; height: 100%; padding: 0.5rem 0.25rem; }
            .nav-icon { font-size: 1.25rem; width: auto; }
            .nav-text { opacity: 1; visibility: visible; font-size: 0.7rem; margin-left: 0; margin-top: 0.25rem; }
            
            .main-content { margin-left: 0; width: 100%; padding: 1rem; padding-bottom: 80px; }
            
            header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            header h1 { font-size: 1.8rem; }
            header p { font-size: 1rem; margin-bottom: 1rem; }
            
            .stats-grid, .form-grid-two-col, .form-grid-three-col, .payment-summary-grid { grid-template-columns: 1fr; }
            .stepper { padding: 1rem 0.5rem; }
            .step-label { font-size: 0.7rem; text-align: center; }
            .summary-grid { grid-template-columns: 100px 1fr; }
            .summary-grid strong { text-align: left; }
            
            .modal-content { width: 100%; padding: 1.5rem; margin: 0 auto; }
            .modal-overlay { padding: 10px; }
            .modal-footer { flex-direction: column; }
            .modal-footer .btn { width: 100%; }
            
            .input-group input, .input-group select, .input-group textarea { font-size: 16px; }
            .filters-bar { flex-direction: column; }
        }
        /* --- TOAST NOTIFICATIONS --- */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; background-color: #333; color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: space-between; animation: slideIn 0.3s ease-out forwards; font-size: 0.9rem; }
        .toast.success { background-color: var(--green); border-left: 5px solid #155724; }
        .toast.error { background-color: var(--red); border-left: 5px solid #721c24; }
        .toast.info { background-color: var(--blue); border-left: 5px solid #004085; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-logo">
            <img src="https://raw.githubusercontent.com/crickerr26/bee26cargomanager/main/BEE26.png" alt="Bee26 Cargo Logo" style="height: 40px; width: auto;">
        </div>
        <ul class="sidebar-nav">
            <li><a class="nav-link active" data-page="page-dashboard"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a></li>
            <li><a class="nav-link" data-page="page-new-shipment"><span class="nav-icon">‚ûï</span><span class="nav-text">New Shipment</span></a></li>
            <li><a class="nav-link" data-page="page-all-shipments"><span class="nav-icon">üöö</span><span class="nav-text">All Shipments</span></a></li>
            <li><a class="nav-link" data-page="page-customers"><span class="nav-icon">üë•</span><span class="nav-text">Customers</span></a></li>
            <li><a class="nav-link" data-page="page-payments"><span class="nav-icon">üí≥</span><span class="nav-text">Payments</span></a></li>
        </ul>
        <div class="sidebar-bottom">
            <ul class="sidebar-nav" style="margin: 0;"><li><a href="#"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-text">Settings</span></a></li></ul>
        </div>
    </nav>

    <main class="main-content">

        <header>
            <div class="header-left">
                <h1 id="page-title">Dashboard</h1>
                <p id="page-subtitle">Welcome back, here's an overview of your business.</p>
            </div>
            <button class="btn btn-primary" id="header-action-btn">+ Create New Shipment</button>
        </header>

        <div id="page-dashboard" class="page-content active">
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-icon icon-pending">üì¶</span><div class="stat-info"><h3>Pending Shipments</h3><div class="stat-value" id="stat-pending">0</div></div></div>
                <div class="stat-card"><span class="stat-icon icon-transit">‚úàÔ∏è</span><div class="stat-info"><h3>In Transit</h3><div class="stat-value" id="stat-transit">0</div></div></div>
                <div class="stat-card"><span class="stat-icon icon-delivered">‚úÖ</span><div class="stat-info"><h3>Delivered (All Time)</h3><div class="stat-value" id="stat-delivered">0</div></div></div>
                <div class="stat-card"><span class="stat-icon icon-payment">üí∞</span><div class="stat-info"><h3>Payments Due</h3><div class="stat-value" id="stat-due">$0</div></div></div>
            </div>
            <div class="card">
                <h2>Recent Activity</h2>
                <div class="table-container">
                    <table class="styled-table">
                        <thead><tr><th>Invoice #</th><th>Sender</th><th>Receiver</th><th>Status</th><th>Total</th></tr></thead>
                        <tbody id="recent-activity-tbody">
                            <tr><td colspan="5" style="text-align: center;">Loading data from Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-new-shipment" class="page-content">
             <div class="stepper">
                <div class="step active" data-step="1"><div class="step-icon">1</div><div class="step-label">Customer Info</div></div>
                <div class="step" data-step="2"><div class="step-icon">2</div><div class="step-label">Item Details</div></div>
                <div class="step" data-step="3"><div class="step-icon">3</div><div class="step-label">Shipment & Payment</div></div>
                <div class="step" data-step="4"><div class="step-icon">4</div><div class="step-label">Review & Docs</div></div>
            </div>
            <div id="step-1" class="step-content active">
                 <div class="card">
                    <h2>Sender Details (Canada)</h2>
                    <div class="form-grid-two-col">
                        <div class="input-group"><label for="senderName">Full Name</label><input type="text" id="senderName" placeholder="John Doe"></div>
                        <div class="input-group"><label for="senderPhone">Phone Number</label><input type="tel" id="senderPhone" placeholder="+1 416-123-4567"></div>
                        <div class="input-group"><label for="senderAddress">Address</label><input type="text" id="senderAddress" placeholder="123 Maple Ave, Toronto"></div>
                        <div class="input-group"><label for="senderNic">NIC / Drivers License No</label><input type="text" id="senderNic" placeholder="A1234-56789"></div>
                    </div>
                </div>
                <div class="card">
                    <h2>Receiver Details (Sri Lanka)</h2>
                    <div class="form-grid-two-col">
                        <div class="input-group"><label for="receiverName">Full Name</label><input type="text" id="receiverName" placeholder="Jane Smith"></div>
                        <div class="input-group"><label for="receiverPhone">Phone Number</label><input type="tel" id="receiverPhone" placeholder="+94 77-123-4567"></div>
                        <div class="input-group"><label for="receiverEmail">Email Address</label><input type="email" id="receiverEmail" placeholder="jane@example.com"></div>
                        <div class="input-group"><label for="receiverAddress">Address</label><textarea id="receiverAddress" rows="3" placeholder="No. 123, Main Street, Colombo 03"></textarea></div>
                        <div class="input-group"><label for="customerRemarks">Customer Remarks</label><textarea id="customerRemarks" rows="3" placeholder="Notes about this customer."></textarea></div>
                    </div>
                </div>
            </div>
            <div id="step-2" class="step-content">
                 <div class="card">
                    <h2>Itemized List</h2>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr><th>Image</th><th>Description</th><th>Condition</th><th>Brand</th><th>Country</th><th>Qty</th><th>Unit Value</th><th>Total Value</th><th>Actions</th></tr></thead>
                            <tbody id="itemTableTbody">
                                <tr><td colspan="9" style="text-align: center;">No items added yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="wizard-nav" style="justify-content: flex-end;">
                        <button class="btn btn-primary" id="addNewItemBtn">+ Add New Item</button>
                    </div>
                </div>
            </div>
             <div id="step-3" class="step-content">
                 <div class="card">
                    <h2>Shipment Details</h2>
                    <div class="form-grid-two-col">
                        <div class="input-group"><label for="totalPackages">Total Packages</label><input type="number" id="totalPackages" placeholder="e.g., 2" min="0"></div>
                        <div class="input-group"><label for="totalWeight">Total Weight (kg)</label><input type="text" id="totalWeight" placeholder="e.g., 14.5"></div>
                        <div class="input-group"><label for="invoiceNumber">Invoice Number</label><input type="text" id="invoiceNumber" placeholder="BEE26-1025"></div>
                        <div class="input-group"><label for="invoiceDate">Date</label><input type="date" id="invoiceDate"></div>
                        <div class="input-group"><label for="deliveryStatus">Delivery Status</label><select id="deliveryStatus"><option value="Pending">Pending</option><option value="Shipped">Shipped</option><option value="Delivered">Delivered</option></select></div>
                        <div class="input-group"><label for="hsCode">HS Code (Optional)</label><input type="text" id="hsCode" placeholder="e.g., 6109.10"></div>
                    </div>
                </div>
                <div class="card">
                    <h2>Payment Details</h2>
                    <div class="form-grid-two-col">
                        <div class="input-group"><label for="paymentTotal">Service Fee (CAD)</label><input type="number" id="paymentTotal" placeholder="0.00" min="0" step="0.01"></div>
                        <div class="input-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus"><option value="Not-Paid">Not Paid</option><option value="Paid">Paid</option><option value="Partially-Paid">Partially Paid</option></select></div>
                        <div class="input-group"><label for="amountPaid">Amount Paid (CAD)</label><input type="number" id="amountPaid" placeholder="0.00" min="0" step="0.01"></div>
                         <div class="input-group"><label for="paymentMethod">Payment Method</label><select id="paymentMethod"><option value="">N/A</option><option value="Cash">Cash</option><option value="E-Transfer">E-Transfer</option><option value="Card">Card</option></select></div>
                         
                         <div class="input-group" style="grid-column: 1 / -1;">
                             <label for="additionalChargesDesc">Additional Charges Description (Optional)</label>
                             <textarea id="additionalChargesDesc" rows="2" placeholder="e.g., Carton box charge, Special handling..."></textarea>
                         </div>
                         <div class="input-group">
                             <label for="additionalChargesAmt">Additional Charges Amount (CAD)</label>
                             <input type="number" id="additionalChargesAmt" placeholder="0.00" min="0" step="0.01">
                         </div>
                         </div>
                </div>
            </div>
            <div id="step-4" class="step-content">
                <div class="card">
                    <h2>Review Shipment</h2>
                    <div class="review-section">
                        <h3>Customer</h3>
                        <div class="form-grid-two-col">
                            <div><strong>Sender</strong><div class="summary-grid"><strong>Name:</strong> <span id="review-senderName">--</span><strong>Phone:</strong> <span id="review-senderPhone">--</span></div></div>
                            <div><strong>Receiver</strong><div class="summary-grid"><strong>Name:</strong> <span id="review-receiverName">--</span><strong>Phone:</strong> <span id="review-receiverPhone">--</span><strong>Email:</strong> <span id="review-receiverEmail">--</span><strong>Address:</strong> <span id="review-receiverAddress" style="white-space: pre-wrap;">--</span></div></div>
                        </div>
                    </div>
                    <div class="review-section">
                        <h3>Shipment & Payment</h3>
                        <div class="form-grid-two-col">
                            <div><strong>Shipment</strong><div class="summary-grid"><strong>Invoice #:</strong> <span id="review-invoiceNumber">--</span><strong>Packages:</strong> <span id="review-totalPackages">--</span><strong>Weight:</strong> <span id="review-totalWeight">--</span><strong>Status:</strong> <span id="review-deliveryStatus">--</span></div></div>
                            <div><strong>Payment</strong>
                                <div class="summary-grid">
                                    <strong>Service Fee:</strong> <span id="review-paymentTotal">--</span>
                                    <strong>Addt'l Charges:</strong> <span id="review-additionalCharges">--</span>
                                    <strong style="color:var(--blue);">Total Amount Due:</strong> <strong id="review-totalAmountDue" style="color:var(--blue); font-size: 1.1rem;">--</strong>
                                    <strong>Payment Status:</strong> <span id="review-paymentStatus">--</span>
                                    <strong>Amount Paid:</strong> <span id="review-amountPaid">--</span>
                                    <strong>Method:</strong> <span id="review-paymentMethod">--</span>
                                </div>
                            </div>
                            </div>
                    </div>
                    <div class="review-section">
                        <h3>Itemized List (<span id="review-itemCount">0</span> items) - Total Declared Value: <strong id="review-declaredTotal" style="color:var(--blue);">$0.00</strong></h3>
                        <div class="table-container">
                            <table class="styled-table">
                                <thead><tr><th>Image</th><th>Description</th><th>Condition</th><th>Brand</th><th>Country</th><th>Category</th><th>Qty</th><th>Total Value</th></tr></thead>
                                <tbody id="review-itemTableTbody">
                                    <tr><td colspan="8" style="text-align: center;">--</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>Generate Documents</h2>
                    <div class="doc-buttons">
                        <button class="btn btn-secondary" id="printPackingListBtn">Print Packing List</button>
                        <button class="btn btn-primary" id="exportInvoicePDF">Download Invoice (PDF)</button>
                        <button class="btn btn-secondary" style="background-color: #5856d6; color: white;" id="printConcernFormBtn">Concern Form (PDF)</button>
                        <button class="btn btn-secondary" id="exportPackingListExcel">Download Excel</button>
                        <button class="btn btn-secondary" id="printThermalLabelBtn">Print 4x6 Label</button>
                        <button class="btn btn-primary" style="background-color:#25D366;" id="shareWhatsAppBtn">Share on WhatsApp üí¨</button>
                    </div>
                </div>
            </div>
            <div class="wizard-nav">
                <button class="btn btn-secondary" id="prev-step" disabled>‚Üê Back</button>
                <button class="btn btn-primary" id="next-step">Next: Add Items ‚Üí</button>
            </div>
        </div> 
        
        <div id="page-all-shipments" class="page-content">
             
             <div class="card" style="border-left: 5px solid var(--purple);">
                <h2 style="color: var(--purple);">Batch Management</h2>
                <div class="filters-bar">
                    <div class="input-group" style="flex: 1; min-width: 200px;">
                        <label for="batchSelector">1. Select / Create Batch No</label>
                        <select id="batchSelector" style="font-weight: bold; color: var(--purple);">
                            <option value="">View All Shipments</option>
                            </select>
                    </div>
                    <div class="input-group" style="flex: 1; min-width: 150px;">
                        <label for="batchCostInput">2. Batch Cost (You Pay)</label>
                        <input type="number" id="batchCostInput" placeholder="0.00" step="0.01">
                    </div>
                    <div class="input-group" style="flex: 1; min-width: 150px;">
                        <label>3. Batch Payment (Collections)</label>
                        <div class="batch-summary-value" id="batchTotalCollections">$0.00</div>
                    </div>
                    <div class="input-group" style="flex: 1; min-width: 150px;">
                        <label>Est. Profit / Loss</label>
                        <div class="batch-summary-value" id="batchNetProfit" style="color: var(--grey-dark);">$0.00</div>
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    * Select a Batch No above to filter the table and see calculations.
                </p>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">All Shipments</h2>
                    <input type="text" id="allShipmentsSearch" placeholder="üîç Search Invoice, Name, or Phone..." 
                           style="padding: 10px; border: 1px solid var(--grey-mid); border-radius: 8px; width: 100%; max-width: 300px; font-size: 0.9rem;">
                </div>
                <div class="table-container">
                    <table class="styled-table">
                        <thead><tr><th>Invoice #</th><th style="width:140px;">Batch No</th><th>Date</th><th>Sender</th><th>Receiver</th><th>Weight</th><th>Total Amt</th><th>Status</th><th>Payment</th><th>Actions</th></tr></thead>
                        <tbody id="shipmentsTableTbody">
                            <tr><td colspan="10" style="text-align: center;">Loading data from Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-customers" class="page-content">
             <div class="card">
                <h2>Customer List</h2>
                <div class="table-container">
                    <table class="styled-table">
                        <thead><tr><th>Name (Sender)</th><th>Phone</th><th>Last Shipment</th><th>Total Shipments</th><th>Actions</th></tr></thead>
                        <tbody id="customersTableTbody">
                            <tr><td colspan="5" style="text-align: center;">Loading data from Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-payments" class="page-content">
            
            <div class="card" style="border-left: 5px solid var(--purple);">
                <h2 style="color: var(--purple);">Overall Batch Financials (Summary)</h2>
                <div class="payment-summary-grid">
                    <div class="payment-summary-card">
                        <h3>Total Batch Collections (Gained)</h3>
                        <div class="value" id="overall-batch-gained">$0.00</div>
                    </div>
                    <div class="payment-summary-card">
                        <h3>Total Batch Costs (Expenses)</h3>
                        <div class="value" id="overall-batch-cost">$0.00</div>
                    </div>
                    <div class="payment-summary-card">
                        <h3>Net Profit / Loss</h3>
                        <div class="value" id="overall-batch-profit" style="color: var(--grey-dark);">$0.00</div>
                    </div>
                </div>
                 <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0rem;">
                    * Calculated from all batches and shipments with assigned batch numbers.
                </p>
            </div>
            <div class="card">
                <h2>Filter Payments</h2>
                <div class="filters-bar">
                     <div class="input-group" style="flex-grow: 1;">
                        <label for="paymentSearch">Search Invoice # / Customer Name</label>
                        <input type="text" id="paymentSearch" placeholder="Search...">
                    </div>
                    <div class="input-group">
                        <label for="paymentStatusFilter">Filter by Status</label>
                        <select id="paymentStatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Not-Paid">Not Paid</option>
                            <option value="Partially-Paid">Partially Paid</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="payment-summary-grid">
                <div class="payment-summary-card">
                    <h3>Total Amount Due</h3>
                    <div class="value" id="payment-summary-due">$0.00</div>
                </div>
                <div class="payment-summary-card">
                    <h3>Total Amount Paid</h3>
                    <div class="value" id="payment-summary-paid">$0.00</div>
                </div>
                <div class="payment-summary-card">
                    <h3>Shipments Displayed</h3>
                    <div class="value" id="payment-summary-count">0</div>
                </div>
            </div>

            <div class="batch-card-container" id="paymentsContainer">
                <div style="text-align: center; padding: 40px; color: #888;">
                    Loading Batch Financials...
                </div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Item</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <form id="addItemForm">
                <div class="form-grid-two-col">
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="modalItemImage" style="display: block; margin-bottom: 5px; font-weight: 600;">Item Photo (Optional)</label>
                        <input type="file" id="modalItemImage" accept="image/jpeg, image/png" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                        <small style="color: #666;">Photo will be automatically compressed to save space.</small>
                        <div id="modalImagePreviewContainer" style="margin-top:10px; display:none;">
                            <img id="modalImagePreview" src="" alt="Preview" style="max-height: 100px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="modalItemDesc">Description</label>
                        <input type="text" id="modalItemDesc" placeholder="e.g., Men's T-Shirts" required>
                    </div>
                     <div class="input-group">
                        <div class="input-group">
    <label for="modalItemCat">Category</label>
    <select id="modalItemCat" required>
        <option value="">Select category...</option>
        <optgroup label="Apparel & Textiles">
            <option value="Clothing">Clothing</option>
            <option value="Footwear & Shoes">Footwear & Shoes</option>
            <option value="Fabrics & Textiles">Fabrics & Textiles</option>
            <option value="Kids Clothing">Kids Clothing</option>
        </optgroup>
        <optgroup label="Electronics & Media">
            <option value="Computers & Laptops">Computers & Laptops</option>
            <option value="Phones & Accessories">Phones & Accessories</option>
            <option value="Cameras & Equipment">Cameras & Equipment</option>
            <option value="Electronic Items">Electronic Items</option>
            <option value="Batteries / Power Banks">Batteries / Power Banks</option>
            <option value="Books & Media">Books & Media</option>
        </optgroup>
        <optgroup label="Food & Perishables">
            <option value="Packaged Food (Non-Perishable)">Packaged Food (Non-Perishable)</option>
            <option value="Perishables (Special Handling)">Perishables (Special Handling)</option>
            <option value="Liquids & Beverages">Liquids & Beverages</option>
        </optgroup>
        <optgroup label="Health & Beauty">
            <option value="Cosmetics & Toiletries">Cosmetics & Toiletries</option>
            <option value="Medicines & Vitamins">Medicines & Vitamins</option>
        </optgroup>
        <optgroup label="Household & Goods">
            <option value="Kitchenware">Kitchenware</option>
            <option value="Home Decor">Home Decor</option>
            <option value="Tools & Hardware">Tools & Hardware</option>
            <option value="Household Supplies">Household Supplies</option>
        </optgroup>
        <optgroup label="Personal Items & Gifts">
            <option value="Toys & Hobbies">Toys & Hobbies</option>
            <option value="Kids Toys">Kids Toys</option>
            <option value="Jewelry & Accessories">Jewelry & Accessories</option>
            <option value="Gifts & Souvenirs">Gifts & Souvenirs</option>
            <option value="Sports Equipment">Sports Equipment</option>
        </optgroup>
        <optgroup label="Documents & Special">
            <option value="Documents">Documents</option>
            <option value="Stationary">Stationary</option>
            <option value="Fragile Items">Fragile Items</option>
            <option value="Restricted / Special Handling">Restricted / Special Handling</option>
        </optgroup>
        <optgroup label="Other">
            <option value="General Merchandise">General Merchandise</option>
            <option value="Other">Other</option>
        </optgroup>
    </select>
</div>

<div class="input-group">
    <label for="modalItemHSCode">HS Code</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="modalItemHSCode" placeholder="e.g., 6109.10" style="flex-grow: 1;">
        <button type="button" class="btn btn-primary btn-small" id="generateHsBtn" style="white-space: nowrap;">‚ö° Generate</button>
    </div>
</div>
                     <div class="input-group">
                        <label for="modalItemQty">Quantity</label>
                        <input type="number" id="modalItemQty" placeholder="1" min="1" required>
                    </div>
                    <div class="input-group">
                        <label for="modalItemValue">Unit Value (CAD)</label>
                        <input type="number" id="modalItemValue" placeholder="15.00" min="0" step="0.01" required>
                    </div>

                    <div class="input-group">
                        <label for="modalItemCondition">Condition</label>
                        <select id="modalItemCondition" required>
                            <option value="New">New</option>
                            <option value="Used">Used</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="modalItemBrand">Brand Name</label>
                        <input type="text" id="modalItemBrand" placeholder="e.g., Nike, Apple, etc.">
                    </div>
                    <div class="input-group"> 
                        <label for="modalItemCountry">Manufacture Country</label>
                        <select id="modalItemCountry">
                            <option value="">Select country...</option>
                            <option value="Canada">üá®üá¶ Canada</option>
                            <option value="Sri Lanka">üá±üá∞ Sri Lanka</option>
                            <option value="USA">üá∫üá∏ USA</option>
                            <option value="UK">üá¨üáß UK</option>
                            <option value="India">üáÆüá≥ India</option>
                            <option value="China">üá®üá≥ China</option>
                            <option value="Germany">üá©üá™ Germany</option>
                            <option value="Japan">üáØüáµ Japan</option>
                            <option value="South Korea">üá∞üá∑ South Korea</option>
                            <option value="Australia">üá¶üá∫ Australia</option>
                            <option value="Bangladesh">üáßüá© Bangladesh</option>
                            <option value="Vietnam">üáªüá≥ Vietnam</option>
                            <option value="Turkey">üáπüá∑ Turkey</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="modalItemNote">Item Note (Optional)</label>
                        <input type="text" id="modalItemNote" placeholder="e.g., Serial number, specific color, etc.">
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelModalBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveItemBtn">Save Item</button>
                </div>
            </form>
        </div>
    </div>


    <script type="text/javascript"> 
        document.addEventListener('DOMContentLoaded', () => {
// --- TOAST NOTIFICATION FUNCTION ---
            window.showToast = function(message, type = 'success') {
                let container = document.querySelector('.toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<span>${message}</span><span style="margin-left:10px;cursor:pointer;opacity:0.7;" onclick="this.parentElement.remove()">‚úï</span>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.5s ease forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 3500);
            };
            // --- 0. Get Firebase Functions ---
            const db = window.db;
            const dbRef = window.dbRef;
            const dbUpdate = window.dbUpdate;
            const dbPush = window.dbPush;
            const dbOnValue = window.dbOnValue;
            const dbRemove = window.dbRemove; 
            const dbSet = window.dbSet;

            if (!db || !dbRef || !dbUpdate || !dbPush || !dbOnValue || !dbRemove) { 
                alert("FATAL ERROR: Firebase Database functions not found. Check initialization.");
                return;
            }

            // --- NEW: Image Handling Variables & Function ---
            const modalItemImageInput = document.getElementById('modalItemImage');
            const modalImagePreviewContainer = document.getElementById('modalImagePreviewContainer');
            const modalImagePreview = document.getElementById('modalImagePreview');
            let tempItemCompressedImage = null; // Stores the data URL ready for saving

            // Helper: Compress Image
            function compressImage(file, callback) {
                const maxWidth = 800; // Max dimension
                const quality = 0.6;  // 60% quality
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        } else {
                            if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Compress
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        callback(dataUrl);
                    };
                };
                reader.onerror = error => console.log(error);
            }

            // Listener for File Selection
            if(modalItemImageInput) {
                modalItemImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        compressImage(file, (compressedDataUrl) => {
                            tempItemCompressedImage = compressedDataUrl;
                            modalImagePreview.src = compressedDataUrl;
                            modalImagePreviewContainer.style.display = 'block';
                        });
                    } else {
                        tempItemCompressedImage = null;
                        modalImagePreview.src = '';
                        modalImagePreviewContainer.style.display = 'none';
                    }
                });
            }

            // --- App State ---
            let local_items = []; 
            let local_shipments_cache = []; 
            let local_batches_cache = {}; // Cache for batch costs
            let currentEditItemId = null;
            let currentEditShipmentId = null; 
            let wizardCurrentStep = 1;
            
            // --- NEW: DRAFT / AUTO-SAVE CONFIG ---
            const DRAFT_KEY = 'bee26_new_shipment_draft';

            // --- 1. Page Navigation (Sidebar) ---
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            const headerActionBtn = document.getElementById('header-action-btn');

            const pageMeta = {  
                 'page-dashboard': { title: 'Dashboard', subtitle: "Welcome back, here's an overview of your business.", actionText: '+ Create New Shipment', actionPage: 'page-new-shipment' },
                'page-new-shipment': { title: 'New Shipment', subtitle: 'Create a new shipment using the steps below.', actionText: null },
                'page-all-shipments': { title: 'All Shipments', subtitle: 'Search, filter, and manage all shipments.', actionText: '+ Create New Shipment', actionPage: 'page-new-shipment' },
                'page-customers': { title: 'Customers', subtitle: 'Manage your list of senders and receivers.', actionText: '+ Add New Customer', actionPage: 'page-new-shipment' }, 
                'page-payments': { title: 'Payments', subtitle: 'Track all pending and completed payments.', actionText: null }
            };

            function navigateToPage(pageId) {
                 if (pageId !== 'page-new-shipment') {
                     prevBtn.disabled = false;
                     nextBtn.disabled = false;
                 }

                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
                
                const meta = pageMeta[pageId];
                
                const isViewingOrEditing = pageTitle.textContent === 'Edit Shipment' || pageTitle.textContent === 'Review Shipment';
                if (meta && (!isViewingOrEditing || pageId !== 'page-new-shipment')) { 
                    pageTitle.textContent = meta.title;
                    pageSubtitle.textContent = meta.subtitle;
                } else if (meta && isViewingOrEditing && pageId === 'page-new-shipment') {
                    pageSubtitle.textContent = pageSubtitle.textContent || meta.subtitle; 
                }

                if (meta) { 
                    if (meta.actionText) {
                        headerActionBtn.textContent = meta.actionText;
                        headerActionBtn.style.display = 'block';
                        headerActionBtn.dataset.page = meta.actionPage;
                    } else {
                        headerActionBtn.style.display = 'none';
                    }
                }

                 if (pageId === 'page-payments') {
                    renderPaymentsTable(); 
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const page = e.currentTarget.dataset.page;
                    
                    // --- FIX: REMOVED THE FORCED "clearWizard()" HERE ---
                    // Now, switching tabs will simply hide/show the page 
                    // and keep your typed data intact.

                    // If we were editing/viewing a shipment and leave the page, reset the "Edit Mode" 
                    // so we don't get stuck, but DO NOT clear the form data if it's just a draft.
                    if((pageTitle.textContent === 'Edit Shipment' || pageTitle.textContent === 'Review Shipment') && page !== 'page-new-shipment') {
                         pageTitle.textContent = ''; 
                         currentEditShipmentId = null; 
                         // Note: We deliberately do NOT call clearWizard() here so draft data persists
                    }
                    
                    navigateToPage(page);
                });
            });
            
            // HEADER BUTTON LOGIC UPDATE
            headerActionBtn.addEventListener('click', (e) => {
                const page = e.currentTarget.dataset.page;
                // IF CLICKING "+ Create New Shipment", FORCE CLEAR
                if(page === 'page-new-shipment') {
                    clearWizard(); 
                }
                navigateToPage(page);
            });


            // --- 2. New Shipment Wizard ---
            const wizard = document.getElementById('page-new-shipment');
            const prevBtn = wizard.querySelector('#prev-step');
            const nextBtn = wizard.querySelector('#next-step');
            const steps = wizard.querySelectorAll('.step');
            const stepContents = wizard.querySelectorAll('.step-content');
            const totalSteps = 4;

            const nextLabels = [
                 'Next: Add Items ‚Üí',
                'Next: Shipment ‚Üí',
                'Next: Review ‚Üí',
                'Save & Finish Shipment'
            ];

            function updateWizard(jumpToStep = null) { 
                wizardCurrentStep = jumpToStep !== null ? jumpToStep : wizardCurrentStep;
                stepContents.forEach((content, index) => {
                    content.classList.toggle('active', (index + 1) === wizardCurrentStep);
                });
                steps.forEach((step, index) => {
                    const stepNum = index + 1;
                    step.classList.toggle('active', stepNum === wizardCurrentStep);
                    step.classList.toggle('completed', stepNum < wizardCurrentStep);
                });

                const isViewing = pageTitle.textContent === 'Review Shipment'; 

                prevBtn.disabled = (wizardCurrentStep === 1) || isViewing; 

                if (isViewing) {
                    nextBtn.disabled = true;
                    nextBtn.textContent = 'Viewing...';
                } else if (currentEditShipmentId !== null) { 
                    nextBtn.disabled = false;
                    nextBtn.textContent = (wizardCurrentStep === totalSteps) ? 'Update Shipment' : nextLabels[wizardCurrentStep - 1];
                } else { 
                    nextBtn.disabled = false;
                    nextBtn.textContent = nextLabels[wizardCurrentStep - 1];
                }

                if (wizardCurrentStep === 4) {
                    populateReviewStep();
                }
                
                // SAVE DRAFT ON STEP CHANGE
                saveDraft();
            }


            nextBtn.addEventListener('click', async () => { 
                 if (pageTitle.textContent === 'Review Shipment') return;

                if (wizardCurrentStep < totalSteps) {
                    wizardCurrentStep++;
                    updateWizard();
                } else {
                    nextBtn.disabled = true;
                    nextBtn.textContent = "Saving...";
                    await saveShipment(); 
                    nextBtn.disabled = false; 
                }
            });

            prevBtn.addEventListener('click', () => {
                 if (pageTitle.textContent === 'Review Shipment') return;
                 
                if (wizardCurrentStep > 1) {
                    wizardCurrentStep--;
                    updateWizard();
                }
            });

            function clearWizard() { 
                 const formInputs = wizard.querySelectorAll('input, textarea, select');
                formInputs.forEach(input => {
                    if (input.type === 'select-one') {
                        input.selectedIndex = 0; 
                    } else if (input.type !== 'date') { 
                        input.value = ''; 
                    }
                });
                document.getElementById('deliveryStatus').value = 'Pending';
                document.getElementById('paymentStatus').value = 'Not-Paid';
                document.getElementById('invoiceDate').valueAsDate = new Date(); 
                
                document.getElementById('additionalChargesDesc').value = '';
                document.getElementById('additionalChargesAmt').value = '';

                local_items = []; 
                currentEditItemId = null;
                currentEditShipmentId = null; 

                // Reset page title if we were editing
                if (pageTitle.textContent === 'Edit Shipment' || pageTitle.textContent === 'Review Shipment') {
                     const meta = pageMeta['page-new-shipment'];
                     pageTitle.textContent = meta.title;
                     pageSubtitle.textContent = meta.subtitle;
                     prevBtn.disabled = false;
                     nextBtn.disabled = false;
                }
                
                wizardCurrentStep = 1;
                renderItemTable();
                updateWizard(); 
                
                // IMPORTANT: When explicitly clearing, remove the draft from storage
                localStorage.removeItem(DRAFT_KEY);
            }
            
            // --- NEW DRAFT FUNCTIONS ---
            
            function saveDraft() {
                // Do not save draft if we are editing an existing Firebase record or viewing one
                if (currentEditShipmentId !== null || pageTitle.textContent === 'Review Shipment') return;

                const draft = {
                    senderName: document.getElementById('senderName').value,
                    senderPhone: document.getElementById('senderPhone').value,
                    // NEW FIELDS
                    senderAddress: document.getElementById('senderAddress').value,
                    senderNic: document.getElementById('senderNic').value,
                    
                    receiverName: document.getElementById('receiverName').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    receiverEmail: document.getElementById('receiverEmail').value,
                    receiverAddress: document.getElementById('receiverAddress').value,
                    customerRemarks: document.getElementById('customerRemarks').value,
                    
                    // Step 3
                    totalPackages: document.getElementById('totalPackages').value,
                    totalWeight: document.getElementById('totalWeight').value,
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    deliveryStatus: document.getElementById('deliveryStatus').value,
                    hsCode: document.getElementById('hsCode').value,
                    
                    // Payment
                    paymentTotal: document.getElementById('paymentTotal').value,
                    paymentStatus: document.getElementById('paymentStatus').value,
                    amountPaid: document.getElementById('amountPaid').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    additionalChargesDesc: document.getElementById('additionalChargesDesc').value,
                    additionalChargesAmt: document.getElementById('additionalChargesAmt').value,
                    
                    // Items & Step
                    items: local_items,
                    wizardStep: wizardCurrentStep
                };
                
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
            }
            
            function restoreDraft() {
                // If we are editing/viewing, do not restore draft
                if (currentEditShipmentId !== null) return;
                
                const draftJson = localStorage.getItem(DRAFT_KEY);
                if (!draftJson) return; // No draft found
                
                try {
                    const draft = JSON.parse(draftJson);
                    
                    document.getElementById('senderName').value = draft.senderName || '';
                    document.getElementById('senderPhone').value = draft.senderPhone || '';
                    // NEW FIELDS
                    document.getElementById('senderAddress').value = draft.senderAddress || '';
                    document.getElementById('senderNic').value = draft.senderNic || '';

                    document.getElementById('receiverName').value = draft.receiverName || '';
                    document.getElementById('receiverPhone').value = draft.receiverPhone || '';
                    document.getElementById('receiverEmail').value = draft.receiverEmail || '';
                    document.getElementById('receiverAddress').value = draft.receiverAddress || '';
                    document.getElementById('customerRemarks').value = draft.customerRemarks || '';
                    
                    document.getElementById('totalPackages').value = draft.totalPackages || '';
                    document.getElementById('totalWeight').value = draft.totalWeight || '';
                    document.getElementById('invoiceNumber').value = draft.invoiceNumber || '';
                    if(draft.invoiceDate) document.getElementById('invoiceDate').value = draft.invoiceDate;
                    document.getElementById('deliveryStatus').value = draft.deliveryStatus || 'Pending';
                    document.getElementById('hsCode').value = draft.hsCode || '';
                    
                    document.getElementById('paymentTotal').value = draft.paymentTotal || '';
                    document.getElementById('paymentStatus').value = draft.paymentStatus || 'Not-Paid';
                    document.getElementById('amountPaid').value = draft.amountPaid || '';
                    document.getElementById('paymentMethod').value = draft.paymentMethod || '';
                    document.getElementById('additionalChargesDesc').value = draft.additionalChargesDesc || '';
                    document.getElementById('additionalChargesAmt').value = draft.additionalChargesAmt || '';
                    
                    local_items = draft.items || [];
                    
                    // Restore step
                    if (draft.wizardStep && draft.wizardStep >= 1 && draft.wizardStep <= 4) {
                        wizardCurrentStep = draft.wizardStep;
                    } else {
                        wizardCurrentStep = 1;
                    }
                    
                    renderItemTable(); // Updates table UI
                    updateWizard();    // Updates Step UI
                    
                } catch (e) {
                    console.error("Error restoring draft:", e);
                }
            }
            
            // Attach Draft Listeners
            const wizardInputs = wizard.querySelectorAll('input, textarea, select');
            wizardInputs.forEach(input => {
               input.addEventListener('input', saveDraft);
               input.addEventListener('change', saveDraft);
            });
            // We also need to listen for dynamically added items (handled in renderItemTable)

            // --- 3. Item CRUD (Manages local_items array) ---
            const modal = document.getElementById('addItemModal');
            const addNewItemBtn = document.getElementById('addNewItemBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const addItemForm = document.getElementById('addItemForm');
            const itemTableTbody = document.getElementById('itemTableTbody');
            
            addNewItemBtn.addEventListener('click', () => { 
                currentEditItemId = null;
                addItemForm.reset();
                // Clear image inputs on new item
                modalItemImageInput.value = '';
                tempItemCompressedImage = null;
                modalImagePreview.src = '';
                modalImagePreviewContainer.style.display = 'none';

                document.getElementById('modal-title').textContent = 'Add New Item';
                document.getElementById('saveItemBtn').textContent = 'Save Item';
                modal.classList.add('active');
            });
            
            function closeModal() { 
                modal.classList.remove('active');
                // Clear image inputs on close
                if(modalItemImageInput) modalItemImageInput.value = '';
                tempItemCompressedImage = null;
                if(modalImagePreview) modalImagePreview.src = '';
                if(modalImagePreviewContainer) modalImagePreviewContainer.style.display = 'none';
            }
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            
            addItemForm.addEventListener('submit', (e) => { 
    e.preventDefault();
    const item = {
        desc: document.getElementById('modalItemDesc').value,
        category: document.getElementById('modalItemCat').value,
        // NEW LINE ADDED HERE:
        hsCode: document.getElementById('modalItemHSCode').value,
        // -------------------
        // ADDED Image Data:
        image: tempItemCompressedImage || null,
        // -------------------
        qty: parseFloat(document.getElementById('modalItemQty').value),
        value: parseFloat(document.getElementById('modalItemValue').value),
        condition: document.getElementById('modalItemCondition').value,
        brand: document.getElementById('modalItemBrand').value,
        country: document.getElementById('modalItemCountry').value,
        note: document.getElementById('modalItemNote').value 
    };
    
    // ... rest of the saving logic stays the same ...
    if (currentEditItemId !== null) {
        local_items[currentEditItemId] = item; 
    } else {
        local_items.push(item); 
    }
    renderItemTable();
    closeModal();
});

            function renderItemTable() { 
                itemTableTbody.innerHTML = '';
                if (local_items.length === 0) {
                    itemTableTbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No items added yet.</td></tr>';
                } else {
                    local_items.forEach((item, index) => {
                        const totalVal = (item.qty * item.value).toFixed(2);
                        // Image Thumbnail Logic
                        const imgHtml = item.image ? `<img src="${item.image}" alt="item" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #eee;">` : '<span style="color:#ccc;">No img</span>';

                        const row = document.createElement('tr');
                        row.innerHTML = `
    <td style="text-align: center;">${imgHtml}</td>
    <td>
        ${item.desc} 
        ${item.hsCode ? '<br><span class="status-badge status-Shipped" style="font-size:0.7rem; padding: 2px 6px;">HS: ' + item.hsCode + '</span>' : ''}
        ${item.note ? '<br><small style="color:#666">Note: '+item.note+'</small>' : ''}
    </td>
    <td>${item.condition || '--'}</td>
    <td>${item.brand || '--'}</td>
    <td>${item.country || '--'}</td>
    <td>${item.qty}</td>
    <td>$${item.value.toFixed(2)}</td>
    <td>$${totalVal}</td>
    <td class="table-actions">
        <button class="btn btn-secondary btn-small edit-item-btn" data-index="${index}">Edit</button>
        <button class="btn btn-danger btn-small delete-item-btn" data-index="${index}">Del</button>
    </td>
`;
                        itemTableTbody.appendChild(row);
                    });
                }
                
                // SAVE DRAFT WHENEVER ITEMS CHANGE
                saveDraft();
            }

            itemTableTbody.addEventListener('click', (e) => { 
                // Fix for delete button not working on item clicks
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) {
                    const index = deleteBtn.dataset.index;
                    if (confirm('Are you sure you want to delete this item?')) {
                        local_items.splice(index, 1);
                        renderItemTable();
                    }
                    return; // Stop here
                }

                const editBtn = e.target.closest('.edit-item-btn');
                if (editBtn) {
                    const index = editBtn.dataset.index;
                    const item = local_items[index];
                    currentEditItemId = index;
                    document.getElementById('modal-title').textContent = 'Edit Item';
                    document.getElementById('saveItemBtn').textContent = 'Update Item';
                    document.getElementById('modalItemDesc').value = item.desc;
                    document.getElementById('modalItemCat').value = item.category;
                    document.getElementById('modalItemQty').value = item.qty;
                    document.getElementById('modalItemValue').value = item.value;
                    document.getElementById('modalItemCondition').value = item.condition || 'New';
                    document.getElementById('modalItemBrand').value = item.brand || '';
                    document.getElementById('modalItemCountry').value = item.country || '';
                    // ...
                    document.getElementById('modalItemNote').value = item.note || ''; 
                    // NEW LINE ADDED HERE:
                    document.getElementById('modalItemHSCode').value = item.hsCode || ''; 
                    // -------------------
                    
                    // LOAD IMAGE FOR EDIT
                    if (item.image) {
                        tempItemCompressedImage = item.image;
                        modalImagePreview.src = item.image;
                        modalImagePreviewContainer.style.display = 'block';
                    } else {
                        tempItemCompressedImage = null;
                        modalImagePreview.src = '';
                        modalImagePreviewContainer.style.display = 'none';
                    }

                    modal.classList.add('active');
                }
            });


            // --- 4. Shipment Save, Review, and Load (FIREBASE CONNECTED) ---
            
            function populateReviewStep() { 
                // Customer
                document.getElementById('review-senderName').textContent = document.getElementById('senderName').value || '--';
                document.getElementById('review-senderPhone').textContent = document.getElementById('senderPhone').value || '--';
                document.getElementById('review-receiverName').textContent = document.getElementById('receiverName').value || '--';
                document.getElementById('review-receiverPhone').textContent = document.getElementById('receiverPhone').value || '--';
                document.getElementById('review-receiverAddress').textContent = document.getElementById('receiverAddress').value || '--';
                // Shipment
                document.getElementById('review-invoiceNumber').textContent = document.getElementById('invoiceNumber').value || '--';
                document.getElementById('review-totalPackages').textContent = document.getElementById('totalPackages').value || '--';
                document.getElementById('review-totalWeight').textContent = document.getElementById('totalWeight').value ? document.getElementById('totalWeight').value + ' kg' : '--';
                document.getElementById('review-deliveryStatus').innerHTML = `<span class="status-badge status-${document.getElementById('deliveryStatus').value}">${document.getElementById('deliveryStatus').value}</span>`;
                
                const paymentTotal = parseFloat(document.getElementById('paymentTotal').value) || 0; // Service Fee
                const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0; 
                const paymentMethod = document.getElementById('paymentMethod').value || 'N/A';
                const additionalChargesAmt = parseFloat(document.getElementById('additionalChargesAmt').value) || 0;
                const totalAmountDue = paymentTotal + additionalChargesAmt;

                document.getElementById('review-paymentTotal').textContent = `$${paymentTotal.toFixed(2)}`;
                document.getElementById('review-additionalCharges').textContent = `$${additionalChargesAmt.toFixed(2)}`;
                document.getElementById('review-totalAmountDue').textContent = `$${totalAmountDue.toFixed(2)}`;
                document.getElementById('review-paymentStatus').innerHTML = `<span class="status-badge status-${document.getElementById('paymentStatus').value.replace(' ','-')}">${document.getElementById('paymentStatus').value.replace('-',' ')}</span>`;
                document.getElementById('review-amountPaid').textContent = `$${amountPaid.toFixed(2)}`; 
                document.getElementById('review-paymentMethod').textContent = paymentMethod; 
                
                document.getElementById('review-itemCount').textContent = local_items.length;
                const reviewTbody = document.getElementById('review-itemTableTbody');
                reviewTbody.innerHTML = '';
                let declaredTotal = 0;
                
                if (local_items.length === 0) {
                    reviewTbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">--</td></tr>';
                } else {
                    local_items.forEach(item => {
                        const itemTotal = (parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0);
                        declaredTotal += itemTotal;
                        // Image Thumbnail Logic
                        const imgHtml = item.image ? `<img src="${item.image}" alt="item" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #eee;">` : '<span style="color:#ccc;">No img</span>';

                        reviewTbody.innerHTML += `
                            <tr>
                                <td style="text-align: center;">${imgHtml}</td>
                                <td>${item.desc}</td>
                                <td>${item.condition || '--'}</td>
                                <td>${item.brand || '--'}</td>
                                <td>${item.country || '--'}</td>
                                <td>${item.category}</td>
                                <td>${item.qty}</td>
                                <td>$${itemTotal.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('review-declaredTotal').textContent = `$${declaredTotal.toFixed(2)}`;
            }

            async function saveShipment() { 
                const shipment = {
                    senderName: document.getElementById('senderName').value,
                    senderPhone: document.getElementById('senderPhone').value,
                    // NEW FIELDS
                    senderAddress: document.getElementById('senderAddress').value,
                    senderNic: document.getElementById('senderNic').value,

                    receiverName: document.getElementById('receiverName').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    receiverAddress: document.getElementById('receiverAddress').value,
                    customerRemarks: document.getElementById('customerRemarks').value,
                    totalPackages: document.getElementById('totalPackages').value,
                    totalWeight: document.getElementById('totalWeight').value,
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    deliveryStatus: document.getElementById('deliveryStatus').value,
                    hsCode: document.getElementById('hsCode').value,
                    paymentTotal: document.getElementById('paymentTotal').value || '0', 
                    paymentStatus: document.getElementById('paymentStatus').value,
                    amountPaid: document.getElementById('amountPaid').value || '0', 
                    paymentMethod: document.getElementById('paymentMethod').value || '',
                    additionalChargesDesc: document.getElementById('additionalChargesDesc').value || '',
                    additionalChargesAmt: document.getElementById('additionalChargesAmt').value || '0',
                    items: [...local_items] 
                };

                try {
                    if (currentEditShipmentId !== null) {
                        const shipmentRef = dbRef(db, 'shipments/' + currentEditShipmentId);
                        await dbUpdate(shipmentRef, shipment);
                        window.showToast('Shipment ' + shipment.invoiceNumber + ' updated successfully!', 'success');
                    } else {
                        const shipmentListRef = dbRef(db, 'shipments');
                        await dbPush(shipmentListRef, shipment);
                        window.showToast('Shipment ' + shipment.invoiceNumber + ' saved successfully!', 'success');
                    }
                    
                    // SUCCESS: Clear wizard and clear local draft
                    clearWizard(); 
                    // clearWizard already calls localStorage.removeItem, but let's be safe
                    localStorage.removeItem(DRAFT_KEY);
                    
                    navigateToPage('page-all-shipments');
                } catch (error) {
                    console.error("Error saving shipment to Firebase:", error);
                    alert("Error: Could not save shipment. See console for details.");
                }
            }

            function _populateWizardWithData(shipment) {
                 if (!shipment) return false;

                clearWizard(); 

                document.getElementById('senderName').value = shipment.senderName || '';
                document.getElementById('senderPhone').value = shipment.senderPhone || '';
                // NEW FIELDS
                document.getElementById('senderAddress').value = shipment.senderAddress || '';
                document.getElementById('senderNic').value = shipment.senderNic || '';

                document.getElementById('receiverName').value = shipment.receiverName || '';
                document.getElementById('receiverPhone').value = shipment.receiverPhone || '';
                document.getElementById('receiverAddress').value = shipment.receiverAddress || '';
                document.getElementById('customerRemarks').value = shipment.customerRemarks || '';
                document.getElementById('totalPackages').value = shipment.totalPackages || '';
                document.getElementById('totalWeight').value = shipment.totalWeight || '';
                document.getElementById('invoiceNumber').value = shipment.invoiceNumber || '';
                document.getElementById('invoiceDate').value = shipment.invoiceDate || '';
                document.getElementById('deliveryStatus').value = shipment.deliveryStatus || 'Pending';
                document.getElementById('hsCode').value = shipment.hsCode || '';
                document.getElementById('paymentTotal').value = shipment.paymentTotal || '';
                document.getElementById('paymentStatus').value = shipment.paymentStatus || 'Not-Paid';
                document.getElementById('amountPaid').value = shipment.amountPaid || '0';
                document.getElementById('paymentMethod').value = shipment.paymentMethod || '';

                document.getElementById('additionalChargesDesc').value = shipment.additionalChargesDesc || '';
                document.getElementById('additionalChargesAmt').value = shipment.additionalChargesAmt || '';

                local_items = [...(shipment.items || [])];
                renderItemTable();
                return true; 
            }

            function loadShipmentForEdit(shipmentId) {
                const shipment = local_shipments_cache.find(s => s.id === shipmentId);
                if (!_populateWizardWithData(shipment)) {
                     alert("Error: Could not find shipment to load for editing."); return;
                }
                currentEditShipmentId = shipmentId; 

                const pageId = 'page-new-shipment';
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');

                pageTitle.textContent = 'Edit Shipment';
                pageSubtitle.textContent = 'Editing Invoice #' + (shipment.invoiceNumber || 'N/A');
                headerActionBtn.style.display = 'none'; 

                updateWizard(1); 
            }

            function loadShipmentForView(shipmentId) {
                 const shipment = local_shipments_cache.find(s => s.id === shipmentId);
                 if (!_populateWizardWithData(shipment)) {
                     alert("Error: Could not find shipment to load for viewing."); return;
                 }
                 currentEditShipmentId = null; 

                 const pageId = 'page-new-shipment';
                 pages.forEach(p => p.classList.remove('active'));
                 document.getElementById(pageId).classList.add('active');
                 navLinks.forEach(l => l.classList.remove('active'));
                 document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');

                 pageTitle.textContent = 'Review Shipment';
                 pageSubtitle.textContent = 'Viewing Invoice #' + (shipment.invoiceNumber || 'N/A');
                 headerActionBtn.style.display = 'none'; 

                 updateWizard(4); 
            }


            // --- 5. Data Table Rendering & Batch Logic ---
            const shipmentsTableTbody = document.getElementById('shipmentsTableTbody');
            const customersTableTbody = document.getElementById('customersTableTbody');
            const recentActivityTbody = document.getElementById('recent-activity-tbody');
            const paymentsContainer = document.getElementById('paymentsContainer');

            // Batch UI Elements
            const batchSelector = document.getElementById('batchSelector');
            const batchCostInput = document.getElementById('batchCostInput');
            const batchTotalCollections = document.getElementById('batchTotalCollections');
            const batchNetProfit = document.getElementById('batchNetProfit');

            // POPULATE BATCH DROPDOWN (1 to 50)
            function populateBatchDropdowns() {
                const frag = document.createDocumentFragment();
                for(let i=1; i<=50; i++) {
                    const num = i.toString().padStart(2, '0');
                    const option = document.createElement('option');
                    option.value = `Batch - ${num}`;
                    option.textContent = `Batch - ${num}`;
                    frag.appendChild(option);
                }
                // Append to Filter Selector
                batchSelector.appendChild(frag);
            }
            populateBatchDropdowns();

            // HELPER: Generate Select HTML for Table Row
            function generateBatchSelectHTML(currentBatchValue) {
                let options = `<option value="">--</option>`;
                for(let i=1; i<=50; i++) {
                    const num = i.toString().padStart(2, '0');
                    const val = `Batch - ${num}`;
                    const isSelected = (currentBatchValue === val) ? 'selected' : '';
                    options += `<option value="${val}" ${isSelected}>${val}</option>`;
                }
                return options;
            }

            function renderShipmentsTable() {
                // Ensure Header has Batch No
                const tableHeader = document.querySelector('#page-all-shipments .styled-table thead tr');
                if (tableHeader) {
                    tableHeader.innerHTML = '<th>Invoice #</th><th style="width:140px;">Batch No</th><th>Date</th><th>Sender</th><th>Receiver</th><th>Weight</th><th>Total Amt</th><th>Status</th><th>Payment</th><th>Actions</th>';
                }

                 shipmentsTableTbody.innerHTML = '';
                if (local_shipments_cache.length === 0) {
                    shipmentsTableTbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No shipments created yet.</td></tr>'; 
                    return;
                }
                
                // FILTER LOGIC
                const selectedBatchFilter = batchSelector.value;
                let filteredShipments = [...local_shipments_cache].sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate));
                
                if (selectedBatchFilter) {
                    filteredShipments = filteredShipments.filter(s => s.batchNo === selectedBatchFilter);
                    if (filteredShipments.length === 0) {
                         shipmentsTableTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">No shipments found in <strong>${selectedBatchFilter}</strong>.</td></tr>`; 
                         return;
                    }
                }

                const updateSelectColor = (select) => {
                    select.className = 'status-select'; 
                    select.classList.add(`status-${select.value.replace(' ','-')}`);
                };

                filteredShipments.forEach(shipment => {
                    const row = document.createElement('tr');
                    
                    const serviceFee = parseFloat(shipment.paymentTotal) || 0;
                    const additionalCharges = parseFloat(shipment.additionalChargesAmt) || 0;
                    const totalAmount = serviceFee + additionalCharges;

                    // Delivery Status
                    const deliveryStatusSelect = document.createElement('select');
                    deliveryStatusSelect.className = 'status-select';
                    deliveryStatusSelect.dataset.id = shipment.id;
                    deliveryStatusSelect.dataset.field = 'deliveryStatus';
                    deliveryStatusSelect.innerHTML = `
                        <option value="Pending" ${shipment.deliveryStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Shipped" ${shipment.deliveryStatus === 'Shipped' ? 'selected' : ''}>Shipped</option>
                        <option value="Delivered" ${shipment.deliveryStatus === 'Delivered' ? 'selected' : ''}>Delivered</option>
                    `;
                    updateSelectColor(deliveryStatusSelect); 
                    deliveryStatusSelect.onchange = () => updateSelectColor(deliveryStatusSelect); 

                    // Payment Status
                    const paymentStatusSelect = document.createElement('select');
                    paymentStatusSelect.className = 'status-select';
                    paymentStatusSelect.dataset.id = shipment.id;
                    paymentStatusSelect.dataset.field = 'paymentStatus';
                    paymentStatusSelect.innerHTML = `
                        <option value="Not-Paid" ${shipment.paymentStatus === 'Not-Paid' ? 'selected' : ''}>Not Paid</option>
                        <option value="Partially-Paid" ${shipment.paymentStatus === 'Partially-Paid' ? 'selected' : ''}>Partially Paid</option>
                        <option value="Paid" ${shipment.paymentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                    `;
                    updateSelectColor(paymentStatusSelect); 
                    paymentStatusSelect.onchange = () => updateSelectColor(paymentStatusSelect); 

                    // Batch SELECT (Dropdown)
                    const batchSelect = document.createElement('select');
                    batchSelect.className = 'batch-select';
                    batchSelect.dataset.id = shipment.id;
                    batchSelect.innerHTML = generateBatchSelectHTML(shipment.batchNo);
                    
                    // Format Weight
                    const weightDisplay = shipment.totalWeight ? `${shipment.totalWeight} kg` : '--';

                    // Format Date (Shorten: Remove first 2 digits of year, e.g., 2025-12-01 -> 25-12-01)
                    let shortDate = shipment.invoiceDate;
                    if(shortDate && shortDate.length === 10) {
                        shortDate = shortDate.substring(2); 
                    }

                    row.innerHTML = `
                        <td>${shipment.invoiceNumber}</td>
                        <td></td> <td style="white-space: nowrap;">${shortDate}</td>
                        <td>${shipment.senderName}</td>
                        <td>${shipment.receiverName}</td>
                        <td>${weightDisplay}</td> <td class="number-cell">$${totalAmount.toFixed(2)}</td> 
                    `;
                    
                    // Insert Batch Select into 2nd cell
                    row.cells[1].appendChild(batchSelect);

                    const deliveryTd = document.createElement('td');
                    deliveryTd.appendChild(deliveryStatusSelect);
                    row.appendChild(deliveryTd);
                    
                    const paymentTd = document.createElement('td');
                    paymentTd.appendChild(paymentStatusSelect);
                    row.appendChild(paymentTd);

                    // FIXED: Create actions cell as an element to preserve functionality
                    const actionsTd = document.createElement('td');
                    actionsTd.className = 'table-actions';
                    actionsTd.innerHTML = `
                        <button class="btn btn-secondary btn-small view-invoice-btn" data-id="${shipment.id}">View Invoice</button>
                        <button class="btn btn-secondary btn-small view-shipment-btn" data-id="${shipment.id}">View</button>
                        <button class="btn btn-primary btn-small edit-shipment-btn" data-id="${shipment.id}">Edit</button>
                        <button class="btn btn-danger btn-small delete-shipment-btn" data-id="${shipment.id}">Delete</button>
                    `;
                    row.appendChild(actionsTd);

                    shipmentsTableTbody.appendChild(row);
                });
                
                // Recalculate if a batch is selected
                calculateBatchTotals();
            }

            // --- BATCH CALCULATIONS LOGIC ---
            function calculateBatchTotals() {
                const selectedBatch = batchSelector.value.trim();
                if (!selectedBatch) {
                    batchCostInput.value = '';
                    batchTotalCollections.textContent = '$0.00';
                    batchNetProfit.textContent = '$0.00';
                    batchNetProfit.style.color = 'var(--grey-dark)';
                    return;
                }

                // 1. Calculate Total Collections (Sum of Shipments in this Batch)
                const shipmentsInBatch = local_shipments_cache.filter(s => s.batchNo === selectedBatch);
                let totalCollections = 0;
                shipmentsInBatch.forEach(s => {
                    const serviceFee = parseFloat(s.paymentTotal) || 0;
                    const extras = parseFloat(s.additionalChargesAmt) || 0;
                    totalCollections += (serviceFee + extras);
                });
                
                // 2. Get Batch Cost from Cache
                const batchData = local_batches_cache[selectedBatch] || {};
                const cost = parseFloat(batchData.cost) || 0;
                
                // Update Inputs (only update input if not focused to avoid cursor jumping)
                if (document.activeElement !== batchCostInput) {
                    batchCostInput.value = cost > 0 ? cost.toFixed(2) : '';
                }

                // 3. Calculate Profit
                const profit = totalCollections - cost;

                // Update UI
                batchTotalCollections.textContent = `$${totalCollections.toFixed(2)}`;
                batchNetProfit.textContent = `$${profit.toFixed(2)}`;
                
                if (profit > 0) {
                    batchNetProfit.style.color = 'var(--green)';
                } else if (profit < 0) {
                    batchNetProfit.style.color = 'var(--red)';
                } else {
                    batchNetProfit.style.color = 'var(--grey-dark)';
                }
            }
            
            // Listeners for Batch Actions
            batchSelector.addEventListener('change', () => {
                renderShipmentsTable(); // This calls calculateBatchTotals internally
            });
            
            // Save Batch Cost when changed
            batchCostInput.addEventListener('change', async (e) => {
                const batchName = batchSelector.value.trim();
                const costVal = parseFloat(e.target.value);
                
                if (!batchName) {
                    alert("Please select a Batch No first.");
                    return;
                }
                
                // Save to Firebase path: batches/{batchName}
                // sanitize batch name for path (no ., #, $, [, ])
                const safeBatchName = batchName.replace(/[.#$\[\]]/g, "_");
                
                try {
                    const batchRef = dbRef(db, 'batches/' + safeBatchName);
                    await dbSet(batchRef, { cost: costVal });
                    // Local cache update will happen via onValue listener
                } catch (err) {
                    console.error("Error saving batch cost", err);
                }
            });

            shipmentsTableTbody.addEventListener('change', async (e) => {
                // Handling Status Change
                if (e.target.classList.contains('status-select')) {
                    const shipmentId = e.target.dataset.id;
                    const field = e.target.dataset.field;
                    const value = e.target.value;

                    if (!shipmentId || !field) return;

                    try {
                        const shipmentRef = dbRef(db, 'shipments/' + shipmentId);
                        const updateData = {};
                        updateData[field] = value;
                        await dbUpdate(shipmentRef, updateData);
                    } catch (error) {
                        console.error("Error updating status:", error);
                    }
                }
                // Handling Batch No Change inside Table
                else if (e.target.classList.contains('batch-select')) {
                    const shipmentId = e.target.dataset.id;
                    const newBatch = e.target.value;
                    
                    try {
                        const shipmentRef = dbRef(db, 'shipments/' + shipmentId);
                        await dbUpdate(shipmentRef, { batchNo: newBatch });
                        // Recalculate totals will happen on data reload
                    } catch (error) {
                        console.error("Error updating batch:", error);
                    }
                }
            });

            shipmentsTableTbody.addEventListener('click', (e) => {
                // FIXED: Use closest('button') to ensuring clicking the button works perfectly
                const btn = e.target.closest('button');
                if (!btn) return;

                const shipmentId = btn.dataset.id;
                if (!shipmentId) return; 

                if (btn.classList.contains('edit-shipment-btn')) {
                    loadShipmentForEdit(shipmentId); 
                }
                else if (btn.classList.contains('view-shipment-btn')) {
                     loadShipmentForView(shipmentId); 
                }
                else if (btn.classList.contains('view-invoice-btn')) {
                     viewShipmentInvoice(shipmentId); 
                }
                else if (btn.classList.contains('delete-shipment-btn')) {
                    const shipment = local_shipments_cache.find(s => s.id === shipmentId);
                    const invoiceNum = shipment ? shipment.invoiceNumber : 'this shipment';

                    if (confirm(`Are you sure you want to permanently delete Invoice #${invoiceNum}?`)) {
                        deleteShipment(shipmentId);
                    }
                }
            });
            function viewShipmentInvoice(shipmentId) {
                const shipment = local_shipments_cache.find(s => s.id === shipmentId);
                if (!_populateWizardWithData(shipment)) {
                     alert("Error: Could not find shipment data to generate PDF.");
                    return;
                }
                generatePDF('Commercial Invoice', 'open');
            }

            async function deleteShipment(shipmentId) {
                if (!shipmentId) return;
                try {
                    const shipmentRef = dbRef(db, 'shipments/' + shipmentId);
                    await dbRemove(shipmentRef); 
                    alert('Shipment deleted successfully.');
                } catch (error) {
                    console.error("Error deleting shipment:", error);
                    alert("Error: Could not delete shipment. See console for details.");
                }
            }
            
            function renderCustomersTable() { 
                customersTableTbody.innerHTML = '';
                const customers = new Map(); 
                local_shipments_cache.forEach(s => {
                    if (!s.senderName || !s.senderPhone) return;
                    if (customers.has(s.senderPhone)) {
                        const customer = customers.get(s.senderPhone);
                        customer.totalShipments += 1;
                        if (new Date(s.invoiceDate) > new Date(customer.lastShipment)) {
                            customer.lastShipment = s.invoiceDate;
                        }
                    } else {
                        customers.set(s.senderPhone, {
                            name: s.senderName, phone: s.senderPhone, lastShipment: s.invoiceDate, totalShipments: 1
                        });
                    }
                });
                if (customers.size === 0) {
                    customersTableTbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No customers found.</td></tr>';
                    return;
                }
                customers.forEach(cust => {
                    customersTableTbody.innerHTML += `
                        <tr>
                            <td>${cust.name}</td><td>${cust.phone}</td><td>${cust.lastShipment || 'N/A'}</td>
                            <td>${cust.totalShipments}</td><td class="table-actions"><button class="btn btn-secondary btn-small">View</button></td>
                        </tr>`;
                });
            }

            function updateDashboardStats() { 
                 let pending = 0, transit = 0, delivered = 0, due = 0;
                local_shipments_cache.forEach(s => {
                    if (s.deliveryStatus === 'Pending') pending++;
                    if (s.deliveryStatus === 'Shipped') transit++; 
                    if (s.deliveryStatus === 'Delivered') delivered++;
                    if (s.paymentStatus === 'Not-Paid' || s.paymentStatus === 'Partially-Paid') {
                         const total = parseFloat(s.paymentTotal) || 0;
                         const paid = parseFloat(s.amountPaid) || 0;
                         due += (total - paid); 
                    }
                });
                document.getElementById('stat-pending').textContent = pending;
                document.getElementById('stat-transit').textContent = transit;
                document.getElementById('stat-delivered').textContent = delivered;
                document.getElementById('stat-due').textContent = `$${due.toFixed(0)}`;
                recentActivityTbody.innerHTML = '';
                const recent = [...local_shipments_cache].sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate)).slice(0, 3);
                if (recent.length === 0) {
                    recentActivityTbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No recent activity.</td></tr>'; return;
                }
                recent.forEach(s => {
                    recentActivityTbody.innerHTML += `
                        <tr><td>${s.invoiceNumber}</td><td>${s.senderName}</td><td>${s.receiverName}</td>
                        <td><span class="status-badge status-${s.deliveryStatus}">${s.deliveryStatus}</span></td>
                        <td>$${parseFloat(s.paymentTotal || 0).toFixed(2)}</td></tr>`;
                });
            }


        // --- 6. Payments Page Logic & Batch Calculator (Editable Extras) ---
            const paymentSearchInput = document.getElementById('paymentSearch');
            const paymentStatusFilterSelect = document.getElementById('paymentStatusFilter');

            // --- A. CUSTOM ADD EXTRA MODAL LOGIC ---
            if (!document.getElementById('customExtraModal')) {
                const modalHTML = `
                <div id="customExtraModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                    <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:350px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
                        <h3 style="margin-top:0; color:var(--purple);">Add Extra Item</h3>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <button type="button" class="btn-type-select active" data-type="Income" onclick="selectExtraType(this)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:#e6f2ff; color:var(--blue); font-weight:bold;">Income</button>
                            <button type="button" class="btn-type-select" data-type="Expense" onclick="selectExtraType(this)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:white; color:#666;">Expense</button>
                        </div>
                        <input type="text" id="extraDetailInput" placeholder="Detail (e.g. Taxi, Bonus)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; box-sizing:border-box;">
                        <input type="number" id="extraAmountInput" placeholder="Amount (LKR)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px; box-sizing:border-box;">
                        <div style="display:flex; justify-content:flex-end; gap:10px;">
                            <button onclick="closeExtraModal()" style="padding:8px 16px; border:none; background:#eee; border-radius:6px; cursor:pointer;">Cancel</button>
                            <button onclick="saveExtraItem()" style="padding:8px 16px; border:none; background:var(--purple); color:white; border-radius:6px; cursor:pointer; font-weight:bold;">Add</button>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            let currentBatchForExtra = null;
            let currentExtraType = 'Income';

            window.selectExtraType = (btn) => {
                document.querySelectorAll('.btn-type-select').forEach(b => {
                    b.style.background = 'white'; b.style.color = '#666'; b.classList.remove('active');
                });
                btn.style.background = btn.dataset.type === 'Income' ? '#e6f2ff' : '#fff1f0';
                btn.style.color = btn.dataset.type === 'Income' ? 'var(--blue)' : 'var(--red)';
                btn.classList.add('active');
                currentExtraType = btn.dataset.type;
            };

            window.addBatchExtra = (batchKey) => {
                currentBatchForExtra = batchKey;
                document.getElementById('extraDetailInput').value = '';
                document.getElementById('extraAmountInput').value = '';
                selectExtraType(document.querySelector('.btn-type-select[data-type="Income"]'));
                document.getElementById('customExtraModal').style.display = 'flex';
                document.getElementById('extraDetailInput').focus();
            };

            window.closeExtraModal = () => {
                document.getElementById('customExtraModal').style.display = 'none';
                currentBatchForExtra = null;
            };

            window.saveExtraItem = async () => {
                const desc = document.getElementById('extraDetailInput').value;
                const amtVal = parseFloat(document.getElementById('extraAmountInput').value);
                if(!desc || isNaN(amtVal) || !currentBatchForExtra) { alert("Invalid details."); return; }
                const finalAmount = currentExtraType === 'Expense' ? -Math.abs(amtVal) : Math.abs(amtVal);
                const safeKey = currentBatchForExtra.replace(/[.#$\[\]]/g, "_");
                try { await dbPush(dbRef(db, `batches/${safeKey}/extras`), { desc, amount: finalAmount }); closeExtraModal(); } 
                catch(e) { console.error(e); alert("Failed to save extra."); }
            };

            // --- B. EDIT MODE HANDLER (Supports Text & Number) ---
            window.enableBatchEdit = (element) => {
                if (element.querySelector('input')) return;
                
                const currentValue = element.dataset.value;
                const field = element.dataset.field;
                const batchKey = element.dataset.batch;
                const type = element.dataset.type || 'number'; // Default number

                const input = document.createElement('input');
                input.type = type; 
                input.value = currentValue;
                
                // Styling based on type
                if (type === 'text') {
                    input.style.width = '120px';
                    input.style.textAlign = 'left';
                } else {
                    input.style.width = '80px';
                    input.style.textAlign = 'right';
                }
                
                input.style.padding = '2px 4px';
                input.style.borderRadius = '4px';
                input.style.border = '1px solid var(--blue)';
                input.style.fontSize = 'inherit';
                input.style.fontWeight = 'bold';
                
                const save = async () => {
                    let newVal = input.value;
                    if (newVal === currentValue) { renderPaymentsTable(); return; }
                    
                    // Parse number if needed
                    if (type === 'number') {
                        newVal = parseFloat(newVal);
                        if (isNaN(newVal)) newVal = 0;
                    }

                    const safeKey = batchKey.replace(/[.#$\[\]]/g, "_");
                    try { 
                        const u={}; 
                        u[field] = newVal; 
                        await dbUpdate(dbRef(db, 'batches/' + safeKey), u); 
                    } 
                    catch(err) { console.error(err); renderPaymentsTable(); }
                };

                input.addEventListener('blur', save);
                input.addEventListener('keydown', (e) => { if(e.key === 'Enter') input.blur(); });

                element.innerHTML = '';
                element.appendChild(input);
                input.focus();
            };

            // --- C. TOGGLE STATUS ---
            window.togglePaymentStatus = async (id, currentStatus) => {
                try { await dbUpdate(dbRef(db, 'shipments/' + id), { paymentStatus: currentStatus === 'Paid' ? 'Not-Paid' : 'Paid' }); } catch (e) {}
            };
            window.toggleSLStatus = async (id, field, currentBool) => {
                try { const u={}; u[field] = !currentBool; await dbUpdate(dbRef(db, 'shipments/' + id), u); } catch (e) {}
            };
            window.deleteBatchExtra = async (batchKey, extraId) => {
                const safeKey = batchKey.replace(/[.#$\[\]]/g, "_");
                if(confirm("Delete this extra?")) await dbRemove(dbRef(db, `batches/${safeKey}/extras/${extraId}`));
            };

            // --- D. RENDER LOGIC ---
            function renderPaymentsTable() {
                const container = document.getElementById('paymentsContainer');
                if (!container) return;
                container.innerHTML = ''; 

                const searchTerm = paymentSearchInput.value.toLowerCase();
                const statusFilter = paymentStatusFilterSelect.value;

                let filteredShipments = local_shipments_cache.filter(s => {
                    const nameMatch = (s.senderName?.toLowerCase().includes(searchTerm) || s.receiverName?.toLowerCase().includes(searchTerm) || s.invoiceNumber?.toLowerCase().includes(searchTerm));
                    const statusMatch = (statusFilter === 'All' || s.paymentStatus === statusFilter);
                    return nameMatch && statusMatch;
                });

                if (filteredShipments.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">No shipments match search.</div>';
                    return;
                }

                // Group by Batch
                const batches = {};
                filteredShipments.forEach(s => {
                    const batchKey = s.batchNo ? s.batchNo : 'Unassigned';
                    if (!batches[batchKey]) batches[batchKey] = [];
                    batches[batchKey].push(s);
                });

                const sortedKeys = Object.keys(batches).sort().reverse();

                sortedKeys.forEach(batchKey => {
                    const shipments = batches[batchKey];
                    shipments.sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate));
                    const safeBatchKey = batchKey.replace(/[.#$\[\]]/g, "_");
                    const batchData = local_batches_cache[safeBatchKey] || local_batches_cache[batchKey] || {};

                    // 1. CAD
                    let totalCADCollected = 0;
                    shipments.forEach(s => totalCADCollected += (parseFloat(s.paymentTotal)||0) + (parseFloat(s.additionalChargesAmt)||0));
                    const batchCostCAD = parseFloat(batchData.batchCostCAD) || 0;
                    const profitCAD = totalCADCollected - batchCostCAD;

                    // 2. Delivery (LKR)
                    let totalDelCollected = 0;
                    let pendingDelivery = 0;
                    shipments.forEach(s => {
                        const chg = parseFloat(s.slDeliveryCharge) || 0;
                        if(s.slDeliveryPaid === true) totalDelCollected += chg; else pendingDelivery += chg;
                    });
                    const manualDelCost = parseFloat(batchData.manualDeliveryTotal) || 0;
                    const profitDel = totalDelCollected - manualDelCost;

                    // 3. Clearance (LKR)
                    let totalClrCollected = 0;
                    let pendingClearance = 0;
                    shipments.forEach(s => {
                        const cost = parseFloat(s.slClearanceCost) || 0;
                        if(s.slClearancePaid === true) totalClrCollected += cost; else pendingClearance += cost;
                    });
                    const manualClrCost = parseFloat(batchData.manualClearanceTotal) || 0;
                    const profitClr = totalClrCollected - manualClrCost;

                    // 4. Extras (Editable)
                    let extrasTotal = 0;
                    const extrasObj = batchData.extras || {};
                    let extrasHtml = '';
                    for(const [eId, eData] of Object.entries(extrasObj)) {
                        const amt = parseFloat(eData.amount || 0);
                        extrasTotal += amt;
                        // EDITABLE ROWS
                        extrasHtml += `
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; padding:3px 0; border-bottom:1px dashed #eee; align-items:center;">
                                <span style="cursor:pointer; border-bottom:1px dotted #ccc;" 
                                      data-batch="${batchKey}" 
                                      data-field="extras/${eId}/desc" 
                                      data-value="${eData.desc}" 
                                      data-type="text"
                                      onclick="window.enableBatchEdit(this)">
                                    ${eData.desc}
                                </span>
                                <div>
                                    <span style="font-weight:bold; cursor:pointer; color:${amt>=0?'green':'red'}; border-bottom:1px dotted #ccc;"
                                          data-batch="${batchKey}" 
                                          data-field="extras/${eId}/amount" 
                                          data-value="${amt}" 
                                          data-type="number"
                                          onclick="window.enableBatchEdit(this)">
                                        ${amt}
                                    </span>
                                    <span style="cursor:pointer; margin-left:8px; color:#999;" onclick="window.deleteBatchExtra('${batchKey}','${eId}')">√ó</span>
                                </div>
                            </div>`;
                    }

                    // 5. NET LKR
                    const netLKR = profitDel + profitClr + extrasTotal;

                    // --- UI BUILD ---
                    const card = document.createElement('div');
                    card.className = 'batch-card';
                    card.style.marginBottom = "30px";
                    card.style.border = "1px solid #e0e0e0";
                    card.style.boxShadow = "0 4px 12px rgba(0,0,0,0.05)";
                    card.style.borderRadius = "10px";
                    card.style.overflow = "hidden";
                    card.style.background = "#fff";

                    card.innerHTML = `
                        <div style="background:linear-gradient(90deg, #5856d6, #4c4aba); color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700; font-size:1.05rem;">üì¶ ${batchKey}</span>
                            <span style="font-size:0.85rem; opacity:0.9;">${shipments.length} Shipments</span>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:15px; padding:20px; background:#f8f9fa; border-bottom:1px solid #eee;">
                            
                            <div style="background:white; border:1px solid #e0e0e0; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.02);">
                                <div style="font-size:0.7rem; font-weight:800; color:#5856d6; text-transform:uppercase; margin-bottom:10px; border-bottom:2px solid #5856d6; padding-bottom:5px;">Batch Payment (CAD)</div>
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;"><span>Collected:</span> <strong>$${totalCADCollected.toFixed(2)}</strong></div>
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:10px;">
                                    <span>Batch Cost:</span> <span style="cursor:pointer; border-bottom:1px dashed #999;" data-batch="${batchKey}" data-field="batchCostCAD" data-value="${batchCostCAD}" data-type="number" onclick="window.enableBatchEdit(this)">$${batchCostCAD.toFixed(2)}</span>
                                </div>
                                <div style="text-align:right; font-size:1.2rem; font-weight:800; color:${profitCAD>=0?'var(--blue)':'var(--red)'}; padding-top:8px; border-top:1px solid #f0f0f0;">Profit: $${profitCAD.toFixed(2)}</div>
                            </div>

                            <div style="background:white; border:1px solid #e0e0e0; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.02);">
                                <div style="font-size:0.7rem; font-weight:800; color:#006644; text-transform:uppercase; margin-bottom:10px; border-bottom:2px solid #006644; padding-bottom:5px;">Delivery (Income)</div>
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;"><span>Collected:</span> <strong style="color:#006644;">${totalDelCollected.toLocaleString()}</strong></div>
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;">
                                    <span>Cost:</span> <span style="cursor:pointer; border-bottom:1px dashed #999;" data-batch="${batchKey}" data-field="manualDeliveryTotal" data-value="${manualDelCost}" data-type="number" onclick="window.enableBatchEdit(this)">${manualDelCost.toLocaleString()}</span>
                                </div>
                                <div style="font-size:0.75rem; color:#e67e22; margin-bottom:10px;">Pending: ${pendingDelivery.toLocaleString()}</div>
                                <div style="text-align:right; font-size:1.2rem; font-weight:800; color:${profitDel>=0?'#006644':'var(--red)'}; padding-top:8px; border-top:1px solid #f0f0f0;">Net: ${profitDel.toLocaleString()}</div>
                            </div>

                            <div style="background:white; border:1px solid #e0e0e0; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.02);">
                                <div style="font-size:0.7rem; font-weight:800; color:var(--red); text-transform:uppercase; margin-bottom:10px; border-bottom:2px solid var(--red); padding-bottom:5px;">Custom Clearance</div>
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;"><span>Collected:</span> <strong style="color:#006644;">${totalClrCollected.toLocaleString()}</strong></div>
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;">
                                    <span>Charge:</span> <span style="cursor:pointer; border-bottom:1px dashed #999;" data-batch="${batchKey}" data-field="manualClearanceTotal" data-value="${manualClrCost}" data-type="number" onclick="window.enableBatchEdit(this)">${manualClrCost.toLocaleString()}</span>
                                </div>
                                <div style="font-size:0.75rem; color:#e67e22; margin-bottom:10px;">Pending: ${pendingClearance.toLocaleString()}</div>
                                <div style="text-align:right; font-size:1.2rem; font-weight:800; color:${profitClr>=0?'#006644':'var(--red)'}; padding-top:8px; border-top:1px solid #f0f0f0;">Net: ${profitClr.toLocaleString()}</div>
                            </div>

                            <div style="background:white; border:1px solid #e0e0e0; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.02); display:flex; flex-direction:column;">
                                <div style="font-size:0.7rem; font-weight:800; color:var(--purple); text-transform:uppercase; margin-bottom:10px; border-bottom:2px solid var(--purple); padding-bottom:5px;">Total Net (LKR)</div>
                                <div style="display:flex; justify-content:space-between; font-size:0.8rem; padding:2px 0; border-bottom:1px solid #f9f9f9; margin-bottom:4px;">
                                    <span style="color:#666;">Delivery Profit</span>
                                    <span style="font-weight:600; color:${profitDel>=0?'#006644':'var(--red)'}">${profitDel.toLocaleString()}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; font-size:0.8rem; padding:2px 0; border-bottom:1px solid #f9f9f9; margin-bottom:8px;">
                                    <span style="color:#666;">Clearance Profit</span>
                                    <span style="font-weight:600; color:${profitClr>=0?'#006644':'var(--red)'}">${profitClr.toLocaleString()}</span>
                                </div>
                                <div style="flex-grow:1; max-height:60px; overflow-y:auto; margin-bottom:5px;">
                                    ${extrasHtml || '<div style="font-size:0.75rem; color:#ccc; font-style:italic;">No extras added</div>'}
                                </div>
                                <div style="text-align:right; font-size:1.3rem; font-weight:800; color:${netLKR>=0?'var(--purple)':'var(--red)'}; padding-top:8px; border-top:1px solid #f0f0f0;">LKR ${netLKR.toLocaleString()}</div>
                                <div style="text-align:right; margin-top:5px;">
                                    <button onclick="window.addBatchExtra('${batchKey}')" style="background:none; border:none; color:var(--blue); font-size:0.8rem; font-weight:bold; cursor:pointer;">+ Add Extra</button>
                                </div>
                            </div>
                        </div>
                    `;

                    // TABLE
                    const tableWrapper = document.createElement('div');
                    tableWrapper.style.overflowX = 'auto';
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.fontSize = '0.85rem';

                    table.innerHTML = `
                        <thead>
                            <tr style="background:#fff; border-bottom:2px solid #eee;">
                                <th style="padding:12px 15px; text-align:left; color:#5856d6;">Invoice / Name</th>
                                <th style="padding:12px 15px; text-align:left; color:#666;">Weight</th>
                                <th style="padding:12px 15px; text-align:left; color:#666;">Shipping (CAD)</th>
                                <th style="padding:12px 15px; text-align:left; color:#666;">Payment Status</th>
                                <th style="padding:12px 15px; text-align:left; color:#666;">Clearance (LKR)</th>
                                <th style="padding:12px 15px; text-align:left; color:#666;">Delivery (LKR)</th>
                            </tr>
                        </thead>
                    `;
                    
                    const tbody = document.createElement('tbody');
                    shipments.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #f5f5f5';

                        const totalAmt = (parseFloat(s.paymentTotal)||0) + (parseFloat(s.additionalChargesAmt)||0);
                        const isPaid = s.paymentStatus === 'Paid';
                        const isDelPaid = s.slDeliveryPaid === true;
                        const isClrPaid = s.slClearancePaid === true;

                        const td1 = document.createElement('td'); td1.style.padding='12px 15px'; td1.innerHTML=`<div style="font-weight:700; color:#333; font-size:0.95rem;">${s.invoiceNumber}</div><div style="font-size:0.8rem; color:#888;">${s.senderName}</div>`; tr.appendChild(td1);
                        const td2 = document.createElement('td'); td2.style.padding='12px 15px'; td2.textContent=`${s.totalWeight||0} kg`; tr.appendChild(td2);
                        const td3 = document.createElement('td'); td3.style.padding='12px 15px'; td3.innerHTML=`<strong>$${totalAmt.toFixed(2)}</strong>`; tr.appendChild(td3);
                        const td4 = document.createElement('td'); td4.style.padding='12px 15px'; td4.innerHTML=`<span style="padding:4px 10px; border-radius:4px; font-weight:bold; font-size:0.75rem; cursor:pointer; background:${isPaid?'#d4edda':'#f8d7da'}; color:${isPaid?'#155724':'#721c24'};" onclick="window.togglePaymentStatus('${s.id}','${s.paymentStatus}')">${isPaid?'PAID':'UNPAID'}</span>`; tr.appendChild(td4);
                        
                        const td5 = document.createElement('td'); td5.style.padding='12px 15px'; 
                        td5.innerHTML=`<div style="display:flex; align-items:center; gap:8px;"><div style="position:relative;"><span style="font-size:0.7rem; color:#999; position:absolute; left:4px; top:50%; transform:translateY(-50%);">LKR</span><input type="number" class="payment-update" data-id="${s.id}" data-field="slClearanceCost" value="${s.slClearanceCost||''}" placeholder="0" style="padding:4px 4px 4px 28px; width:70px; border:1px solid #ddd; border-radius:4px;"></div><span style="padding:4px 8px; border-radius:4px; font-weight:bold; font-size:0.7rem; cursor:pointer; background:${isClrPaid?'#ffebee':'#f0f0f5'}; color:${isClrPaid?'#c62828':'#666'};" onclick="window.toggleSLStatus('${s.id}','slClearancePaid', ${isClrPaid})">${isClrPaid?'PAID':'PENDING'}</span></div>`; tr.appendChild(td5);

                        const td6 = document.createElement('td'); td6.style.padding='12px 15px';
                        td6.innerHTML=`<div style="display:flex; align-items:center; gap:8px;"><div style="position:relative;"><span style="font-size:0.7rem; color:#999; position:absolute; left:4px; top:50%; transform:translateY(-50%);">LKR</span><input type="number" class="payment-update" data-id="${s.id}" data-field="slDeliveryCharge" value="${s.slDeliveryCharge||''}" placeholder="0" style="padding:4px 4px 4px 28px; width:70px; border:1px solid #ddd; border-radius:4px;"></div><span style="padding:4px 8px; border-radius:4px; font-weight:bold; font-size:0.7rem; cursor:pointer; background:${isDelPaid?'#e8f5e9':'#f0f0f5'}; color:${isDelPaid?'#2e7d32':'#666'};" onclick="window.toggleSLStatus('${s.id}','slDeliveryPaid', ${isDelPaid})">${isDelPaid?'REC\'D':'PENDING'}</span></div>`; tr.appendChild(td6);

                        tbody.appendChild(tr);
                    });

                    table.appendChild(tbody);
                    tableWrapper.appendChild(table);
                    card.appendChild(tableWrapper);

                    const noteDiv = document.createElement('div');
                    noteDiv.style.padding = '15px';
                    noteDiv.style.borderTop = '1px solid #eee';
                    noteDiv.style.background = '#fcfcfc';
                    noteDiv.innerHTML = `<textarea class="batch-field-update" data-batch="${batchKey}" data-field="notes" placeholder="Batch Notes..." style="width:100%; border:1px solid #e0e0e0; border-radius:6px; padding:10px; font-size:0.9rem; height:50px; resize:none;">${batchData.notes || ''}</textarea>`;
                    card.appendChild(noteDiv);

                    container.appendChild(card);
                });
            }

            // --- EVENT LISTENERS ---
            paymentsContainer.addEventListener('change', async (e) => {
                if (e.target.classList.contains('payment-update')) {
                    const id = e.target.dataset.id;
                    const field = e.target.dataset.field;
                    const val = parseFloat(e.target.value);
                    if(!id || !field) return;
                    try { const u={}; u[field]=isNaN(val)?0:val; await dbUpdate(dbRef(db,'shipments/'+id), u); } catch(e){}
                }
                if (e.target.classList.contains('batch-field-update') && e.target.tagName === 'TEXTAREA') {
                    const batchKey = e.target.dataset.batch;
                    const safeKey = batchKey.replace(/[.#$\[\]]/g, "_");
                    try { await dbUpdate(dbRef(db, 'batches/' + safeKey), { notes: e.target.value }); } catch(e){}
                }
            });


            // --- 7. PDF & Excel Export Functions ---
            let fetchedLogoBase64 = null;
            async function fetchLogoAsBase64() { 
                if (fetchedLogoBase64) return fetchedLogoBase64;
                const logoUrl = 'https://raw.githubusercontent.com/crickerr26/bee26cargomanager/main/BEE26.png'; 
                try {
                    const response = await fetch(logoUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => { fetchedLogoBase64 = reader.result; resolve(fetchedLogoBase64); };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error('Error fetching or converting logo:', error);
                    return null;
                }
            }

            let fetchedSealBase64 = null;
            async function fetchSealAsBase64() { 
                if (fetchedSealBase64) return fetchedSealBase64;
                const sealUrl = 'https://raw.githubusercontent.com/crickerr26/bee26cargomanager/main/Bee26%20Compay%20Seal.png'; 
                try {
                    const response = await fetch(sealUrl);
                    if (!response.ok) { return null; }
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => { fetchedSealBase64 = reader.result; resolve(fetchedSealBase64); };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) { return null; }
            }

            function addPdfFooter(doc) { 
                if (!doc || typeof doc.setFontSize !== 'function') return;
                 try {
                     doc.setFontSize(9); doc.setFont("helvetica", "normal");
                     const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
                     const pageCount = doc.internal.getNumberOfPages();
                     for (let i = 1; i <= pageCount; i++) {
                         doc.setPage(i);
                         doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, pageHeight - 5, { align: 'center' });
                         doc.text("Bee26 Cargo Services ‚Ä¢ Toronto ‚Ä¢ +1 416-474-4994", doc.internal.pageSize.width / 2, pageHeight - 12, { align: "center" });
                     }
                 } catch (error) { console.error("Error adding PDF footer:", error); }
            }

            async function generatePDF(docType, action = 'save') { 
                 let pdfWindow = null;
                if (action === 'open') {
                    pdfWindow = window.open('', '_blank');
                    if (pdfWindow) { pdfWindow.document.write('<html><head><title>Loading PDF...</title></head><body><p>Please wait while the PDF is generated...</p></body></html>'); } else { alert('Pop-up blocked!'); return; }
                }
                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) { throw new Error("jsPDF library not loaded."); }
                    const doc = new jsPDF('p', 'pt', 'a4');
                    
                    const logoBase64Data = await fetchLogoAsBase64();
                    const sealBase64Data = await fetchSealAsBase64(); 
                    
                    const senderName = document.getElementById('senderName').value, receiverName = document.getElementById('receiverName').value;
                    const receiverPhone = document.getElementById('receiverPhone').value, receiverAddress = document.getElementById('receiverAddress').value;
                    const invoiceNumber = document.getElementById('invoiceNumber').value, invoiceDate = document.getElementById('invoiceDate').value;
                    const hsCode = document.getElementById('hsCode').value, totalPackages = document.getElementById('totalPackages').value;
                    const totalWeight = document.getElementById('totalWeight').value;
                    
                    const serviceFee = parseFloat(document.getElementById('paymentTotal').value) || 0;
                    const additionalCharges = parseFloat(document.getElementById('additionalChargesAmt').value) || 0;
                    const additionalChargesDesc = document.getElementById('additionalChargesDesc').value.trim() || 'Additional Charges'; 
                    const totalAmountDue = serviceFee + additionalCharges;
                    
                    const safeItems = Array.isArray(local_items) ? [...local_items] : [];
                    safeItems.sort((a, b) => (a.category || '').localeCompare(b.category || ''));

                    const calculatedTotalValue = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)), 0);
                    const totalQty = safeItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);
                    const displayValue = calculatedTotalValue.toFixed(2); 

                    const pageHeight = doc.internal.pageSize.height, pageWidth = doc.internal.pageSize.width;
                    const leftMargin = 40, rightMargin = 40, topMargin = 30, bottomMargin = 40;
                    const contentWidth = pageWidth - leftMargin - rightMargin;
                    const halfWidth = contentWidth / 2;
                    const senderX = leftMargin, receiverX = leftMargin + halfWidth + 15;
                    const receiverWidth = halfWidth - 15, senderWidth = halfWidth - 5;
                    let currentY = topMargin;
                    const lineSpacing = 10, sectionSpacing = 15;

                    if (logoBase64Data) { try { const imgHeight = 40, imgWidth = 107; doc.addImage(logoBase64Data, 'PNG', leftMargin, currentY, imgWidth, imgHeight); currentY += imgHeight + 10; } catch (e) { console.error(e); } } else { currentY += 50; }
                    doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text(docType, pageWidth / 2, currentY, { align: 'center' }); currentY += 20;
                    
                    let senderBlockY = currentY; doc.setFontSize(9); doc.setFont("helvetica", "bold"); doc.text("BEE26 CARGO SERVICES", leftMargin, senderBlockY); senderBlockY += lineSpacing; doc.setFont("helvetica", "normal");
                    const addressLines = ["MOHAMED IMSAMAM MOHAMED RIZAN", "1001260111 - BIN", "614-2 MILEPOST PLACE, EAST YORK,", "ONTARIO, M4H 1C7", "+1 416 474 4994", "bee26cargoservices@gmail.com"];
                    addressLines.forEach(line => { const splitLines = doc.splitTextToSize(line, senderWidth); doc.text(splitLines, leftMargin, senderBlockY); senderBlockY += (splitLines.length * lineSpacing); });
                    if (invoiceNumber) { senderBlockY += lineSpacing * 0.5; doc.setFont("helvetica", "bold"); doc.text(`Invoice #: ${invoiceNumber}`, leftMargin, senderBlockY); senderBlockY += lineSpacing; }
                    if (docType === 'Commercial Invoice' && invoiceDate) { doc.setFont("helvetica", "bold"); doc.text("Date: ", leftMargin, senderBlockY); doc.setFont("helvetica", "normal"); doc.text(invoiceDate, leftMargin + 30, senderBlockY); senderBlockY += lineSpacing; }
                    
                    let receiverBlockY = currentY; doc.setFontSize(10); doc.setFont("helvetica", "bold"); doc.text("TO (Receiver):", receiverX, receiverBlockY); receiverBlockY += lineSpacing * 1.5; doc.setFont("helvetica", "normal"); doc.setFontSize(9);
                    doc.text(receiverName, receiverX, receiverBlockY); receiverBlockY += lineSpacing; doc.text(receiverPhone, receiverX, receiverBlockY); receiverBlockY += lineSpacing;
                    const receiverAddressLines = doc.splitTextToSize(receiverAddress, receiverWidth); doc.text(receiverAddressLines, receiverX, receiverBlockY); receiverBlockY += (receiverAddressLines.length * lineSpacing);
                    if (docType === 'Commercial Invoice' && hsCode) { receiverBlockY += lineSpacing * 0.5; doc.setFont("helvetica", "bold"); doc.text("HS Code (Overall): ", receiverX, receiverBlockY); doc.setFont("helvetica", "normal"); doc.text(hsCode, receiverX + 80, receiverBlockY); }
                    
                    let tableStartY = Math.max(senderBlockY, receiverBlockY) + sectionSpacing;
                    
                    // --- UPDATED TABLE HEADERS TO INCLUDE IMAGE ---
                    const tableHead = [['#', 'Image', 'HS Code', 'Description', 'Category', 'Brand', 'Cntry', 'Qty', 'Unit Val', 'Total']];
                    const tableBody = [];
                    let currentCategory = null;

                    safeItems.forEach((item, index) => {
                        const itemCat = item.category || 'Uncategorized';
                        if (itemCat !== currentCategory) {
                            currentCategory = itemCat;
                            // Update colspan to 10 to match new column count (Added Image col)
                            tableBody.push([{ content: currentCategory.toUpperCase(), colSpan: 10, styles: { fillColor: [240, 240, 240], fontStyle: 'bold', textColor: 50 } }]);
                        }
                        
                        // Push Row with Image Object
                        tableBody.push([
                            index + 1, 
                            { content: '', image: item.image }, // Image Column (Object with image data)
                            item.hsCode || '--', 
                            item.desc || '', 
                            item.category || '', 
                            item.brand || '--', 
                            item.country || '--', 
                            parseFloat(item.qty) || 0, 
                            (parseFloat(item.value) || 0).toFixed(2), 
                            ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)).toFixed(2)
                        ]);
                    });
                    
                    doc.autoTable({ 
                        head: tableHead, 
                        body: tableBody, 
                        startY: tableStartY, 
                        theme: 'grid', 
                        headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold', fontSize: 8 }, 
                        styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak', minCellHeight: 25 }, // Increased height for images
                        columnStyles: { 
                            0: { cellWidth: 20, halign: 'center' }, // #
                            1: { cellWidth: 30, halign: 'center' }, // Image Column
                            2: { cellWidth: 50, halign: 'center' }, // HS Code
                            7: { cellWidth: 30, halign: 'center' }, // Qty
                            8: { cellWidth: 40, halign: 'right' },  // Unit
                            9: { cellWidth: 40, halign: 'right' }   // Total
                        }, 
                        margin: { left: leftMargin, right: rightMargin },
                        
                        // --- HOOK TO DRAW IMAGE ---
                        didDrawCell: function(data) {
                            if (data.column.index === 1 && data.cell.section === 'body' && data.cell.raw && data.cell.raw.image) {
                                try {
                                    const imgData = data.cell.raw.image;
                                    const dim = 20; // 20pt image
                                    const x = data.cell.x + (data.cell.width - dim) / 2;
                                    const y = data.cell.y + (data.cell.height - dim) / 2;
                                    doc.addImage(imgData, 'JPEG', x, y, dim, dim);
                                } catch(err) {
                                    console.error("Error drawing image row", data.row.index, err);
                                }
                            }
                        }
                    });
                    
                    const finalY = doc.autoTable.previous.finalY;
                    doc.setFontSize(10); doc.setFont("helvetica", "bold"); let summaryY = finalY + sectionSpacing; const summaryRightX = pageWidth - rightMargin;
                    if (summaryY > pageHeight - bottomMargin - (lineSpacing * 10)) { doc.addPage(); summaryY = topMargin + 20; } 
                    doc.text(`Total Quantity:`, leftMargin, summaryY); doc.text(`${totalQty} pcs`, summaryRightX, summaryY, { align: 'right'}); summaryY += lineSpacing * 1.5;
                    doc.text(`Total Packages:`, leftMargin, summaryY); doc.text(`${totalPackages || 'N/A'}`, summaryRightX, summaryY, { align: 'right'}); summaryY += lineSpacing * 1.5;
                    doc.text(`Total Net Weight:`, leftMargin, summaryY); doc.text(`${totalWeight || 'N/A'} kg`, summaryRightX, summaryY, { align: 'right'}); summaryY += lineSpacing * 1.5;
                    doc.text(`Total Declared Value:`, leftMargin, summaryY); doc.text(`$${displayValue} CAD`, summaryRightX, summaryY, { align: 'right'});
                    
                    if (docType !== 'Packing List') {
                        summaryY += sectionSpacing * 1.5; doc.setFont("helvetica", "bold"); doc.text("Payment Summary (Customer)", leftMargin, summaryY); summaryY += lineSpacing * 1.5; doc.setFont("helvetica", "normal");
                        doc.text(`Service Fee:`, leftMargin, summaryY); doc.text(`$${serviceFee.toFixed(2)} CAD`, summaryRightX, summaryY, { align: 'right'}); summaryY += lineSpacing * 1.5;
                        doc.text(`${additionalChargesDesc}:`, leftMargin, summaryY); doc.text(`$${additionalCharges.toFixed(2)} CAD`, summaryRightX, summaryY, { align: 'right'}); summaryY += lineSpacing * 1.5;
                        doc.setFont("helvetica", "bold"); doc.text(`Total Amount Due:`, leftMargin, summaryY); doc.text(`$${totalAmountDue.toFixed(2)} CAD`, summaryRightX, summaryY, { align: 'right'});
                    }

                    doc.setFontSize(9); doc.setFont("helvetica", "bold"); let declarationY = summaryY + sectionSpacing * 1.5;
                    if (declarationY > pageHeight - bottomMargin - lineSpacing) { doc.addPage(); declarationY = topMargin + 20; }
                    doc.text("Declaration: Personal Use ‚Äì Not for Resale", leftMargin, declarationY);
                    
                    if (docType === 'Packing List' && sealBase64Data) {
                        try {
                            const sealSize = 100;
                            if (declarationY + sealSize + 10 > pageHeight - bottomMargin) { doc.addPage(); declarationY = topMargin + 20; }
                            doc.addImage(sealBase64Data, 'PNG', leftMargin, declarationY + 15, sealSize, sealSize);
                        } catch (imgErr) { console.error("Failed to add seal image to PDF:", imgErr); }
                    }

                    addPdfFooter(doc); const fileName = `${docType.replace(/ /g, '_')}_${invoiceNumber || 'Shipment'}.pdf`;
                    if (action === 'open') { 
                        if (pdfWindow && doc) { const blob = doc.output('blob'); const blobURL = URL.createObjectURL(blob); pdfWindow.location.href = blobURL; } else { if (pdfWindow) pdfWindow.close(); throw new Error("Could not generate PDF for printing."); } 
                    } else { if (doc) { doc.save(fileName); } else { throw new Error("Could not generate PDF for saving."); } }
                } catch (error) { if (action === 'open' && pdfWindow) pdfWindow.close(); console.error("Error generating PDF:", error); alert("Sorry, there was an error generating the PDF."); }
            }
async function generateThermalLabel() {
                try {
                    const { jsPDF } = window.jspdf;
                    // Create PDF: 4x6 inches (unit: pt, format: [288, 432])
                    const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: [288, 432] });
                    
                    const senderName = document.getElementById('senderName').value || 'Sender';
                    const receiverName = document.getElementById('receiverName').value || 'Receiver';
                    const receiverAddress = document.getElementById('receiverAddress').value || '';
                    const receiverPhone = document.getElementById('receiverPhone').value || '';
                    const inv = document.getElementById('invoiceNumber').value || '0000';
                    const weight = document.getElementById('totalWeight').value || '0';
                    const pkgs = document.getElementById('totalPackages').value || '1';

                    // --- DRAW LABEL ---
                    doc.setLineWidth(2);
                    doc.rect(5, 5, 278, 422); // Border

                    // Header
                    doc.setFontSize(14); doc.setFont("helvetica", "bold");
                    doc.text("BEE26 CARGO SERVICES", 144, 25, { align: "center" });
                    doc.setFontSize(10);
                    doc.text("Toronto, Canada", 144, 38, { align: "center" });
                    doc.line(5, 45, 283, 45);

                    // Destination (BIG)
                    doc.setFontSize(10); doc.text("SHIP TO:", 15, 65);
                    doc.setFontSize(16); doc.text(receiverName.toUpperCase(), 15, 85);
                    doc.setFontSize(12); 
                    const splitAddr = doc.splitTextToSize(receiverAddress, 260);
                    doc.text(splitAddr, 15, 105);
                    doc.text(`Tel: ${receiverPhone}`, 15, 105 + (splitAddr.length * 14) + 10);
                    
                    // Line separator
                    const midY = 180;
                    doc.line(5, midY, 283, midY);

                    // Details
                    doc.setFontSize(10);
                    doc.text(`Invoice #: ${inv}`, 15, midY + 20);
                    doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, midY + 20);
                    
                    doc.setFontSize(14);
                    doc.text(`Weight: ${weight} KG`, 15, midY + 45);
                    doc.text(`Pkgs: ${pkgs}`, 150, midY + 45);

                    // Barcode Generation
                    const canvas = document.createElement("canvas");
                    JsBarcode(canvas, inv, { format: "CODE128", displayValue: true, width: 2, height: 50, fontSize: 14 });
                    const barcodeImg = canvas.toDataURL("image/jpeg");
                    
                    // Add Barcode to PDF
                    doc.addImage(barcodeImg, 'JPEG', 44, midY + 65, 200, 60);

                    // Footer
                    doc.setFontSize(8);
                    doc.text("H A N D L E   W I T H   C A R E", 144, 415, { align: "center" });

                    // Open/Print
                    window.open(doc.output('bloburl'), '_blank');
                } catch(e) {
                    console.error(e);
                    window.showToast("Error generating label", "error");
                }
            }

            // Attach Listener
            const btnLabel = document.getElementById('printThermalLabelBtn');
            if(btnLabel) btnLabel.addEventListener('click', generateThermalLabel);
            function generateExcel() { 
                 try {
                    if (typeof XLSX === 'undefined') { alert("Error: XLSX library not found."); return; }
                    const senderName = document.getElementById('senderName').value, receiverName = document.getElementById('receiverName').value, receiverPhone = document.getElementById('receiverPhone').value;
                    const receiverAddress = document.getElementById('receiverAddress').value, invoiceNumber = document.getElementById('invoiceNumber').value, invoiceDate = document.getElementById('invoiceDate').value;
                    const totalPackages = document.getElementById('totalPackages').value, hsCode = document.getElementById('hsCode').value, totalWeight = document.getElementById('totalWeight').value;
                    const infoData = [ ["Shipment Details", ""], ["Sender Name", senderName], ["Receiver Name", receiverName], ["Receiver Phone", receiverPhone], ["Receiver Address", receiverAddress], ["", ""], ["Invoice #", invoiceNumber], ["Date", invoiceDate], ["Total Packages", totalPackages], ["HS Code", hsCode] ];
                    const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
                    
                    // --- UPDATED HEADERS TO INCLUDE HS CODE ---
                    const itemsHeader = ['HS Code', 'Description', 'Condition', 'Brand', 'Country', 'Category', 'Quantity', 'Unit Value (CAD)', 'Total Value (CAD)'];
                    
                    const safeItems = Array.isArray(local_items) ? local_items : [];
                    const itemsBody = safeItems.map(item => { 
                        const qty = parseFloat(item.qty) || 0, value = parseFloat(item.value) || 0; 
                        // --- ADDED item.hsCode to the row data ---
                        return [item.hsCode || '', item.desc || '', item.condition || '', item.brand || '', item.country || '', item.category || '', qty, value, qty * value]; 
                    });
                    
                    const totalQty = safeItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);
                    const calculatedTotalValue = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)), 0);
                    
                    const displayValue = calculatedTotalValue; 

                    // Adjusted footer for new column count (shifted by 1)
                    const itemsFooter = ['TOTAL', '', '', '', '', '', totalQty, '', displayValue];
                    const wsItems = XLSX.utils.aoa_to_sheet([itemsHeader, ...itemsBody, [], itemsFooter]);
                    XLSX.utils.sheet_add_aoa(wsInfo, [["Total Weight (kg)", totalWeight]], { origin: -1 });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsInfo, "Shipment Info");
                    XLSX.utils.book_append_sheet(wb, wsItems, "Packing List");
                    const fileName = `Bee26_Shipment_${invoiceNumber || ''}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                 } catch (error) { console.error("Error generating Excel:", error); alert("Sorry, there was an error generating the Excel file."); }
             }

            // --- NEW: GENERATE CONCERN FORM PDF ---
            async function generateConcernForm() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'pt', 'a4'); // Portrait, points, A4
                    
                    const logoBase64Data = await fetchLogoAsBase64();
                    const senderName = document.getElementById('senderName').value || '';
                    const senderPhone = document.getElementById('senderPhone').value || '';
                    const receiverName = document.getElementById('receiverName').value || '';
                    const receiverAddress = document.getElementById('receiverAddress').value || '';
                    const receiverPhone = document.getElementById('receiverPhone').value || '';
                    
                    const margin = 40;
                    const pageWidth = doc.internal.pageSize.width;
                    let currentY = 40;

                    // 1. HEADER (Logo & Company Info)
                    if (logoBase64Data) {
                        doc.addImage(logoBase64Data, 'PNG', margin, currentY, 100, 40); // Adjust size as needed
                    }
                    doc.setFontSize(18); doc.setFont("helvetica", "bold");
                    doc.text("CONCERN FORM", pageWidth / 2, currentY + 25, { align: 'center' });
                    
                    doc.setFontSize(10); doc.setFont("helvetica", "normal");
                    doc.text("Bee26 Cargo Services", pageWidth - margin, currentY + 15, { align: 'right' });
                    doc.text("614-2 Milepost Place, East York, Ontario M4H 1C7", pageWidth - margin, currentY + 28, { align: 'right' });
                    doc.text("+1 416-474-4994 | admin@bee26.com", pageWidth - margin, currentY + 41, { align: 'right' });

                    currentY += 60;

                    // 2. SENDER & RECEIVER DETAILS
                    doc.setLineWidth(0.5);
                    doc.setDrawColor(200);
                    
                    // Box Setup
                    const boxWidth = (pageWidth - (margin * 2) - 20) / 2;
                    const boxHeight = 70;
                    
                    // Sender Box
                    doc.rect(margin, currentY, boxWidth, boxHeight);
                    doc.setFontSize(11); doc.setFont("helvetica", "bold");
                    doc.text("Sender's Details", margin + 10, currentY + 20);
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text(`Name: ${senderName}`, margin + 10, currentY + 35);
                    doc.text(`Contact: ${senderPhone}`, margin + 10, currentY + 50);
                    doc.text(`NIC/DL: __________________`, margin + 10, currentY + 65);

                    // Receiver Box
                    doc.rect(margin + boxWidth + 20, currentY, boxWidth, boxHeight);
                    doc.setFontSize(11); doc.setFont("helvetica", "bold");
                    doc.text("Receiver's Details", margin + boxWidth + 30, currentY + 20);
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text(`Name: ${receiverName}`, margin + boxWidth + 30, currentY + 35);
                    doc.text(`Contact: ${receiverPhone}`, margin + boxWidth + 30, currentY + 50);
                    const splitRecAddr = doc.splitTextToSize(`Addr: ${receiverAddress}`, boxWidth - 20);
                    doc.text(splitRecAddr, margin + boxWidth + 30, currentY + 65);

                    currentY += boxHeight + 20;

                    // 3. ITEM TABLE (From Invoice)
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    doc.text("Shipment Content Declaration", margin, currentY);
                    currentY += 5;

                    const tableHead = [['Item Description', 'Qty', 'Unit Value']];
                    const tableBody = local_items.map(item => [
                        item.desc || '', 
                        item.qty || '0', 
                        `$${parseFloat(item.value || 0).toFixed(2)}`
                    ]);

                    doc.autoTable({
                        head: tableHead,
                        body: tableBody,
                        startY: currentY,
                        theme: 'grid',
                        headStyles: { fillColor: [88, 86, 214], textColor: 255, fontStyle: 'bold', halign: 'center' },
                        columnStyles: {
                            0: { cellWidth: 'auto' },
                            1: { cellWidth: 50, halign: 'center' },
                            2: { cellWidth: 80, halign: 'right' }
                        },
                        styles: { fontSize: 9, cellPadding: 4 },
                        margin: { left: margin, right: margin }
                    });

                    currentY = doc.lastAutoTable.finalY + 20;

                    // 4. TERMS AND CONDITIONS (Text from PDF)
                    // Check if we need a new page for terms
                    if (currentY > doc.internal.pageSize.height - 300) {
                        doc.addPage();
                        currentY = 40;
                    }

                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    doc.text("Terms & Agreements", margin, currentY);
                    currentY += 15;

                    doc.setFontSize(8); doc.setFont("helvetica", "normal");
                    const lineHeight = 10;
                    const maxWidth = pageWidth - (margin * 2);

                    const terms = [
                        { title: "1. Compliance with Regulations:", text: "The customer agrees that all shipments comply with applicable laws and regulations, including International Air Transport Association (IATA) standards and any relevant customs, import/export regulations." },
                        { title: "2. Accuracy of Shipment Information:", text: "The customer confirms that all information provided regarding the shipment, including contents, value, and destination, is accurate and truthful. Any discrepancies found may lead to the cancellation of the shipment and potential legal action." },
                        { title: "3. Consignee Liability:", text: "The customer understands that in the event of the shipment containing any illegal or restricted items, the consignee shall bear full responsibility and must face legal consequences as per local and international laws." },
                        { title: "4. Right to Inspect:", text: "Bee26 cargo services reserves the right to inspect any shipment to ensure compliance with all regulations. Any shipment found to contain prohibited items will be reported to the relevant authorities." },
                        { title: "5. Prohibited Items:", text: "The customer acknowledges that illegal substances, hazardous materials, and any other prohibited or restricted items are not permitted for shipping. The customer is responsible for ensuring that the contents of their shipment comply with these restrictions and Bee26 cargo services will not take any responsibilities." },
                        { title: "6. Liability for Delays or Seizure:", text: "Bee26 cargo services is not liable for any delays, losses, or seizures of shipments resulting from violations of the stated conditions or due to the involvement of law enforcement or customs authorities." },
                        { title: "7. Insurance Policy:", text: "Bee26 cargo services is not liable to pay any damage or loss of shipment unless the customer has accepted the insurance Policy. Victim will get 5$ compensation per each kilo and must be only the damaged items. I understand and agree that by declining insurance coverage for this shipment, I assume full responsibility for any loss or damage that may occur during transit." }
                    ];

                    terms.forEach(term => {
                        doc.setFont("helvetica", "bold");
                        doc.text(term.title, margin, currentY);
                        currentY += lineHeight;
                        
                        doc.setFont("helvetica", "normal");
                        const splitText = doc.splitTextToSize(term.text, maxWidth);
                        doc.text(splitText, margin, currentY);
                        currentY += (splitText.length * lineHeight) + 5;
                        
                        // Page break check inside loop
                        if (currentY > doc.internal.pageSize.height - 60) {
                            doc.addPage();
                            currentY = 40;
                        }
                    });

                    // 5. SIGNATURES
                    currentY += 20;
                    if (currentY > doc.internal.pageSize.height - 100) { doc.addPage(); currentY = 50; }

                    doc.setFontSize(9);
                    doc.text("I pay the custom duties to the office before the boxes are delivered.", margin, currentY);
                    currentY += 40;

                    // Signature Lines
                    doc.setLineWidth(1);
                    doc.line(margin, currentY, margin + 200, currentY); // Sig Line 1
                    doc.line(pageWidth - margin - 200, currentY, pageWidth - margin, currentY); // Sig Line 2

                    currentY += 15;
                    doc.text("Customer Signature", margin, currentY);
                    doc.text("Date", pageWidth - margin - 200, currentY);

                    // Open the PDF
                    window.open(doc.output('bloburl'), '_blank');

                } catch (error) {
                    console.error("Error generating Concern Form:", error);
                    alert("Error generating the form. Please check console.");
                }
            }

            // --- EVENT LISTENERS ---
            // --- NEW: GENERATE CONCERN FORM PDF (Detailed) ---
            async function generateConcernForm() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'pt', 'a4'); // Portrait, points, A4
                    
                    const logoBase64Data = await fetchLogoAsBase64();
                    
                    // 1. Gather Data
                    const senderName = document.getElementById('senderName').value || '';
                    const senderPhone = document.getElementById('senderPhone').value || '';
                    // NEW FIELDS
                    const senderAddress = document.getElementById('senderAddress').value || '';
                    const senderNic = document.getElementById('senderNic').value || '';

                    const receiverName = document.getElementById('receiverName').value || '';
                    const receiverAddress = document.getElementById('receiverAddress').value || '';
                    const receiverPhone = document.getElementById('receiverPhone').value || '';
                    
                    const invoiceNumber = document.getElementById('invoiceNumber').value || '';
                    const totalPackages = document.getElementById('totalPackages').value || '0';
                    const totalWeight = document.getElementById('totalWeight').value || '0';
                    
                    const margin = 30;
                    const pageWidth = doc.internal.pageSize.width;
                    let currentY = 40;

                    // 2. HEADER
                    // Draw Logo
                    if (logoBase64Data) {
                        doc.addImage(logoBase64Data, 'PNG', margin, currentY, 100, 40);
                    }
                    
                    // Draw Company Info
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text("Bee26 Cargo Services | Bee-Yond Fast | Bee-Yond Trust", pageWidth - margin, currentY + 15, { align: 'right' });
                    doc.text("614-2 Milepost Place, East York, Ontario M4H 1C7", pageWidth - margin, currentY + 28, { align: 'right' });
                    doc.text("+1 416-474-4994 | admin@bee26.com", pageWidth - margin, currentY + 41, { align: 'right' });
                    
                    // Move down for Title (Fixes Overlap)
                    currentY += 70;

                    doc.setFontSize(14); doc.setFont("helvetica", "bold");
                    doc.text("CUSTOMER CONCERN FORM", pageWidth / 2, currentY, { align: 'center' });

                    currentY += 25;

                    // 3. SENDER & RECEIVER BOXES
                    doc.setLineWidth(0.5); doc.setDrawColor(200);
                    const boxWidth = (pageWidth - (margin * 2) - 10) / 2;
                    const boxHeight = 75;

                    // Sender
                    doc.rect(margin, currentY, boxWidth, boxHeight);
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    doc.text("Sender's Details", margin + 10, currentY + 15);
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text(`Name: ${senderName}`, margin + 10, currentY + 30);
                    // FIXED: Now uses actual sender address
                    const splitSenderAddr = doc.splitTextToSize(`Address: ${senderAddress}`, boxWidth - 20);
                    doc.text(splitSenderAddr, margin + 10, currentY + 42); 
                    
                    // Adjust Y if address is long
                    let senderYOffset = 42 + (splitSenderAddr.length * 10);
                    doc.text(`Contact No: ${senderPhone}`, margin + 10, currentY + senderYOffset);
                    doc.text(`NIC/Drivers License No: ${senderNic}`, margin + 10, currentY + senderYOffset + 12);

                    // Receiver
                    doc.rect(margin + boxWidth + 10, currentY, boxWidth, boxHeight);
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    doc.text("Receiver's Details", margin + boxWidth + 20, currentY + 15);
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text(`Name: ${receiverName}`, margin + boxWidth + 20, currentY + 30);
                    const splitAddr = doc.splitTextToSize(`Address: ${receiverAddress}`, boxWidth - 20);
                    doc.text(splitAddr, margin + boxWidth + 20, currentY + 42);
                    doc.text(`Contact No: ${receiverPhone}`, margin + boxWidth + 20, currentY + 42 + (splitAddr.length*10));

                    currentY += boxHeight + 20;

                    // 4. DETAILED ITEMS TABLE (Matching Image Structure)
                    const tableHead = [['#', 'Image', 'HS Code', 'Description', 'Category', 'Brand', 'Cntry', 'Qty', 'Unit Val', 'Total']];
                    const tableBody = [];
                    
                    // Sort items by category to match the grouping style
                    const sortedItems = [...local_items].sort((a, b) => (a.category || '').localeCompare(b.category || ''));
                    let currentCategory = null;
                    let grandTotalValue = 0;
                    let grandTotalQty = 0;

                    sortedItems.forEach((item, index) => {
                        const itemTotal = (parseFloat(item.qty)||0) * (parseFloat(item.value)||0);
                        grandTotalValue += itemTotal;
                        grandTotalQty += parseFloat(item.qty)||0;

                        // Add Category Header Row if changed
                        if (item.category !== currentCategory) {
                            currentCategory = item.category || 'Uncategorized';
                            tableBody.push([{ 
                                content: currentCategory.toUpperCase(), 
                                colSpan: 10, 
                                styles: { fillColor: [240, 240, 240], fontStyle: 'bold', textColor: 50, halign: 'center' } 
                            }]);
                        }

                        tableBody.push([
                            index + 1,
                            { content: '', image: item.image }, // Image column
                            item.hsCode || '',
                            item.desc || '',
                            item.category || '',
                            item.brand || '--',
                            item.country || '--',
                            item.qty,
                            (parseFloat(item.value)||0).toFixed(2),
                            itemTotal.toFixed(2)
                        ]);
                    });

                    doc.autoTable({
                        startY: currentY,
                        head: tableHead,
                        body: tableBody,
                        theme: 'grid',
                        headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold', fontSize: 8, halign: 'center' },
                        styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak', minCellHeight: 25, valign: 'middle' },
                        columnStyles: {
                            0: { cellWidth: 20, halign: 'center' }, // #
                            1: { cellWidth: 30, halign: 'center' }, // Image
                            2: { cellWidth: 50, halign: 'center' }, // HS
                            7: { cellWidth: 30, halign: 'center' }, // Qty
                            8: { cellWidth: 40, halign: 'right' },  // Unit
                            9: { cellWidth: 45, halign: 'right' }   // Total
                        },
                        margin: { left: margin, right: margin },
                        didDrawCell: function(data) {
                            if (data.column.index === 1 && data.cell.section === 'body' && data.cell.raw && data.cell.raw.image) {
                                try {
                                    const imgData = data.cell.raw.image;
                                    const dim = 20; 
                                    const x = data.cell.x + (data.cell.width - dim) / 2;
                                    const y = data.cell.y + (data.cell.height - dim) / 2;
                                    doc.addImage(imgData, 'JPEG', x, y, dim, dim);
                                } catch(err) { /* ignore image error */ }
                            }
                        }
                    });

                    currentY = doc.lastAutoTable.finalY + 15;

                    // 5. SUMMARY FOOTER (Right Aligned)
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    const summaryXLabel = pageWidth - 200;
                    const summaryXValue = pageWidth - margin;

                    // Keep footer on same page if possible
                    if (currentY > doc.internal.pageSize.height - 150) { doc.addPage(); currentY = 40; }

                    doc.text("Total Quantity:", summaryXLabel, currentY);
                    doc.text(`${grandTotalQty} pcs`, summaryXValue, currentY, { align: 'right' }); currentY += 15;
                    
                    doc.text("Total Packages:", summaryXLabel, currentY);
                    doc.text(`${totalPackages}`, summaryXValue, currentY, { align: 'right' }); currentY += 15;

                    doc.text("Total Net Weight:", summaryXLabel, currentY);
                    doc.text(`${totalWeight} kg`, summaryXValue, currentY, { align: 'right' }); currentY += 15;

                    doc.text("Total Declared Value:", summaryXLabel, currentY);
                    doc.text(`$${grandTotalValue.toFixed(2)} CAD`, summaryXValue, currentY, { align: 'right' }); currentY += 25;

                    doc.setFontSize(9);
                    doc.text("Declaration: Personal Use ‚Äì Not for Resale", margin, currentY - 25);

                    // 6. TERMS & CONDITIONS (Page 2 usually, or continued)
                    // Check space, if less than half page, add new page
                    if (currentY > doc.internal.pageSize.height - 350) {
                        doc.addPage();
                        currentY = 40;
                    } else {
                        currentY += 20;
                    }

                    doc.setFontSize(11); doc.setFont("helvetica", "bold");
                    doc.text("Terms & Agreements", margin, currentY);
                    currentY += 15;

                    doc.setFontSize(8); doc.setFont("helvetica", "normal");
                    const terms = [
                        { t: "1. Compliance with Regulations:", d: "The customer agrees that all shipments comply with applicable laws and regulations, including International Air Transport Association (IATA) standards and any relevant customs, import/export regulations." },
                        { t: "2. Accuracy of Shipment Information:", d: "The customer confirms that all information provided regarding the shipment, including contents, value, and destination, is accurate and truthful. Any discrepancies found may lead to the cancellation of the shipment and potential legal action." },
                        { t: "3. Consignee Liability:", d: "The customer understands that in the event of the shipment containing any illegal or restricted items, the consignee shall bear full responsibility and must face legal consequences as per local and international laws." },
                        { t: "4. Right to Inspect:", d: "Bee26 cargo services reserves the right to inspect any shipment to ensure compliance with all regulations. Any shipment found to contain prohibited items will be reported to the relevant authorities." },
                        { t: "5. Prohibited Items:", d: "The customer acknowledges that illegal substances, hazardous materials, and any other prohibited or restricted items are not permitted for shipping. The customer is responsible for ensuring that the contents of their shipment comply with these restrictions and Bee26 cargo services will not take any responsibilities." },
                        { t: "6. Liability for Delays or Seizure:", d: "Bee26 cargo services is not liable for any delays, losses, or seizures of shipments resulting from violations of the stated conditions or due to the involvement of law enforcement or customs authorities." },
                        { t: "7. Insurance Policy:", d: "Bee26 cargo services is not liable to pay any damage or loss of shipment unless the customer has accepted the insurance Policy. Victim will get 5$ compensation per each kilo and must be only the damaged items.\nI understand and agree that by declining insurance coverage for this shipment, I assume full responsibility for any loss or damage that may occur during transit." }
                    ];

                    terms.forEach(term => {
                        doc.setFont("helvetica", "bold");
                        doc.text(term.t, margin, currentY);
                        currentY += 10;
                        doc.setFont("helvetica", "normal");
                        const splitD = doc.splitTextToSize(term.d, pageWidth - (margin*2));
                        doc.text(splitD, margin, currentY);
                        currentY += (splitD.length * 10) + 8;
                        
                        if (currentY > doc.internal.pageSize.height - 50) { doc.addPage(); currentY = 40; }
                    });

                    // 7. SIGNATURES
                    if (currentY > doc.internal.pageSize.height - 120) { doc.addPage(); currentY = 50; }
                    
                    currentY += 10;
                    doc.setFont("helvetica", "bold"); doc.setFontSize(9);
                    // FIXED TEXT: Removed "to Canada"
                    doc.text("I pay the custom duties to the office before the boxes are delivered", margin, currentY);
                    currentY += 50;

                    doc.setLineWidth(1);
                    doc.line(margin, currentY, margin + 200, currentY); // Sig Line 1
                    doc.line(pageWidth - margin - 200, currentY, pageWidth - margin, currentY); // Sig Line 2

                    currentY += 15;
                    doc.text("Customer Signature", margin, currentY);
                    doc.text("Date", pageWidth - margin - 200, currentY);

                    // Open
                    window.open(doc.output('bloburl'), '_blank');

                } catch (error) {
                    console.error("Error generating Concern Form:", error);
                    alert("Error generating the form. Please check console.");
                }
            }

            // --- EVENT LISTENERS (Replacing old block) ---
            // --- NEW: GENERATE CONCERN FORM PDF (Detailed) ---
            async function generateConcernForm() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'pt', 'a4'); // Portrait, points, A4
                    
                    const logoBase64Data = await fetchLogoAsBase64();
                    
                    // 1. Gather Data
                    const senderName = document.getElementById('senderName').value || '';
                    const senderPhone = document.getElementById('senderPhone').value || '';
                    const receiverName = document.getElementById('receiverName').value || '';
                    const receiverAddress = document.getElementById('receiverAddress').value || '';
                    const receiverPhone = document.getElementById('receiverPhone').value || '';
                    
                    const invoiceNumber = document.getElementById('invoiceNumber').value || '';
                    const totalPackages = document.getElementById('totalPackages').value || '0';
                    const totalWeight = document.getElementById('totalWeight').value || '0';
                    
                    const margin = 30;
                    const pageWidth = doc.internal.pageSize.width;
                    let currentY = 40;

                    // 2. HEADER
                    if (logoBase64Data) {
                        doc.addImage(logoBase64Data, 'PNG', margin, currentY, 100, 40);
                    }
                    doc.setFontSize(8); doc.setFont("helvetica", "bold");
                    doc.text("CONCERN FORM", pageWidth / 2, currentY + 25, { align: 'center' });
                    
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text("Bee26 Cargo Services", pageWidth - margin, currentY + 15, { align: 'right' });
                    doc.text("614-2 Milepost Place, East York, Ontario M4H 1C7", pageWidth - margin, currentY + 28, { align: 'right' });
                    doc.text("+1 416-474-4994 | admin@bee26.com", pageWidth - margin, currentY + 41, { align: 'right' });

                    currentY += 60;

                    // 3. SENDER & RECEIVER BOXES
                    doc.setLineWidth(0.5); doc.setDrawColor(200);
                    const boxWidth = (pageWidth - (margin * 2) - 10) / 2;
                    const boxHeight = 75;

                    // Sender
                    doc.rect(margin, currentY, boxWidth, boxHeight);
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    doc.text("Sender's Details", margin + 10, currentY + 15);
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text(`Name: ${senderName}`, margin + 10, currentY + 30);
                    doc.text(`Address: --`, margin + 10, currentY + 42); // Placeholder if address missing
                    doc.text(`Contact No: ${senderPhone}`, margin + 10, currentY + 54);
                    doc.text(`NIC/Drivers License No:`, margin + 10, currentY + 66);

                    // Receiver
                    doc.rect(margin + boxWidth + 10, currentY, boxWidth, boxHeight);
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    doc.text("Receiver's Details", margin + boxWidth + 20, currentY + 15);
                    doc.setFontSize(9); doc.setFont("helvetica", "normal");
                    doc.text(`Name: ${receiverName}`, margin + boxWidth + 20, currentY + 30);
                    const splitAddr = doc.splitTextToSize(`Address: ${receiverAddress}`, boxWidth - 20);
                    doc.text(splitAddr, margin + boxWidth + 20, currentY + 42);
                    doc.text(`Contact No: ${receiverPhone}`, margin + boxWidth + 20, currentY + 42 + (splitAddr.length*10));

                    currentY += boxHeight + 20;

                    // 4. DETAILED ITEMS TABLE (Matching Image Structure)
                    const tableHead = [['#', 'Image', 'HS Code', 'Description', 'Category', 'Brand', 'Cntry', 'Qty', 'Unit Val', 'Total']];
                    const tableBody = [];
                    
                    // Sort items by category to match the grouping style
                    const sortedItems = [...local_items].sort((a, b) => (a.category || '').localeCompare(b.category || ''));
                    let currentCategory = null;
                    let grandTotalValue = 0;
                    let grandTotalQty = 0;

                    sortedItems.forEach((item, index) => {
                        const itemTotal = (parseFloat(item.qty)||0) * (parseFloat(item.value)||0);
                        grandTotalValue += itemTotal;
                        grandTotalQty += parseFloat(item.qty)||0;

                        // Add Category Header Row if changed
                        if (item.category !== currentCategory) {
                            currentCategory = item.category || 'Uncategorized';
                            tableBody.push([{ 
                                content: currentCategory.toUpperCase(), 
                                colSpan: 10, 
                                styles: { fillColor: [240, 240, 240], fontStyle: 'bold', textColor: 50, halign: 'center' } 
                            }]);
                        }

                        tableBody.push([
                            index + 1,
                            { content: '', image: item.image }, // Image column
                            item.hsCode || '',
                            item.desc || '',
                            item.category || '',
                            item.brand || '--',
                            item.country || '--',
                            item.qty,
                            (parseFloat(item.value)||0).toFixed(2),
                            itemTotal.toFixed(2)
                        ]);
                    });

                    doc.autoTable({
                        startY: currentY,
                        head: tableHead,
                        body: tableBody,
                        theme: 'grid',
                        headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold', fontSize: 8, halign: 'center' },
                        styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak', minCellHeight: 25, valign: 'middle' },
                        columnStyles: {
                            0: { cellWidth: 20, halign: 'center' }, // #
                            1: { cellWidth: 30, halign: 'center' }, // Image
                            2: { cellWidth: 50, halign: 'center' }, // HS
                            7: { cellWidth: 30, halign: 'center' }, // Qty
                            8: { cellWidth: 40, halign: 'right' },  // Unit
                            9: { cellWidth: 45, halign: 'right' }   // Total
                        },
                        margin: { left: margin, right: margin },
                        didDrawCell: function(data) {
                            if (data.column.index === 1 && data.cell.section === 'body' && data.cell.raw && data.cell.raw.image) {
                                try {
                                    const imgData = data.cell.raw.image;
                                    const dim = 20; 
                                    const x = data.cell.x + (data.cell.width - dim) / 2;
                                    const y = data.cell.y + (data.cell.height - dim) / 2;
                                    doc.addImage(imgData, 'JPEG', x, y, dim, dim);
                                } catch(err) { /* ignore image error */ }
                            }
                        }
                    });

                    currentY = doc.lastAutoTable.finalY + 15;

                    // 5. SUMMARY FOOTER (Right Aligned)
                    doc.setFontSize(10); doc.setFont("helvetica", "bold");
                    const summaryXLabel = pageWidth - 200;
                    const summaryXValue = pageWidth - margin;

                    // Keep footer on same page if possible
                    if (currentY > doc.internal.pageSize.height - 150) { doc.addPage(); currentY = 40; }

                    doc.text("Total Quantity:", summaryXLabel, currentY);
                    doc.text(`${grandTotalQty} pcs`, summaryXValue, currentY, { align: 'right' }); currentY += 15;
                    
                    doc.text("Total Packages:", summaryXLabel, currentY);
                    doc.text(`${totalPackages}`, summaryXValue, currentY, { align: 'right' }); currentY += 15;

                    doc.text("Total Net Weight:", summaryXLabel, currentY);
                    doc.text(`${totalWeight} kg`, summaryXValue, currentY, { align: 'right' }); currentY += 15;

                    doc.text("Total Declared Value:", summaryXLabel, currentY);
                    doc.text(`$${grandTotalValue.toFixed(2)} CAD`, summaryXValue, currentY, { align: 'right' }); currentY += 25;

                    doc.setFontSize(9);
                    doc.text("Declaration: Personal Use ‚Äì Not for Resale", margin, currentY - 25);

                    // 6. TERMS & CONDITIONS (Page 2 usually, or continued)
                    // Check space, if less than half page, add new page
                    if (currentY > doc.internal.pageSize.height - 350) {
                        doc.addPage();
                        currentY = 40;
                    } else {
                        currentY += 20;
                    }

                    doc.setFontSize(11); doc.setFont("helvetica", "bold");
                    doc.text("Terms & Agreements", margin, currentY);
                    currentY += 15;

                    doc.setFontSize(8); doc.setFont("helvetica", "normal");
                    const terms = [
                        { t: "1. Compliance with Regulations:", d: "The customer agrees that all shipments comply with applicable laws and regulations, including International Air Transport Association (IATA) standards and any relevant customs, import/export regulations." },
                        { t: "2. Accuracy of Shipment Information:", d: "The customer confirms that all information provided regarding the shipment, including contents, value, and destination, is accurate and truthful. Any discrepancies found may lead to the cancellation of the shipment and potential legal action." },
                        { t: "3. Consignee Liability:", d: "The customer understands that in the event of the shipment containing any illegal or restricted items, the consignee shall bear full responsibility and must face legal consequences as per local and international laws." },
                        { t: "4. Right to Inspect:", d: "Bee26 cargo services reserves the right to inspect any shipment to ensure compliance with all regulations. Any shipment found to contain prohibited items will be reported to the relevant authorities." },
                        { t: "5. Prohibited Items:", d: "The customer acknowledges that illegal substances, hazardous materials, and any other prohibited or restricted items are not permitted for shipping. The customer is responsible for ensuring that the contents of their shipment comply with these restrictions and Bee26 cargo services will not take any responsibilities." },
                        { t: "6. Liability for Delays or Seizure:", d: "Bee26 cargo services is not liable for any delays, losses, or seizures of shipments resulting from violations of the stated conditions or due to the involvement of law enforcement or customs authorities." },
                        { t: "7. Insurance Policy:", d: "Bee26 cargo services is not liable to pay any damage or loss of shipment unless the customer has accepted the insurance Policy. Victim will get 5$ compensation per each kilo and must be only the damaged items.\nI understand and agree that by declining insurance coverage for this shipment, I assume full responsibility for any loss or damage that may occur during transit." }
                    ];

                    terms.forEach(term => {
                        doc.setFont("helvetica", "bold");
                        doc.text(term.t, margin, currentY);
                        currentY += 10;
                        doc.setFont("helvetica", "normal");
                        const splitD = doc.splitTextToSize(term.d, pageWidth - (margin*2));
                        doc.text(splitD, margin, currentY);
                        currentY += (splitD.length * 10) + 8;
                        
                        if (currentY > doc.internal.pageSize.height - 50) { doc.addPage(); currentY = 40; }
                    });

                    // 7. SIGNATURES
                    if (currentY > doc.internal.pageSize.height - 120) { doc.addPage(); currentY = 50; }
                    
                    currentY += 10;
                    doc.setFont("helvetica", "bold"); doc.setFontSize(9);
                    doc.text("I pay the custom duties to the office before the boxes are delivered.", margin, currentY);
                    currentY += 50;

                    doc.setLineWidth(1);
                    doc.line(margin, currentY, margin + 200, currentY); // Sig Line 1
                    doc.line(pageWidth - margin - 200, currentY, pageWidth - margin, currentY); // Sig Line 2

                    currentY += 15;
                    doc.text("Customer Signature", margin, currentY);
                    doc.text("Date", pageWidth - margin - 200, currentY);

                    // Open
                    window.open(doc.output('bloburl'), '_blank');

                } catch (error) {
                    console.error("Error generating Concern Form:", error);
                    alert("Error generating the form. Please check console.");
                }
            }

            // --- EVENT LISTENERS (Replacing old block) ---
            document.getElementById('printPackingListBtn').addEventListener('click', () => generatePDF('Packing List', 'open'));
            document.getElementById('exportInvoicePDF').addEventListener('click', () => generatePDF('Commercial Invoice', 'save'));
            document.getElementById('exportPackingListExcel').addEventListener('click', generateExcel);
            
            // New Listener for Concern Form
            const btnConcern = document.getElementById('printConcernFormBtn');
            if(btnConcern) btnConcern.addEventListener('click', generateConcernForm);

            // --- WHATSAPP SHARE ---
            const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
            if(shareWhatsAppBtn) {
                shareWhatsAppBtn.addEventListener('click', () => {
                   const phone = document.getElementById('receiverPhone').value.replace(/[^0-9]/g, ''); 
                   const name = document.getElementById('receiverName').value;
                   const inv = document.getElementById('invoiceNumber').value;
                   
                   if(!phone) { window.showToast('Receiver phone number is missing!', 'error'); return; }
                   
                   const msg = `Hi ${name}, here is your shipment invoice #${inv} from Bee26 Cargo. You will receive tracking updates shortly. Thank you!`;
                   const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
                   window.open(url, '_blank');
                });
            }


            // --- 8. Initial Load & Firebase Data Listener ---
            
            function calculateOverallBatchStats() {
                let totalGained = 0;
                let totalCost = 0;

                // 1. Calculate Costs (Sum of all batches in local_batches_cache)
                for(const batchKey in local_batches_cache) {
                    const batchData = local_batches_cache[batchKey];
                    if(batchData && batchData.cost) {
                        totalCost += parseFloat(batchData.cost) || 0;
                    }
                }

                // 2. Calculate Gained (Sum of all shipments that HAVE a batchNo)
                local_shipments_cache.forEach(shipment => {
                    if(shipment.batchNo && shipment.batchNo.trim() !== '') {
                        const serviceFee = parseFloat(shipment.paymentTotal) || 0;
                        const extras = parseFloat(shipment.additionalChargesAmt) || 0;
                        totalGained += (serviceFee + extras);
                    }
                });

                const profit = totalGained - totalCost;

                // 3. Update UI
                const gainedEl = document.getElementById('overall-batch-gained');
                const costEl = document.getElementById('overall-batch-cost');
                const profitEl = document.getElementById('overall-batch-profit');

                if(gainedEl) gainedEl.textContent = `$${totalGained.toFixed(2)}`;
                if(costEl) costEl.textContent = `$${totalCost.toFixed(2)}`;
                
                if(profitEl) {
                    profitEl.textContent = `$${profit.toFixed(2)}`;
                    if(profit > 0) profitEl.style.color = 'var(--green)';
                    else if(profit < 0) profitEl.style.color = 'var(--red)';
                    else profitEl.style.color = 'var(--grey-dark)';
                }
            }


            function listenForData() {
                const shipmentsRef = dbRef(db, 'shipments');
                const batchesRef = dbRef(db, 'batches');
                
                // Shipments Listener
                dbOnValue(shipmentsRef, (snapshot) => {
                    local_shipments_cache = []; 
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        for (const key in data) {
                            const shipmentData = data[key];
                            if (!shipmentData.items) {
                                shipmentData.items = [];
                            }
                            local_shipments_cache.push({ id: key, ...shipmentData });
                        }
                    }
                    // Refresh UI
                    renderShipmentsTable();
                    renderCustomersTable();
                    renderPaymentsTable(); 
                    updateDashboardStats();
                    
                    // Trigger Batch Stats Calc
                    calculateOverallBatchStats();

                }, (error) => {
                    console.error("Firebase data read failed: ", error);
                });
                
                // Batches Listener
                dbOnValue(batchesRef, (snapshot) => {
                    local_batches_cache = {};
                    if(snapshot.exists()) {
                        local_batches_cache = snapshot.val();
                    }
                    // If a batch is currently selected, recalculate with new data
                    calculateBatchTotals();
                    
                    // Trigger Batch Stats Calc
                    calculateOverallBatchStats();
                    
                    // --- VITAL FIX: Force Payments Table to Redraw when Batches (Extras/Costs) Change ---
                    renderPaymentsTable(); 
                });
            }
            
            document.getElementById('invoiceDate').valueAsDate = new Date();
            
            // --- RESTORE DRAFT ON LOAD ---
            listenForData();
            restoreDraft(); // Try restoring local draft immediately on load
// --- UPDATED: AUTOMATIC HS CODE GENERATOR (WEIGHTED RULES ENGINE) ---
    const autoHsDescInput = document.getElementById('modalItemDesc');
    const autoHsCatInput = document.getElementById('modalItemCat');
    const autoHsOutput = document.getElementById('modalItemHSCode');

    // 1. RULES DATABASE
    // "keywords": Things that trigger the code.
    // "negative": Things that disqualify the code (e.g. "baby" triggers clothes, but NOT if "oil" is present).
    const HS_RULES = [
        // --- SUPPLEMENTS & HEALTH (Check these first to catch protein powders vs face powders) ---
        { code: "2106.90", keywords: ["creatine", "protein", "whey", "pre-workout", "bcaa", "vitamin", "supplement", "capsule", "gummies", "centrum", "omega", "fish oil", "food prep"] },
        { code: "3004.90", keywords: ["medicine", "panadol", "tylenol", "advil", "syrup", "tablet", "pain relief"] },

        // --- COSMETICS & PERSONAL CARE ---
        { code: "3305.10", keywords: ["shampoo"] },
        { code: "3305.90", keywords: ["hair color", "hair colour", "hair dye", "conditioner", "hair mask", "hair gel"] }, 
        { code: "3304.91", keywords: ["powder", "talc"], negative: ["protein", "creatine", "drink", "milk"] }, // Face powder ONLY if not protein
        { code: "3304.99", keywords: ["baby oil", "body oil", "face wash", "lotion", "cream", "moisturizer", "scrub", "sunscreen", "vaseline", "sudo", "skin care"] }, 
        { code: "3307.20", keywords: ["deodorant", "body spray", "antiperspirant"] },
        { code: "3303.00", keywords: ["perfume", "cologne", "fragrance", "edt", "edp"] },
        { code: "3306.10", keywords: ["toothpaste"] },
        { code: "3401.30", keywords: ["body wash", "shower gel", "liquid soap", "hand wash"] },

        // --- CLOTHING (Weighted logic prevents "Baby Oil" from becoming "Baby Clothes") ---
        { code: "6111.20", keywords: ["baby", "onesie", "romper", "bib", "frock", "infant"], negative: ["oil", "lotion", "powder", "shampoo", "toy", "walker", "bottle"] }, 
        { code: "6109.10", keywords: ["t-shirt", "tee", "polo", "top", "blouse", "shirt"] },
        { code: "6203.42", keywords: ["jean", "denim", "trouser", "pant", "short", "legging"] },
        { code: "6204.42", keywords: ["dress", "skirt", "maxi"] },
        { code: "6115.95", keywords: ["sock", "stocking"] },
        
        // --- ELECTRONICS & LIGHTING ---
        { code: "8471.30", keywords: ["laptop", "macbook", "notebook", "computer", "ipad", "tablet"] },
        { code: "8517.13", keywords: ["iphone", "samsung", "pixel", "smartphone", "mobile phone"] }, 
        { code: "8517.62", keywords: ["smart watch", "apple watch", "fitbit"] },
        { code: "8518.30", keywords: ["headphone", "earphone", "airpod", "headset", "galaxy bud"] },
        { code: "9405.42", keywords: ["led strip", "light strip", "govee", "rope light"], negative: ["bulb"] }, // Specific for your LED strips
        { code: "9405.21", keywords: ["floor lamp", "desk lamp", "table lamp"] },

        // --- FOOD & KITCHEN ---
        { code: "1806.90", keywords: ["chocolate", "candy", "sweet"] },
        { code: "3924.10", keywords: ["bottle", "tupperware", "plastic cup", "lunch box", "kitchen"], negative: ["feeding bottle"] },
        { code: "3924.90", keywords: ["feeding bottle", "baby bottle"] }, 
        
        // --- SHOES ---
        { code: "6403.99", keywords: ["shoe", "sneaker", "boot", "sandal", "slipper", "footwear", "runner", "trainer"] }
    ];

    // 2. CATEGORY DEFAULTS (Fallback if no keyword matches)
    const HS_CATEGORY_DEFAULTS = {
        "Cosmetics & Toiletries": "3304.99",
        "Medicines & Vitamins": "3004.90",
        "Clothing": "6109.10",
        "Kids Clothing": "6111.20",
        "Footwear & Shoes": "6403.99",
        "Fabrics & Textiles": "6307.90",
        "Computers & Laptops": "8471.30",
        "Phones & Accessories": "8517.13",
        "Electronic Items": "8543.70",
        "Packaged Food (Non-Perishable)": "2106.90",
        "Toys & Hobbies": "9503.00",
        "Kids Toys": "9503.00",
        "Kitchenware": "3924.10"
    };

    function calculateHSCode() {
        if (!autoHsDescInput || !autoHsOutput) return;

        const desc = autoHsDescInput.value.toLowerCase().trim();
        const cat = autoHsCatInput.value;
        let bestMatch = null;
        let highestScore = 0;

        // A. Iterate through rules to find the highest scoring match
        HS_RULES.forEach(rule => {
            let score = 0;
            let negativeMatch = false;

            // 1. Check Negative Keywords (Disqualifiers)
            if (rule.negative) {
                rule.negative.forEach(neg => {
                    if (desc.includes(neg)) negativeMatch = true;
                });
            }

            // 2. Calculate Score (Longer phrase matches = Higher Score)
            if (!negativeMatch) {
                rule.keywords.forEach(keyword => {
                    if (desc.includes(keyword)) {
                        // Base score + length of keyword (Specific "Baby Oil" > General "Oil")
                        score += (keyword.length + 5); 
                    }
                });
            }

            // 3. Update Best Match
            if (score > highestScore) {
                highestScore = score;
                bestMatch = rule.code;
            }
        });

        // B. Apply Match or Fallback
        if (bestMatch) {
            autoHsOutput.value = bestMatch;
            // Visual Flash to indicate update
            autoHsOutput.style.backgroundColor = "#e6f2ff"; 
            setTimeout(() => { autoHsOutput.style.backgroundColor = "#fff"; }, 500);
        } else if (cat && HS_CATEGORY_DEFAULTS[cat]) {
            // Only fallback if no keyword match found
            autoHsOutput.value = HS_CATEGORY_DEFAULTS[cat];
        }
    }

    // Attach Listeners
    if(autoHsDescInput) autoHsDescInput.addEventListener('keyup', calculateHSCode);
    if(autoHsCatInput) autoHsCatInput.addEventListener('change', calculateHSCode);
    // --- NEW: SEARCH LISTENER (The Trigger!) ---
            const allShipmentsSearchInput = document.getElementById('allShipmentsSearch');
            // Check if element exists before adding listener to avoid errors
            if (allShipmentsSearchInput) {
                allShipmentsSearchInput.addEventListener('input', () => {
                    renderShipmentsTable();
                });
            }
        });
    </script>

</body>
</html>
