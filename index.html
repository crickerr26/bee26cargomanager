<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee26 Cargo App</title>
    
   <style>
        /* --- Basic Setup & Fonts --- */
        :root {
            --blue: #007aff;
            --grey-light: #f0f0f5;
            --grey-mid: #e5e5ea;
            --grey-dark: #8a8a8e;
            --text-primary: #1c1c1e;
            --text-secondary: #636366;
            --bg-white: #ffffff;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --sidebar-width: 240px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--grey-light);
            color: var(--text-primary);
            margin: 0;
            display: flex; /* Enable flexbox for layout */
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-white);
            border-right: 1px solid var(--grey-mid);
            height: 100vh;
            position: fixed; /* Fixed position */
            top: 0;
            left: 0;
            padding: 1.5rem 0;
            box-sizing: border-box;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 1.5rem 1.5rem 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--blue);
            border-bottom: 1px solid var(--grey-light);
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0 0;
        }

        .sidebar-nav li a {
            display: block;
            padding: 0.9rem 1.5rem;
            margin: 0.25rem 1rem;
            text-decoration: none;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar-nav li a:hover {
            background-color: var(--grey-light);
        }
        .sidebar-nav li a.active {
            background-color: var(--blue);
            color: var(--bg-white);
            font-weight: 600;
        }
        
        /* --- Main Content Area Styles --- */
        .main-content-area {
            margin-left: var(--sidebar-width); /* Offset by sidebar width */
            width: calc(100% - var(--sidebar-width));
            height: 100vh;
            overflow-y: auto; /* Allow this area to scroll */
            position: relative;
            padding-bottom: 80px; /* Space for footer */
            box-sizing: border-box;
        }
        
        .tab-content {
            display: none; /* Hide all tabs by default */
        }
        .tab-content.active {
            display: block; /* Show only the active tab */
        }
        
        /* --- Customer Database Styles --- */
        #tab-customer-database .container { 
            max-width: none; /* Make container full width */
            padding: 0 1.5rem; /* Add horizontal padding */
        }

        .table-container {
            width: 100%;
            overflow-x: auto; /* Allow horizontal scroll on table */
        }
        .table-google-sheets {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem; /* Smaller font */
            border: 1px solid var(--grey-mid);
        }
        .table-google-sheets th,
        .table-google-sheets td {
            border: 1px solid var(--grey-mid);
            padding: 0.6rem; /* Smaller padding */
            text-align: left;
            vertical-align: middle;
            white-space: nowrap;
        }
        .table-google-sheets th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: var(--text-secondary);
        }
        /* Row number column style */
        .table-google-sheets th:first-child,
        .table-google-sheets td:first-child {
            width: 30px; /* Fixed width for row number */
            text-align: center;
            color: var(--text-secondary);
        }
        .table-google-sheets tbody tr:nth-child(odd) {
            background-color: #fcfcfc;
        }
        .table-google-sheets tbody tr:hover {
            background-color: var(--grey-light);
        }
        .table-google-sheets td:last-child {
            white-space: nowrap; /* Keep buttons together */
        }
        .btn-table {
            font-size: 0.75rem; 
            padding: 0.2rem 0.5rem; 
            margin-right: 0.25rem;
            border-radius: 6px;
        }
        .btn-use {
            background-color: #e6f7ff;
            color: #0056b3;
            border: 1px solid #b3e0ff;
        }
        .btn-use:hover { background-color: #d0ebff; }
        .btn-edit {
            background-color: #fffbe6;
            color: #d46b08;
            border: 1px solid #ffe58f;
        }
        .btn-edit:hover { background-color: #fff1c2; }
        .btn-delete-db {
            background-color: #fff1f0;
            color: #c70000;
            border: 1px solid #ffccc7;
        }
        .btn-delete-db:hover { background-color: #ffe8e6; }

        .customer-submit-group {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--grey-light);
        }
        
        /* --- Header & Footer --- */
        header {
            background-color: var(--bg-white);
            padding: 1rem 1.5rem; 
            border-bottom: 1px solid var(--grey-mid);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin: 0; 
        }

        footer {
            width: 100%;
            background-color: #f8f8f8;
            border-top: 1px solid var(--grey-mid);
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            box-sizing: border-box;
            margin-top: 2rem;
        }

        /* --- Main Layout & Cards --- */
        .container {
            max-width: 900px;
            margin: 2rem auto 0 auto; 
            padding: 0 1.5rem; 
            display: grid;
            gap: 1.5rem;
        }

        .card {
            background-color: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-top: 0;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--grey-light);
            display: flex;
            align-items: center;
        }

        .card h2 .icon {
            margin-right: 0.75rem;
            font-size: 1.5rem;
        }

        .card h3 {
            font-size: 1.1rem;
            color: var(--blue);
            margin-top: 0;
        }

        .output-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--grey-light);
        }
        .output-section:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* --- Forms & Grids --- */
        .form-grid, .item-form-grid, .form-grid-half {
            display: grid;
            gap: 1rem;
        }

        .form-grid {
            grid-template-columns: 1fr 1fr;
        }
        .form-grid-half {
            grid-template-columns: 1fr 1fr;
            max-width: 500px;
        }
        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        .item-form-grid {
            grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr;
            align-items: flex-end;
            margin-top: 1rem;
            border-top: 1px solid var(--grey-light);
            padding-top: 1.5rem;
        }
        .item-form-grid .btn-add {
            height: 44px; /* Align with inputs */
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .input-group input[type="text"],
        .input-group input[type="tel"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group input[type="file"],
        .input-group textarea,
        .input-group select { 
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            box-sizing: border-box; 
            background-color: #fdfdfd;
            font-family: var(--font-family); 
        }
        .input-group input[type="file"] {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        
        .input-group input[disabled] { 
            background-color: var(--grey-light);
            color: var(--text-secondary);
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus { 
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 2px rgba(0,122,255,0.2);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            font-size: 1rem;
        }
        .info-grid strong {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .info-grid div {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--grey-light);
        }
        .info-grid div:last-child,
        .info-grid strong:last-child {
             border-bottom: none;
        }
        
        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        /* --- Buttons --- */
        .btn {
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--blue);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn:hover {
            background-color: #0056b3;
        }

        .btn-add {
            width: 100%;
        }

        .btn-secondary {
            background-color: var(--grey-mid);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: var(--grey-dark);
            color: var(--bg-white);
        }
        
        .btn-print {
            background-color: var(--grey-mid);
            color: var(--text-primary);
        }
        .btn-print:hover {
            background-color: var(--grey-dark);
            color: var(--bg-white);
        }

        .btn-delete {
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        .btn-delete:hover {
            color: #c70000;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .history-buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: -0.5rem; /* Pull cards up slightly */
        }
        
        .btn-history {
            font-family: var(--font-family);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--bg-white);
            color: var(--blue);
            transition: background-color 0.2s ease;
        }
        .btn-history:hover:not(:disabled) {
            background-color: var(--grey-light);
        }
        .btn-history:disabled {
            color: var(--grey-dark);
            cursor: not-allowed;
            background-color: #f9f9f9;
            border-color: var(--grey-light);
        }

        /* --- Item Table --- */
        #itemTable {
            width: 100%;
            border-collapse: collapse; 
            margin-bottom: 1rem;
            border: 1px solid var(--grey-mid); 
        }
        #itemTable th, #itemTable td {
            text-align: left;
            padding: 0.75rem;
            border: 1px solid var(--grey-mid); 
            font-size: 0.9rem;
            vertical-align: middle;
        }
        #itemTable th {
            color: var(--text-secondary);
            font-weight: 600;
            background-color: #f9f9f9;
        }
        /* Item Table Column widths */
        #itemTable th:nth-child(1), #itemTable td:nth-child(1) { width: 30%; } /* Description */
        #itemTable th:nth-child(2), #itemTable td:nth-child(2) { width: 8%; } /* Qty */
        #itemTable th:nth-child(3), #itemTable td:nth-child(3) { width: 12%; } /* Unit Wt */
        #itemTable th:nth-child(4), #itemTable td:nth-child(4) { width: 12%; } /* Unit Val */
        #itemTable th:nth-child(5), #itemTable td:nth-child(5) { width: 12%; } /* Total Wt */
        #itemTable th:nth-child(6), #itemTable td:nth-child(6) { width: 12%; } /* Total Val */
        #itemTable th:nth-child(8), #itemTable td:nth-child(8) { width: 5%; text-align: center; } /* Delete */


        /* --- Summary Section --- */
        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.75rem 1rem;
            align-items: center;
            max-width: 500px;
        }
        .summary-grid strong {
            color: var(--text-secondary);
            text-align: right;
        }
        .summary-total {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .summary-input {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid var(--grey-mid);
            border-radius: 8px;
            width: 100px;
        }

        /* --- Mobile-First Responsive --- */
        @media (max-width: 1024px) { 
             :root {
                --sidebar-width: 100%;
            }
            body {
                flex-direction: column; /* Stack sidebar and content */
            }
            .sidebar {
                height: auto;
                position: relative; /* Change from fixed to relative */
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--grey-mid);
                z-index: 1; /* Ensure it doesn't overlap content weirdly */
            }
            .sidebar-nav {
                display: flex;
                justify-content: space-around; /* Spread out links */
                margin-top: 0;
            }
            .sidebar-nav li a {
                margin: 0.25rem;
                padding: 0.5rem 0.75rem;
                text-align: center;
            }
            .sidebar-header {
                text-align: center;
                border-bottom: none;
                padding-bottom: 0.5rem; /* Reduced padding */
            }

            .main-content-area {
                margin-left: 0; /* Remove margin */
                width: 100%;
                height: auto;
                overflow-y: visible;
            }

            header { padding: 1rem; } 
            header h1 { font-size: 1.25rem; }
            .container { padding: 0 1rem; } 
            #tab-customer-database .container { padding: 0 1rem; } 

            .card {
                padding: 1rem;
            }
            .form-grid, .form-grid-half {
                grid-template-columns: 1fr;
            }
            .item-form-grid {
                grid-template-columns: 1fr; /* Stack add-item form */
            }

            #itemTable {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            #itemTable th, #itemTable td {
                min-width: 100px;
            }
            #itemTable th:first-child, #itemTable td:first-child {
                min-width: 200px; /* Give description more space */
            }
            .info-grid {
                grid-template-columns: 100px 1fr;
            }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            📦 Bee26 Cargo
        </div>
        <ul class="sidebar-nav">
            <li><a href="#" class="sidebar-link active" data-tab="tab-customer-details">Customer Details</a></li>
            <li><a href="#" class="sidebar-link" data-tab="tab-customer-database">Customer Database</a></li>
            <li><a href="#" class="sidebar-link" data-tab="tab-shipment-tracker">Shipment Tracker</a></li>
            <li><a href="#" class="sidebar-link" data-tab="tab-payment-tracker">Payment Tracker</a></li>
        </ul>
    </nav>

    <div class="main-content-area">

        <header>
            <h1>Personal Cargo Manager</h1>
            </header>

        <div class="tab-container">

            <div id="tab-customer-details" class="tab-content active">
                
                <main class="container">
                    <div class="history-buttons">
                        <button id="undoBtn" class="btn-history" disabled>Undo</button>
                        <button id="redoBtn" class="btn-history" disabled>Redo</button>
                    </div>

                    <section class="card">
                        <h2><span class="icon">👤</span> Customer Details</h2>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="senderName">Sender Name</label>
                                <input type="text" id="senderName" placeholder="John Doe">
                            </div>
                            <div class="input-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Jane Smith">
                            </div>
                            <div class="input-group">
                                <label for="receiverPhone">Receiver Phone (Sri Lanka)</label>
                                <input type="tel" id="receiverPhone" placeholder="+94 77 123 4567">
                            </div>
                            <div class="input-group full-width">
                                <label for="receiverAddress">Receiver Address (Sri Lanka)</label>
                                <textarea id="receiverAddress" rows="3" placeholder="No. 123, Main Street, Colombo 03"></textarea>
                            </div>
                            <div class="input-group full-width">
                                <label for="fileUpload">Attach ID (NIC, Passport) - Optional</label>
                                <input type="file" id="fileUpload" accept="image/*,.pdf">
                            </div>
                        </div>
                        
                        </section>
            
                    <section class="card">
                        <h2><span class="icon">🛍️</span> Itemized List</h2>
                        <table id="itemTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Wt. (kg)</th>
                                    <th>Unit Val. (CAD)</th>
                                    <th>Total Wt.</th>
                                    <th>Total Val.</th>
                                    <th>Remarks</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="itemTbody">
                                </tbody>
                        </table>
                        
                        <form id="addItemForm" class="item-form-grid">
                            <div class="input-group">
                                <label>Description</label>
                                <input type="text" id="itemDesc" placeholder="e.g., Men's T-Shirts" required>
                            </div>
                            <div class="input-group">
                                <label>Quantity</label>
                                <input type="number" id="itemQty" placeholder="10" min="1" step="1" required>
                            </div>
                            <div class="input-group">
                                <label>Unit Weight (kg)</label>
                                <input type="number" id="itemWeight" placeholder="0.5" min="0" step="0.1" required>
                            </div>
                            <div class="input-group">
                                <label>Unit Value (CAD)</label>
                                <input type="number" id="itemValue" placeholder="15.00" min="0" step="0.01" required>
                            </div>
                            <div class="input-group">
                                <label>Remarks</label>
                                <input type="text" id="itemRemarks" placeholder="Brand, color, etc.">
                            </div>
                            <button type="submit" class="btn btn-add">Add Item +</button>
                        </form>
                    </section>
            
                    <section class="card">
                        <h2><span class="icon">📊</span> Shipment Summary & Outputs</h2>
                        
                        <div class="output-section">
                            <h3>AWB Prep Info</h3>
                            <div class="summary-grid">
                                <div><strong>From:</strong></div>
                                <div>Bee26 Cargo Services, Toronto</div>
                                
                                <div><strong>To:</strong></div>
                                <div id="summaryReceiver">--</div>
            
                                <div><strong>Total Packages:</strong></div>
                                <input type="number" id="totalPackages" class="summary-input" placeholder="e.g., 2">
                                
                                <div><strong>Total Weight:</strong></div>
                                <div id="summaryWeight" class="summary-total">0.00 kg</div>
                                
                                <div><strong>Declared Value:</strong></div>
                                <div id="summaryValue" class="summary-total">$0.00 CAD</div>
                            </div>
                        </div>
            
                        <div class="output-section">
                            <h3>Packing List</h3>
                            <p><strong>Declaration:</strong> Personal Use – Not for Resale</p>
                            <div class="button-group">
                                <button id="printPackingListBtn" class="btn btn-print">Print</button>
                                <button id="exportPackingListPDF" class="btn">Download PDF</button>
                                <button id="exportPackingListExcel" class="btn btn-secondary">Download Excel</button>
                            </div>
                        </div>
            
                        <div class="output-section">
                            <h3>Commercial Invoice</h3>
                            <div class="form-grid-half">
                                <div class="input-group">
                                    <label for="invoiceNumber">Invoice Number</label>
                                    <input type="text" id="invoiceNumber" placeholder="BEE26-1001">
                                </div>
                                <div class="input-group">
                                    <label for="invoiceDate">Date</label>
                                    <input type="date" id="invoiceDate">
                                </div>
                                <div class="input-group">
                                    <label for="hsCode">HS Code (Optional)</label>
                                    <input type="text" id="hsCode" placeholder="e.g., 6109.10">
                                </div>
                            </div>
                            <div class="button-group">
                                <button id="printInvoiceBtn" class="btn btn-print">Print</button>
                                <button id="exportInvoicePDF" class="btn">Download PDF</button>
                                <button id="exportInvoiceExcel" class="btn btn-secondary">Download Excel</button>
                            </div>
                        </div>
            
                    </section>

                    <div class="customer-submit-group">
                        <button id="submitCustomerBtn" class="btn">Submit Customer to Database</button>
                    </div>

                </main>
                </div>

            <div id="tab-customer-database" class="tab-content">
                <main class="container"> 
                    <section class="card">
                        <h2><span class="icon">📂</span> Customer Database</h2>
                        <div class="input-group search-bar">
                            <label for="customerSearch">Search by Sender or Receiver Name</label>
                            <input type="text" id="customerSearch" placeholder="Search...">
                        </div>
                    </section>

                    <section class="card">
                        <div class="table-container">
                            <table id="customerTable" class="table-google-sheets">
                                <thead>
                                    <tr>
                                        <th>#</th> 
                                        <th>Sender Name</th>
                                        <th>Receiver Name</th>
                                        <th>Receiver Phone</th>
                                        <th>Receiver Address</th>
                                        <th>Date Added</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customerTableTbody">
                                    </tbody>
                            </table>
                        </div>
                    </section>
                </main>
            </div>
            
            <div id="tab-shipment-tracker" class="tab-content">
                <main class="container">
                    <section class="card">
                        <h2><span class="icon">✈️</span> Shipment Tracker</h2>
                        <div class="input-group search-bar">
                            <label for="shipmentSearch">Search by Customer Name or Invoice #</label>
                            <input type="text" id="shipmentSearch" placeholder="Search...">
                        </div>
                    </section>
                    
                    <section class="card">
                        <h3>Customer Info</h3>
                        <div class="info-grid">
                            <strong>Sender:</strong> <div id="stSenderName">--</div>
                            <strong>Receiver:</strong> <div id="stReceiverName">--</div>
                            <strong>Phone:</strong> <div id="stReceiverPhone">--</div>
                            <strong>Address:</strong> <div id="stReceiverAddress">--</div>
                        </div>
                    </section>

                    <section class="card">
                        <h3>Flight Details</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="flightAirline">Airline</label>
                                <input type="text" id="flightAirline" placeholder="e.g., Air Canada">
                            </div>
                            <div class="input-group">
                                <label for="flightNumber">Flight Number</label>
                                <input type="text" id="flightNumber" placeholder="e.g., AC123">
                            </div>
                            <div class="input-group">
                                <label for="flightEtd">ETD (Est. Time of Departure)</label>
                                <input type="datetime-local" id="flightEtd">
                            </div>
                            <div class="input-group">
                                <label for="flightEta">ETA (Est. Time of Arrival)</label>
                                <input type="datetime-local" id="flightEta">
                            </div>
                            <div class="input-group full-width">
                                <label for="flightNotes">Tracking Notes</label>
                                <textarea id="flightNotes" rows="3" placeholder="e.g., Arrived in CMB, pending customs..."></textarea>
                            </div>
                        </div>
                    </section>

                </main>
            </div>
            <div id="tab-payment-tracker" class="tab-content">
                <main class="container">
                    <section class="card">
                        <h2><span class="icon">💳</span> Payment Tracker</h2>
                         <div class="input-group search-bar">
                            <label for="paymentSearch">Search by Customer Name or Invoice #</label>
                            <input type="text" id="paymentSearch" placeholder="Search...">
                        </div>
                    </section>

                    <section class="card">
                        <h3>Payment Details</h3>
                        <div class="form-grid">
                             <div class="input-group">
                                <label for="paymentInvoice">Invoice Number</label>
                                <input type="text" id="paymentInvoice" placeholder="BEE26-1001" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentDate">Date</label>
                                <input type="date" id="paymentDate" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentCustomer">Customer Name</label>
                                <input type="text" id="paymentCustomer" placeholder="John Doe" disabled>
                            </div>
                            <div class="input-group">
                                <label for="paymentTotal">Total Amount (CAD)</label>
                                <input type="number" id="paymentTotal" placeholder="0.00" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentPaid">Amount Paid (CAD)</label>
                                <input type="number" id="paymentPaid" placeholder="0.00" min="0" step="0.01">
                            </div>
                             <div class="input-group">
                                <label for="paymentBalance">Balance (CAD)</label>
                                <input type="number" id="paymentBalance" placeholder="0.00" disabled>
                            </div>
                             <div class="input-group">
                                <label for="paymentMethod">Payment Method</label>
                                <select id="paymentMethod">
                                    <option value="">Select Method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="E-Transfer">E-Transfer</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Bank Deposit">Bank Deposit</option>
                                </select>
                            </div>
                            <div class="input-group full-width">
                                <label for="paymentNotes">Payment Notes</label>
                                <textarea id="paymentNotes" rows="3" placeholder="e.g., Paid $100 cash on Oct 27..."></textarea>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
            </div>
        <footer>
            <p>Bee26 Cargo Services • Toronto • +1 416-474-4994</p>
        </footer>

    </div> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js"; // Optional: Keep if you use Analytics
      import { getDatabase, ref, set, get, child, push, remove, update, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js"; // <-- Add Database import

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDwTq2Nv5LFDHwXJheJpFl9Elzki_kLIYc", // Replace with your actual API key
        authDomain: "bee26cargo.firebaseapp.com",
        databaseURL: "https://bee26cargo-default-rtdb.firebaseio.com",
        projectId: "bee26cargo",
        storageBucket: "bee26cargo.firebasestorage.app",
        messagingSenderId: "993500227965",
        appId: "1:993500227965:web:ab01dad6925bda54890414",
        measurementId: "G-M1L7S06496" // Optional
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // const analytics = getAnalytics(app); // Optional
      const database = getDatabase(app); // <-- Get Database reference

      // Make database functions globally accessible (needed by the next module)
      window.firebaseDB = database;
      window.firebaseDBRef = ref; 
      window.firebaseDBSet = set; 
      window.firebaseDBGet = get; 
      window.firebaseDBChild = child; 
      window.firebaseDBPush = push; 
      window.firebaseDBRemove = remove; 
      window.firebaseDBUpdate = update; 
      window.firebaseDBOnValue = onValue; 

    </script>

    <script type="module"> 
        
        // Ensure DOM is ready before accessing elements or Firebase functions
        // The DOMContentLoaded listener is crucial here
        document.addEventListener('DOMContentLoaded', () => {

            // Access Firebase Database Functions made global in the previous script
            // Ensure these are accessed *inside* DOMContentLoaded
            const db = window.firebaseDB;
            const dbRef = window.firebaseDBRef;
            const dbSet = window.firebaseDBSet;
            const dbGet = window.firebaseDBGet;
            const dbChild = window.firebaseDBChild;
            const dbPush = window.firebaseDBPush;
            const dbRemove = window.firebaseDBRemove;
            const dbUpdate = window.firebaseDBUpdate;
            const dbOnValue = window.firebaseDBOnValue;
            
            // Defensive check if Firebase failed to initialize
            if (!db) {
                console.error("Firebase Database reference (db) is not available!");
                alert("Error: Cannot connect to the database. Please check Firebase setup.");
                return; // Stop script execution if DB isn't ready
            }


            // --- 1. Get all the important HTML elements ---
            
            // -- Tab 1 (Customer Details) --
            const senderNameEl = document.getElementById('senderName');
            const receiverNameEl = document.getElementById('receiverName');
            const receiverPhoneEl = document.getElementById('receiverPhone');
            const receiverAddressEl = document.getElementById('receiverAddress');
            const totalPackagesEl = document.getElementById('totalPackages');
            const invoiceNumberEl = document.getElementById('invoiceNumber');
            const invoiceDateEl = document.getElementById('invoiceDate');
            const hsCodeEl = document.getElementById('hsCode');
            const submitCustomerBtn = document.getElementById('submitCustomerBtn'); 

            const addItemForm = document.getElementById('addItemForm');
            const itemTbody = document.getElementById('itemTbody');
            
            const summaryReceiver = document.getElementById('summaryReceiver');
            const summaryWeight = document.getElementById('summaryWeight');
            const summaryValue = document.getElementById('summaryValue');

            const exportPackingListPDF = document.getElementById('exportPackingListPDF');
            const exportPackingListExcel = document.getElementById('exportPackingListExcel');
            const exportInvoicePDF = document.getElementById('exportInvoicePDF');
            const exportInvoiceExcel = document.getElementById('exportInvoiceExcel');
            
            const printPackingListBtn = document.getElementById('printPackingListBtn');
            const printInvoiceBtn = document.getElementById('printInvoiceBtn');


            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            // -- Tab 2 (Customer Database) --
            const customerSearchEl = document.getElementById('customerSearch');
            const customerTableTbody = document.getElementById('customerTableTbody');

            // -- Tab 3 (Shipment Tracker) --
            const stSenderName = document.getElementById('stSenderName');
            const stReceiverName = document.getElementById('stReceiverName');
            const stReceiverPhone = document.getElementById('stReceiverPhone');
            const stReceiverAddress = document.getElementById('stReceiverAddress');
            const flightAirlineEl = document.getElementById('flightAirline');
            const flightNumberEl = document.getElementById('flightNumber');
            const flightEtdEl = document.getElementById('flightEtd');
            const flightEtaEl = document.getElementById('flightEta');
            const flightNotesEl = document.getElementById('flightNotes');

            // -- Tab 4 (Payment Tracker) --
            const paymentInvoiceEl = document.getElementById('paymentInvoice');
            const paymentDateEl = document.getElementById('paymentDate');
            const paymentCustomerEl = document.getElementById('paymentCustomer');
            const paymentTotalEl = document.getElementById('paymentTotal');
            const paymentPaidEl = document.getElementById('paymentPaid');
            const paymentBalanceEl = document.getElementById('paymentBalance');
            const paymentMethodEl = document.getElementById('paymentMethod');
            const paymentNotesEl = document.getElementById('paymentNotes');

            // -- Tab Navigation --
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const tabContents = document.querySelectorAll('.tab-content');

            // --- 2. State Variables ---
            let items = [];
            let historyStack = [];
            let redoStack = [];
            
            let customerDatabase = [];
            let currentEditCustomerId = null;


            // --- 3. Core Functions ---

            /**
             * Redraws the item table based on the 'items' array
             */
            function renderTable() {
                itemTbody.innerHTML = ''; // Clear the table first
                let totalWeight = 0;
                let totalValue = 0;
                let totalQty = 0;

                // Ensure items is an array before iterating
                if (!Array.isArray(items)) {
                    items = []; 
                    console.warn("'items' was not an array, reset to empty array.");
                }

                items.forEach((item, index) => {
                    // Provide default values if item properties are missing/invalid
                    const qty = parseFloat(item.qty) || 0;
                    const weight = parseFloat(item.weight) || 0;
                    const value = parseFloat(item.value) || 0;
                    const desc = item.desc || '';
                    const remarks = item.remarks || '';

                    const itemTotalWeight = qty * weight;
                    const itemTotalValue = qty * value;
                    
                    totalWeight += itemTotalWeight;
                    totalValue += itemTotalValue;
                    totalQty += qty;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${desc}</td>
                        <td>${qty}</td>
                        <td>${weight.toFixed(2)}</td>
                        <td>${value.toFixed(2)}</td>
                        <td>${itemTotalWeight.toFixed(2)}</td>
                        <td>${itemTotalValue.toFixed(2)}</td>
                        <td>${remarks}</td>
                        <td>
                            <button class="btn-delete" data-index="${index}">🗑️</button>
                        </td>
                    `;
                    itemTbody.appendChild(row);
                });

                updateSummary(totalQty, totalWeight, totalValue);
            }
            
            // --- Customer Database Functions ---
            
            /**
             * Renders the customer database table, with optional filter
             */
            function renderCustomerDatabaseTable(filter = '') {
                customerTableTbody.innerHTML = '';
                const searchTerm = filter.toLowerCase();
                
                // Ensure customerDatabase is an array
                if (!Array.isArray(customerDatabase)) {
                    customerDatabase = [];
                    console.warn("'customerDatabase' was not an array, reset to empty array.");
                }
                
                const filteredDB = customerDatabase.filter(customer => {
                    if (!customer) return false; // Skip null/undefined entries
                    const senderMatch = customer.senderName && customer.senderName.toLowerCase().includes(searchTerm);
                    const receiverMatch = customer.receiverName && customer.receiverName.toLowerCase().includes(searchTerm);
                    return senderMatch || receiverMatch;
                });

                if (filteredDB.length === 0) {
                     customerTableTbody.innerHTML = `<tr><td colspan="7">No customers found${filter ? ' matching your search' : ''}.</td></tr>`;
                     return;
                }

                filteredDB.forEach((customer, index) => { 
                    const row = document.createElement('tr');
                    // Use a fallback for potentially invalid dates/ids
                    const timestamp = customer.id ? new Date(customer.id).toLocaleDateString() : 'N/A'; 
                    row.innerHTML = `
                        <td>${index + 1}</td> 
                        <td>${customer.senderName || ''}</td>
                        <td>${customer.receiverName || ''}</td>
                        <td>${customer.receiverPhone || ''}</td>
                        <td>${(customer.receiverAddress || '').split('\n')[0]}...</td>
                        <td>${timestamp}</td>
                        <td>
                            <button class="btn-table btn-use" data-id="${customer.id}">Auto-fill</button>
                            <button class="btn-table btn-edit" data-id="${customer.id}">✏️ Edit</button>
                            <button class="btn-table btn-delete-db" data-id="${customer.id}">🗑️ Delete</button>
                        </td>
                    `;
                    customerTableTbody.appendChild(row);
                });
            }

            /**
             * Saves the customer database to local storage (Firebase version commented out)
             */
            function saveCustomerDB() {
                localStorage.setItem('bee26CustomerDB', JSON.stringify(customerDatabase));
                // TODO: Replace with Firebase save later
                // dbSet(dbRef(db, 'customers'), customerDatabase)
                //  .then(() => console.log("Customer DB saved to Firebase"))
                //  .catch(error => console.error("Error saving customer DB:", error));
            }
            
            /**
             * Clears the main customer input form
             */
            function clearCustomerForm() {
                senderNameEl.value = '';
                receiverNameEl.value = '';
                receiverPhoneEl.value = '';
                receiverAddressEl.value = '';
                const fileInput = document.getElementById('fileUpload');
                fileInput.value = ''; 
                 if (fileInput.value) { 
                     try {
                        fileInput.type = 'text';
                        fileInput.type = 'file';
                     } catch(e) {}
                 }
                 // Also reset edit state
                 currentEditCustomerId = null;
                 submitCustomerBtn.textContent = 'Submit Customer to Database';
                 submitCustomerBtn.classList.remove('btn-secondary');
            }
            // --- End Customer DB Functions ---


            /**
             * Updates the "Shipment Summary" section AND all other tracker tabs
             */
            function updateSummary(totalQty, totalWeight, totalValue) {
                const senderName = senderNameEl.value;
                const receiverName = receiverNameEl.value;
                const receiverPhone = receiverPhoneEl.value;
                const receiverAddress = receiverAddressEl.value;
                const receiverAddressShort = (receiverAddress || '').split('\n')[0];
                const invoiceNumber = invoiceNumberEl.value;
                const invoiceDate = invoiceDateEl.value;

                // Update AWB section
                if (receiverName && receiverAddressShort) {
                    summaryReceiver.textContent = `${receiverName}, ${receiverAddressShort}`;
                } else if (receiverName) {
                    summaryReceiver.textContent = receiverName;
                } else {
                    summaryReceiver.textContent = '--';
                }
                
                summaryWeight.textContent = `${totalWeight.toFixed(2)} kg`;
                summaryValue.textContent = `$${totalValue.toFixed(2)} CAD`;

                // Update Shipment Tracker Tab
                stSenderName.textContent = senderName || '--';
                stReceiverName.textContent = receiverName || '--';
                stReceiverPhone.textContent = receiverPhone || '--';
                stReceiverAddress.textContent = receiverAddress || '--';

                // Update Payment Tracker Tab
                paymentInvoiceEl.value = invoiceNumber || '';
                paymentDateEl.value = invoiceDate || '';
                paymentCustomerEl.value = senderName || '';
                paymentTotalEl.value = totalValue.toFixed(2);
                calculatePaymentBalance(); 
            }
            
            /**
             * Saves the CURRENT SHIPMENT data from ALL TABS to local storage (Firebase version commented out)
             */
            function saveData() {
                try {
                    const data = {
                        senderName: senderNameEl.value,
                        receiverName: receiverNameEl.value,
                        receiverPhone: receiverPhoneEl.value,
                        receiverAddress: receiverAddressEl.value,
                        totalPackages: totalPackagesEl.value,
                        invoiceNumber: invoiceNumberEl.value,
                        invoiceDate: invoiceDateEl.value,
                        hsCode: hsCodeEl.value,
                        items: items,
                        flightDetails: {
                            airline: flightAirlineEl.value,
                            number: flightNumberEl.value,
                            etd: flightEtdEl.value,
                            eta: flightEtaEl.value,
                            notes: flightNotesEl.value,
                        },
                        paymentDetails: {
                            paid: paymentPaidEl.value,
                            method: paymentMethodEl.value,
                            notes: paymentNotesEl.value,
                        }
                    };
                    localStorage.setItem('bee26Data', JSON.stringify(data));
                    // TODO: Replace with Firebase save later
                    // dbSet(dbRef(db, 'currentShipment'), data)
                    //   .then(() => console.log("Current shipment saved to Firebase"))
                    //   .catch(error => console.error("Error saving shipment:", error));
                } catch (error) {
                    console.error("Error saving data:", error);
                    // Optionally alert the user or log more details
                }
            }

            /**
             * Loads all data from local storage on page start (Firebase version commented out)
             */
            function loadData() {
                try {
                    // Load current shipment data
                    const data = JSON.parse(localStorage.getItem('bee26Data'));
                    if (!data) {
                        invoiceDateEl.valueAsDate = new Date();
                    } else {
                        senderNameEl.value = data.senderName || '';
                        receiverNameEl.value = data.receiverName || '';
                        receiverPhoneEl.value = data.receiverPhone || '';
                        receiverAddressEl.value = data.receiverAddress || '';
                        totalPackagesEl.value = data.totalPackages || '';
                        invoiceNumberEl.value = data.invoiceNumber || '';
                        invoiceDateEl.value = data.invoiceDate || '';
                        hsCodeEl.value = data.hsCode || '';
                        items = data.items || [];
                        
                        if (!data.invoiceDate) {
                            invoiceDateEl.valueAsDate = new Date();
                        }
                        if (data.flightDetails) {
                            flightAirlineEl.value = data.flightDetails.airline || '';
                            flightNumberEl.value = data.flightDetails.number || '';
                            flightEtdEl.value = data.flightDetails.etd || '';
                            flightEtaEl.value = data.flightDetails.eta || '';
                            flightNotesEl.value = data.flightDetails.notes || '';
                        }
                        if (data.paymentDetails) {
                            paymentPaidEl.value = data.paymentDetails.paid || '';
                            paymentMethodEl.value = data.paymentDetails.method || '';
                            paymentNotesEl.value = data.paymentDetails.notes || '';
                        }
                    }
                    
                    // Load Customer Database
                    const dbData = JSON.parse(localStorage.getItem('bee26CustomerDB'));
                    customerDatabase = Array.isArray(dbData) ? dbData : []; // Ensure it's an array

                } catch (error) {
                     console.error("Error loading data from localStorage:", error);
                     // Initialize with defaults if loading fails
                     items = [];
                     customerDatabase = [];
                     invoiceDateEl.valueAsDate = new Date();
                } finally {
                    // Always try to render, even if loading failed
                    renderTable(); 
                    renderCustomerDatabaseTable(); 
                    historyStack = [];
                    redoStack = [];
                    updateHistoryButtons();
                }

                // TODO: Replace localStorage load with Firebase load later
                /*
                // Load Customer DB from Firebase
                dbGet(dbChild(dbRef(db), 'customers')).then((snapshot) => {
                  if (snapshot.exists()) {
                    customerDatabase = snapshot.val() || []; // Ensure array
                  } else {
                    console.log("No customer data available in Firebase");
                    customerDatabase = []; 
                  }
                  renderCustomerDatabaseTable(); 
                }).catch((error) => {
                  console.error("Error loading customer DB:", error);
                  alert("Error loading customer data from database.");
                  customerDatabase = []; // Reset on error
                  renderCustomerDatabaseTable(); 
                }).finally(() => {
                    // Load Current Shipment from Firebase (runs after customer DB load attempt)
                    dbGet(dbChild(dbRef(db), 'currentShipment')).then((snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            // ... (populate fields like in localStorage load) ...
                             items = data.items || [];
                        } else {
                            console.log("No current shipment data in Firebase");
                            items = []; // Reset items
                            invoiceDateEl.valueAsDate = new Date(); // Set default date
                        }
                    }).catch((error) => {
                        console.error("Error loading shipment:", error);
                        alert("Error loading current shipment data.");
                        items = []; // Reset items
                    }).finally(() => {
                        renderTable(); // Render shipment table after loading it
                        historyStack = [];
                        redoStack = [];
                        updateHistoryButtons();
                    });
                });
                */
            }

            // --- Payment Balance Calculator ---
            function calculatePaymentBalance() {
                const total = parseFloat(paymentTotalEl.value) || 0;
                const paid = parseFloat(paymentPaidEl.value) || 0;
                const balance = total - paid;
                paymentBalanceEl.value = balance.toFixed(2);
            }

            // --- History Functions ---
            function saveState() {
                historyStack.push(JSON.parse(JSON.stringify(items)));
                redoStack = [];
                updateHistoryButtons();
            }
            function updateHistoryButtons() {
                undoBtn.disabled = historyStack.length === 0;
                redoBtn.disabled = redoStack.length === 0;
            }
            function undo() {
                if (historyStack.length > 0) {
                    redoStack.push(JSON.parse(JSON.stringify(items)));
                    items = historyStack.pop();
                    renderTable();
                    saveData();
                    updateHistoryButtons();
                }
            }
            function redo() {
                if (redoStack.length > 0) {
                    historyStack.push(JSON.parse(JSON.stringify(items)));
                    items = redoStack.pop();
                    renderTable();
                    saveData();
                    updateHistoryButtons();
                }
            }
            // --- End History ---


            // --- 4. Event Listeners (Making buttons work) ---

            // --- Tab Switching ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(t => t.classList.remove('active'));
                    link.classList.add('active');
                    const tabId = link.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });


            // --- Tab 1 Listeners ---
            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                saveState(); // Save history
                const item = {
                    desc: document.getElementById('itemDesc').value,
                    qty: parseFloat(document.getElementById('itemQty').value) || 1, // Default qty to 1
                    weight: parseFloat(document.getElementById('itemWeight').value) || 0, // Default weight to 0
                    value: parseFloat(document.getElementById('itemValue').value) || 0, // Default value to 0
                    remarks: document.getElementById('itemRemarks').value
                };
                items.push(item);
                renderTable(); 
                saveData(); // Save to localStorage/Firebase
                addItemForm.reset(); 
            });

            itemTbody.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete')) {
                    if (confirm('Are you sure you want to delete this item?')) {
                        saveState(); // Save history
                        const index = e.target.getAttribute('data-index');
                        items.splice(index, 1);
                        renderTable();
                        saveData(); // Save to localStorage/Firebase
                    }
                }
            });

            // Auto-save for Tab 1 *shipment* fields
            const fieldsToAutoSave = [
                senderNameEl, receiverNameEl, receiverPhoneEl, receiverAddressEl,
                totalPackagesEl, invoiceNumberEl, invoiceDateEl, hsCodeEl
            ];
            fieldsToAutoSave.forEach(field => {
                field.addEventListener('input', () => {
                    saveData();
                    renderTable(); // This calls updateSummary
                });
            });

            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);

            // Tab 1 Customer DB Submit Listener 
            submitCustomerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const senderName = senderNameEl.value.trim();
                const receiverName = receiverNameEl.value.trim();
                
                if (!senderName && !receiverName) {
                    alert('Please enter at least a Sender or Receiver name to save to the database.');
                    return;
                }

                if (currentEditCustomerId) {
                    // --- EDIT MODE ---
                    const customerIndex = customerDatabase.findIndex(c => c.id === currentEditCustomerId);
                    if (customerIndex > -1) {
                        customerDatabase[customerIndex] = {
                            ...customerDatabase[customerIndex], // Keep original ID
                            senderName: senderName,
                            receiverName: receiverName,
                            receiverPhone: receiverPhoneEl.value,
                            receiverAddress: receiverAddressEl.value,
                        };
                         alert('Customer updated successfully!');
                    } else {
                         alert('Error: Could not find customer to update.');
                    }
                } else {
                    // --- NEW CUSTOMER MODE ---
                    const newCustomer = {
                        id: Date.now(), // Use timestamp as unique ID
                        senderName: senderName,
                        receiverName: receiverName,
                        receiverPhone: receiverPhoneEl.value,
                        receiverAddress: receiverAddressEl.value,
                    };
                    customerDatabase.push(newCustomer);
                    alert('Customer added successfully!');
                }
                
                saveCustomerDB(); // Save to localStorage/Firebase
                renderCustomerDatabaseTable(); // Update the table view
                clearCustomerForm(); // Also resets edit state
                
                document.querySelector('[data-tab="tab-customer-database"]').click(); // Switch to DB tab
            });

            // Tab 2 (Customer Database) Listeners 
            customerSearchEl.addEventListener('input', (e) => {
                renderCustomerDatabaseTable(e.target.value);
            });
            
            customerTableTbody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return; 

                const id = parseInt(button.dataset.id);
                if (!id) return;

                if (button.classList.contains('btn-delete-db')) {
                    if (confirm('Are you sure you want to permanently delete this customer from the database?')) {
                        customerDatabase = customerDatabase.filter(c => c.id !== id);
                        saveCustomerDB();
                        renderCustomerDatabaseTable(customerSearchEl.value); 
                    }
                }
                
                if (button.classList.contains('btn-edit')) {
                    const customer = customerDatabase.find(c => c.id === id);
                    if (customer) {
                        senderNameEl.value = customer.senderName || '';
                        receiverNameEl.value = customer.receiverName || '';
                        receiverPhoneEl.value = customer.receiverPhone || '';
                        receiverAddressEl.value = customer.receiverAddress || '';
                        
                        currentEditCustomerId = id;
                        submitCustomerBtn.textContent = 'Save Changes to Database';
                        submitCustomerBtn.classList.add('btn-secondary'); 
                        
                        document.querySelector('[data-tab="tab-customer-details"]').click();
                    }
                }
                
                if (button.classList.contains('btn-use')) {
                    const customer = customerDatabase.find(c => c.id === id);
                    if (customer) {
                        senderNameEl.value = customer.senderName || '';
                        receiverNameEl.value = customer.receiverName || '';
                        receiverPhoneEl.value = customer.receiverPhone || '';
                        receiverAddressEl.value = customer.receiverAddress || '';
                        
                        renderTable(); 
                        saveData(); 
                        
                        document.querySelector('[data-tab="tab-customer-details"]').click();
                    }
                }
            });


            // --- Tab 3 (Shipment Tracker) Listeners (Auto-save) ---
            const flightFieldsToAutoSave = [
                flightAirlineEl, flightNumberEl, flightEtdEl, flightEtaEl, flightNotesEl
            ];
            flightFieldsToAutoSave.forEach(field => {
                field.addEventListener('input', saveData);
            });

            // --- Tab 4 (Payment Tracker) Listeners (Auto-save & Calculate) ---
            const paymentFieldsToAutoSave = [
                paymentPaidEl, paymentMethodEl, paymentNotesEl
            ];
            paymentFieldsToAutoSave.forEach(field => {
                field.addEventListener('input', () => {
                    calculatePaymentBalance();
                    saveData();
                });
            });


            // --- 5. PDF & Excel Export Functions ---
            
            function addPdfBranding(doc, title) {
                // Ensure jsPDF instance is valid
                if (!doc || typeof doc.setFontSize !== 'function') {
                    console.error("Invalid jsPDF document passed to addPdfBranding");
                    return;
                }
                try {
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("📦 Bee26 Cargo Services", 14, 22);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text(title, 105, 32, { align: "center" });
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "normal");
                    // Ensure page height is sufficient before adding footer, adjust Y if needed
                    const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
                    doc.text("Bee26 Cargo Services • Toronto • +1 416-474-4994", 105, pageHeight - 12, { align: "center" });
                } catch (error) {
                     console.error("Error in addPdfBranding:", error);
                }
            }

            // MODIFIED: Added 'action' parameter ('save' or 'open')
            function generatePDF(docType, action = 'save') { 
                try { 
                    // Make sure jsPDF and autoTable are loaded
                    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                        console.error("jsPDF library not loaded correctly.");
                        alert("Error: jsPDF library not found. Cannot generate PDF.");
                        return;
                    }
                     // Check if autoTable function exists globally or on prototype
                    const jsPDF = window.jspdf.jsPDF;
                    const doc = new jsPDF();
                     if (typeof doc.autoTable !== 'function') {
                         console.error("jsPDF-AutoTable plugin not loaded correctly.");
                         alert("Error: jsPDF-AutoTable plugin not found. Cannot generate table in PDF.");
                         // Attempt to load dynamically if missing (advanced, optional)
                         // Or just return
                         return;
                    }
                    
                    addPdfBranding(doc, docType);

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("FROM (Sender):", 14, 45);
                    doc.text("TO (Receiver):", 105, 45);

                    doc.setFont("helvetica", "normal");
                    doc.text(senderNameEl.value || '', 14, 50); 
                    doc.text("Bee26 Cargo Services", 14, 55);
                    doc.text("Toronto, ON, Canada", 14, 60);

                    doc.text(receiverNameEl.value || '', 105, 50); 
                    doc.text(receiverPhoneEl.value || '', 105, 55); 
                    const receiverAddressLines = doc.splitTextToSize(receiverAddressEl.value || '', 80); 
                    doc.text(receiverAddressLines, 105, 60);

                    let tableStartY = 75;
                    if (docType === 'Commercial Invoice') {
                        doc.setFont("helvetica", "bold");
                        doc.text("Invoice #: ", 14, tableStartY);
                        doc.text("Date: ", 105, tableStartY);
                        doc.setFont("helvetica", "normal");
                        doc.text(invoiceNumberEl.value || '', 40, tableStartY); 
                        doc.text(invoiceDateEl.value || '', 120, tableStartY); 
                        
                        if (hsCodeEl.value) {
                            doc.setFont("helvetica", "bold");
                            doc.text("HS Code (Overall): ", 14, tableStartY + 5);
                            doc.setFont("helvetica", "normal");
                            doc.text(hsCodeEl.value, 45, tableStartY + 5);
                        }
                        tableStartY += 15;
                    }

                    const tableHead = [
                        ['Qty', 'Description', 'Remarks', 'Unit Value (CAD)', 'Total Value (CAD)', 'Unit Wt. (kg)', 'Total Wt. (kg)']
                    ];
                    // Ensure items is an array before mapping
                    const safeItems = Array.isArray(items) ? items : [];
                    const tableBody = safeItems.map(item => {
                         const qty = parseFloat(item.qty) || 0;
                         const weight = parseFloat(item.weight) || 0;
                         const value = parseFloat(item.value) || 0;
                         return [
                            qty,
                            item.desc || '', 
                            item.remarks || '', 
                            value.toFixed(2),
                            (qty * value).toFixed(2),
                            weight.toFixed(2),
                            (qty * weight).toFixed(2)
                         ];
                    });

                    doc.autoTable({
                        head: tableHead,
                        body: tableBody,
                        startY: tableStartY,
                        theme: 'grid'
                    });

                    const finalY = (doc.autoTable && doc.autoTable.previous) ? doc.autoTable.previous.finalY : tableStartY + 10; 
                    
                    const totalWeight = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.weight) || 0)), 0);
                    const totalValue = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)), 0);
                    const totalQty = safeItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);

                    doc.setFontSize(11);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Total Quantity: ${totalQty} pcs`, 14, finalY + 10);
                    doc.text(`Total Packages: ${totalPackagesEl.value || 'N/A'}`, 14, finalY + 17);
                    doc.text(`Total Net Weight: ${totalWeight.toFixed(2)} kg`, 105, finalY + 10);
                    doc.text(`Total Declared Value: $${totalValue.toFixed(2)} CAD`, 105, finalY + 17);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    // Add extra space before declaration if needed
                    let declarationY = finalY + 30;
                    if (declarationY > (doc.internal.pageSize.height || doc.internal.pageSize.getHeight()) - 20) {
                        doc.addPage();
                        declarationY = 20; // Start near top of new page
                    }
                    doc.text("Declaration: Personal Use – Not for Resale", 14, declarationY);

                    const fileName = `${docType.replace(/ /g, '_')}_${invoiceNumberEl.value || 'Shipment'}.pdf`; 
                    if (action === 'open') {
                        doc.output('dataurlnewwindow'); // Open in new tab for printing
                    } else {
                        doc.save(fileName); // Default: Save file
                    }

                } catch (error) { 
                    console.error("Error generating PDF:", error);
                    alert("Sorry, there was an error generating the PDF. Please ensure all item details are entered correctly and check the console (F12) for more details.");
                }
            }

            function generateExcel() {
                 try { 
                    if (typeof XLSX === 'undefined') {
                         console.error("XLSX (SheetJS) library not loaded correctly.");
                         alert("Error: XLSX library not found. Cannot generate Excel file.");
                         return;
                    }

                    const infoData = [
                        ["Shipment Details", ""],
                        ["Sender Name", senderNameEl.value],
                        ["Receiver Name", receiverNameEl.value],
                        ["Receiver Phone", receiverPhoneEl.value],
                        ["Receiver Address", receiverAddressEl.value],
                        ["", ""],
                        ["Invoice #", invoiceNumberEl.value],
                        ["Date", invoiceDateEl.value],
                        ["Total Packages", totalPackagesEl.value],
                        ["HS Code", hsCodeEl.value]
                    ];
                    const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
                    
                    const itemsHeader = [
                        'Description', 'Quantity', 'Unit Weight (kg)', 'Total Weight (kg)', 'Unit Value (CAD)', 'Total Value (CAD)', 'Remarks'
                    ];
                    // Ensure items is an array before mapping
                     const safeItems = Array.isArray(items) ? items : [];
                     const itemsBody = safeItems.map(item => {
                         const qty = parseFloat(item.qty) || 0;
                         const weight = parseFloat(item.weight) || 0;
                         const value = parseFloat(item.value) || 0;
                         return [
                            item.desc || '',
                            qty,
                            weight,
                            qty * weight,
                            value,
                            qty * value,
                            item.remarks || ''
                         ];
                     });
                    
                    const totalQty = safeItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);
                    const totalWeight = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.weight) || 0)), 0);
                    const totalValue = safeItems.reduce((sum, item) => sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.value) || 0)), 0);
                    
                    const itemsFooter = [
                        'TOTAL', totalQty, '', totalWeight.toFixed(2), '', totalValue.toFixed(2), ''
                    ];
                    
                    const wsItems = XLSX.utils.aoa_to_sheet([itemsHeader, ...itemsBody, [], itemsFooter]);

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsInfo, "Shipment Info");
                    XLSX.utils.book_append_sheet(wb, wsItems, "Packing List");

                    const fileName = `Bee26_Shipment_${invoiceNumberEl.value || ''}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                 } catch (error) { 
                    console.error("Error generating Excel:", error);
                    alert("Sorry, there was an error generating the Excel file. Check the console (F12) for details.");
                 }
            }

            // --- 6. Connect buttons to export/print functions ---
            // Ensure buttons exist before adding listeners
            if (exportPackingListPDF) exportPackingListPDF.addEventListener('click', () => generatePDF('Packing List', 'save')); 
            if (exportInvoicePDF) exportInvoicePDF.addEventListener('click', () => generatePDF('Commercial Invoice', 'save')); 
            
            if (exportPackingListExcel) exportPackingListExcel.addEventListener('click', generateExcel);
            if (exportInvoiceExcel) exportInvoiceExcel.addEventListener('click', generateExcel);
            
            if (printPackingListBtn) printPackingListBtn.addEventListener('click', () => generatePDF('Packing List', 'open')); 
            if (printInvoiceBtn) printInvoiceBtn.addEventListener('click', () => generatePDF('Commercial Invoice', 'open')); 


            // --- 7. Load data when the app starts ---
            loadData();
        });
    </script>

</body>
</html>